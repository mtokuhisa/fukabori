# 深堀くんv2.0 機能追加時のモジュール化設計ガイドライン

## 重要な注意事項
⚠️ **これはリファクタリングルールではありません**
✅ **機能追加時の設計・実装時の注意事項です**

## 1. 基本原則

### 1.1 自動適用ルール
深堀くんv2.0の**今後の機能追加・改良すべて**に適用されるルールです。

### 1.2 適用タイミング
- **新機能の追加時**
- **既存機能の拡張時**
- **バグ修正に伴う機能改善時**

## 2. ファイル分割の判断基準

### 2.1 必須分割条件（1つでも該当すれば分割）
- [ ] **行数が500行を超える場合**
- [ ] **複数の責任を持つ場合**
- [ ] **独立してテスト可能な場合**
- [ ] **他の機能から再利用される場合**

### 2.2 分割前のチェックリスト
- [ ] 既存ファイルの現在の行数を確認
- [ ] 追加予定の機能の責任範囲を明確化
- [ ] 既存モジュールとの依存関係を確認
- [ ] 循環依存の可能性を確認

## 3. 設計原則

### 3.1 単一責任の原則（SRP）
```
原則：1つのモジュールは1つの責任のみを持つ
├── 関連する機能は同じモジュール内に配置
├── 異なる責任は異なるモジュールに分離
└── 責任の境界を明確に定義
```

### 3.2 依存関係の最小化
```
原則：モジュール間の依存関係を最小限に抑制
├── 循環依存を完全に回避
├── 必要な場合のみ依存関係を設定
└── 依存関係の理由を明確化
```

### 3.3 拡張性の確保
```
原則：新機能追加時の既存コードへの影響を最小化
├── インターフェースの一貫性を保持
├── 後方互換性を保証
└── 将来の拡張を考慮した設計
```

## 4. 実装規則

### 4.1 命名規則
```javascript
// ファイル命名規則
[機能名]-[サブ機能名].js

// 例：
voice-recognition-monitor.js    // 音声認識監視
ui-state-controller.js         // UI状態制御
session-continuity-manager.js  // セッション継続管理
```

### 4.2 エクスポート規則
```javascript
// 明確なエクスポート構造
const ModuleName = {
    // 公開メソッド（外部から使用可能）
    publicMethod1() {
        // 実装
    },
    
    publicMethod2() {
        // 実装
    },
    
    // 内部メソッド（_プレフィックス）
    _privateMethod1() {
        // 実装
    },
    
    _privateMethod2() {
        // 実装
    }
};

// グローバルエクスポート
window.ModuleName = ModuleName;
```

### 4.3 ドキュメント化規則
```javascript
/**
 * [モジュール名]
 * 
 * @description [機能の説明]
 * @dependencies [依存関係の一覧]
 * @exports [エクスポート項目の一覧]
 * @version [バージョン]
 * @author [作成者]
 * @date [作成日]
 */
```

## 5. 品質保証

### 5.1 機能追加前のチェック
- [ ] 既存ファイルの行数確認（500行以上なら分割検討）
- [ ] 追加機能の責任範囲明確化
- [ ] 既存モジュールとの依存関係確認
- [ ] 循環依存の可能性確認

### 5.2 機能追加後のチェック
- [ ] モジュール間の依存関係が最小化されているか
- [ ] 各モジュールが単一責任を持っているか
- [ ] 新機能が適切にテスト可能か
- [ ] 既存機能への影響が最小化されているか

## 6. 実装手順

### 6.1 設計フェーズ
1. **機能要件の分析**
   - 追加する機能の責任範囲を明確化
   - 既存システムとの関係性を分析

2. **モジュール設計**
   - 分割の必要性を判断
   - モジュール構成を設計
   - 依存関係を定義

3. **インターフェース設計**
   - 公開メソッドの定義
   - エクスポート項目の決定
   - 外部との連携方法の設計

### 6.2 実装フェーズ
1. **モジュール作成**
   - 命名規則に従ったファイル作成
   - 基本構造の実装
   - ドキュメント化の実施

2. **機能実装**
   - 単一責任の原則を遵守
   - 依存関係を最小化
   - 拡張性を考慮

3. **品質確認**
   - チェックリストの実施
   - 既存機能への影響確認
   - テスト可能性の確認

### 6.3 統合フェーズ
1. **システム統合**
   - 既存システムとの連携
   - インターフェースの整合性確認
   - 後方互換性の確保

2. **動作確認**
   - 機能の動作確認
   - パフォーマンス確認
   - エラー処理の確認

## 7. 違反時の対応

### 7.1 分割不足の場合
- 即座にモジュール分割を実施
- 既存コードの責任範囲を再整理
- 依存関係の見直しを実施

### 7.2 循環依存の場合
- 依存関係の再設計
- 共通モジュールの抽出
- インターフェースの見直し

### 7.3 責任範囲の混在
- 機能の責任範囲を明確化
- 適切なモジュールへの移動
- インターフェースの整理

## 8. 参考資料

### 8.1 詳細設計書
- `docs/VOICE_RECOGNITION_SYSTEM_DESIGN.md`
- 音声認識システムの包括的な設計案

### 8.2 依存関係マップ
- `docs/DEPENDENCY_MAP.md`
- 現在のモジュール間の依存関係

### 8.3 リファクタリング戦略
- `docs/FUKABORI_REFACTORING_STRATEGY.md`
- 既存コードのリファクタリング方針

---

**このガイドラインは、深堀くんv2.0の今後の機能追加・改良すべてに適用される重要なルールです。**
**必ず遵守して、保守性の高いモジュール構成を構築してください。** 