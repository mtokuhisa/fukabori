# 深堀くん開発ガイドライン

**作成日**: 2025年7月26日  
**バージョン**: v0.7.6対応  
**目的**: 深堀くんの開発・保守・拡張における遵守ルール・指針の統一化

---

## 1. 開発時の遵守ルール

### 1.1 絶対遵守ルール（違反時は即座停止）

#### Rule 0: v0.7.6リアルタイム編集機能の成果保持（2025年7月26日更新）
```
✅ 厳守事項:
- 統一状態管理システム（UnifiedStateManager）優先使用
- TranscriptEditManager・EditableTranscriptUIの統合状態保持
- StateUpdateController循環参照防止機構の維持
- 透明継続システムの維持・拡張
- 既存機能完全保護原則の遵守
- 段階的実装（Phase A→B→C）の継続

❌ 絶対禁止:
- 編集機能の単独実装（既存システムとの分離）
- 複数編集システムの併用（2重システム化）
- 状態同期の破綻（AppState不整合）
- 性能劣化（1.46倍を超える負荷）
- VoiceUIManager・forceStopAllActivity関数の復活
```

#### Rule 1: 破壊的変更の絶対禁止
```
❌ 絶対にやってはいけないこと:
- 動作している機能の削除・変更
- 大規模な一括変更
- バックアップ未確認での変更実行
- ユーザー確認なしの機能変更
- テスト未実施での変更実行
```

#### Rule 2: バックアップ確保の絶対原則
```
✅ 変更前に必ず実行:
1. 現在の状態の完全バックアップ作成
2. バックアップからの復元テスト実施
3. 複数世代のバックアップ保持
4. バックアップ場所の明確化・記録
5. ユーザーによるバックアップ確認
```

#### Rule 3: 単一責任制限の厳格実施
```
✅ 変更の最小単位（2025年7月更新）:
- 1回の変更: 1つの責任範囲のみ（行数制限なし）
- 単一機能の完全な処理に限定
- 複数システムの同時変更は絶対禁止
- 影響範囲の事前分析必須
- 各段階での完全動作確認
- 問題発生時の即座巻き戻し準備

✅ 単一責任の定義:
- セッション管理: 開始〜終了の完全な処理
- フェーズ管理: 状態遷移の完全な処理  
- UI管理: 特定UI要素の完全な処理
- データ管理: 特定データの完全なCRUD処理

❌ 複数責任（禁止例）:
- セッション管理 + ファイル処理
- UI変更 + 音声認識変更
```

### 1.2 メンテナンス性確保のルール

#### A. コードの可読性
```
✅ 必須事項:
- 関数名・変数名は目的を明確に表現
- 複雑な処理には必ずコメントを付与
- マジックナンバーは定数化
- 深いネストは関数分割で解決

✅ 推奨事項:
- 関数は50行以内に収める
- 1つの関数は1つの責任のみ
- 依存関係は最小限に抑制
```

#### B. 拡張性の確保
```
✅ 必須設計:
- 新機能追加時の既存コードへの影響を最小化
- 設定値は外部化（config/, app_settings等）
- APIインターフェースは安定化
- モジュール間の結合度は疎結合に

✅ 禁止事項:
- ハードコーディングによる設定埋め込み
- 他モジュールの内部実装に依存
- グローバル変数の乱用
```

---

## 2. モジュール開発指針

### 2.1 ファイル分割の判断基準

#### 必須分割条件（1つでも該当すれば分割）
- [ ] **行数が500行を超える場合**
- [ ] **複数の責任を持つ場合**
- [ ] **独立してテスト可能な場合**
- [ ] **他の機能から再利用される場合**

#### 分割前のチェックリスト
- [ ] 既存ファイルの現在の行数を確認
- [ ] 追加予定の機能の責任範囲を明確化
- [ ] 既存モジュールとの依存関係を確認
- [ ] 循環依存の可能性を確認

### 2.2 設計原則

#### 単一責任の原則（SRP）
```
原則：1つのモジュールは1つの責任のみを持つ
├── 関連する機能は同じモジュール内に配置
├── 異なる責任は異なるモジュールに分離
└── 責任の境界を明確に定義
```

#### 依存関係の最小化
```
原則：モジュール間の依存関係を最小限に抑制
├── 循環依存を完全に回避
├── 必要な場合のみ依存関係を設定
└── 依存関係の理由を明確化
```

#### 拡張性の確保
```
原則：将来の機能追加を考慮した設計
├── インターフェースの安定化
├── 設定の外部化
└── プラグイン機構の活用
```

### 2.3 モジュール命名規則

#### ファイル命名
```
音声関連: voice-*.js
UI関連: ui-*.js
編集関連: *-edit-*.js, editable-*.js (v0.7.6追加)
セッション関連: session-*.js
データ関連: data-*.js, storage-*.js
知見関連: knowledge-*.js
状態管理: *-state-*.js (v0.7.6追加)
```

#### クラス・関数命名
```
クラス: PascalCase (VoiceManager)
関数: camelCase (initializeVoice)
定数: UPPER_SNAKE_CASE (MAX_RETRY_COUNT)
```

---

## 3. リファクタリング時の注意事項

### 3.1 リファクタリングの基本原則

#### 完全保持の原則
```
✅ 絶対に保持すべき要素:
- 既存の全機能
- ユーザーインターフェース
- データ形式・構造
- 外部API仕様
- パフォーマンス水準
```

#### 段階的実施の原則
```
✅ 実施手順:
1. 現状の完全分析・理解
2. 目標設計の詳細化
3. 最小単位での段階的実施
4. 各段階での完全動作確認
5. 問題発生時の即座巻き戻し
```

### 3.2 リファクタリング時の禁止事項

#### 一括変更の禁止
```
❌ 禁止行為:
- 複数ファイルの同時変更
- 機能追加とリファクタリングの同時実行
- バックアップなしの変更実行
- テスト未実施の変更実行
```

#### 場当たり的修正の禁止
```
❌ 禁止行為:
- 動作しないコードの場当たり的修正
- 既存動作コードを参考にしない新規作成
- 設計方針なしの修正
- 影響範囲未分析の修正
```

### 3.3 安全なリファクタリング手順

#### Step 1: 準備
```
1. 現状の完全バックアップ作成
2. 動作テストの実施・結果記録
3. 依存関係の完全分析
4. 影響範囲の特定
5. 段階的実施計画の作成
```

#### Step 2: 実施
```
1. 最小単位での変更実施
2. 各段階での動作確認
3. 問題発生時の即座巻き戻し
4. 成功時の中間バックアップ作成
5. 次段階への継続判断
```

#### Step 3: 検証
```
1. 全機能の動作確認
2. パフォーマンス測定
3. 回帰テストの実施
4. ユーザーテストの実施
5. 最終バックアップの作成
```

---

## 4. テスト戦略・品質保証

### 4.1 テスト実行階層

#### Tier 1: 完全UI化（推奨）
```
✅ 特徴:
- UIでテスト実行・結果表示
- ワンクリック実行
- 結果の自動整形・コピー機能
- 非技術者でも使用可能
```

#### Tier 2: 部分UI化 + 簡単指示
```
✅ 特徴:
- 基本的なUIと簡単な手順
- 最小限の技術知識で実行可能
- 明確な手順書付き
```

#### Tier 3: コンソール操作（最小限）
```
⚠️ 特徴:
- 技術的な知識が必要
- 最小限の使用に留める
- 詳細な手順書必須
```

### 4.2 継続的音声認識テストシステム

#### 実装機能
```
✅ テストダッシュボード:
- セッション状態のリアルタイム表示
- テスト実行ボタン
- 進捗表示
- 結果表示（品質グレード・統計情報）

✅ 結果レポート機能:
- 統計情報（start()回数、効率性、継続性）
- 品質評価（A+～D自動グレード）
- アラート表示（問題点の詳細）
- 推奨事項（次のアクションの提案）

✅ レポート出力機能:
- コピーボタン（テスト結果の一括コピー）
- フォーマット済み（報告用の整形済みテキスト）
- タイムスタンプ（実行時刻の記録）
- 詳細ログ（技術的詳細も含む）
```

### 4.3 品質保証チェックリスト

#### 機能テスト
- [ ] 全機能の正常動作確認
- [ ] エラーハンドリングの動作確認
- [ ] 境界値テストの実施
- [ ] 負荷テストの実施

#### UI/UXテスト
- [ ] レスポンシブデザインの確認
- [ ] アクセシビリティの確認
- [ ] ユーザビリティテストの実施
- [ ] ブラウザ互換性の確認

#### 音声認識テスト
- [ ] 継続的音声認識の動作確認
- [ ] エラー回復機能の確認
- [ ] 音声品質の確認
- [ ] 長時間動作の確認

#### リアルタイム編集機能テスト（v0.7.6追加）
- [ ] 編集開始・完了の正常動作確認
- [ ] contenteditable機能の動作確認
- [ ] キーボード操作（ESC, Shift+Enter）の確認
- [ ] 音声認識一時停止連携の確認
- [ ] AppState同期の正常性確認
- [ ] 性能負荷測定（1.46倍以内）
- [ ] 既存機能への影響確認

---

## 5. ブラウザテスト手順

### 5.1 基本テスト環境
```
✅ 推奨環境:
- ローカルサーバー: Python http.server (port 8000)
- ブラウザ: Chrome, Safari, Firefox
- デバイス: デスクトップ, タブレット, スマートフォン
```

### 5.2 テスト前の準備
```
1. ローカルサーバーの起動確認
2. 必要なAPIキーの設定確認
3. テストデータの準備
4. バックアップの確認
```

### 5.3 段階的テスト手順

#### Phase 1: 基本動作確認
```
1. アプリケーションの起動確認
2. 基本UI操作の確認
3. 音声認識の基本動作確認
4. エラーハンドリングの確認
```

#### Phase 2: 統合テスト
```
1. セッション全体の動作確認
2. データ永続化の確認
3. 長時間動作の確認
4. 異常系の処理確認
```

#### Phase 3: 品質確認
```
1. パフォーマンス測定
2. メモリリークの確認
3. ユーザビリティ確認
4. 回帰テストの実施
```

---

## 6. コードレビュー基準

### 6.1 必須レビュー項目

#### 機能性
- [ ] 要件を満たしているか
- [ ] エラーハンドリングは適切か
- [ ] 境界値処理は正しいか
- [ ] パフォーマンスは acceptable か

#### 保守性
- [ ] コードは読みやすいか
- [ ] 適切にコメントが付いているか
- [ ] 命名規則に従っているか
- [ ] 複雑さは適切か

#### 拡張性
- [ ] 将来の変更に対応しやすいか
- [ ] モジュール間の結合度は適切か
- [ ] 設定の外部化は適切か
- [ ] テストしやすい構造か

### 6.2 レビュー時の注意事項

#### 建設的フィードバック
```
✅ 良いレビュー:
- 具体的な改善提案
- 代替案の提示
- 理由の明確化
- 肯定的な表現

❌ 避けるべきレビュー:
- 単なる批判
- 理由のない否定
- 個人攻撃
- 曖昧な指摘
```

---

## 7. 緊急対応プロセス

### 7.1 緊急度分類

#### 緊急度 A: 即座対応
```
対象：
- アプリケーションの完全停止
- データ消失の危険
- セキュリティ脆弱性
- ユーザーに重大な影響
```

#### 緊急度 B: 24時間以内
```
対象：
- 機能の一部停止
- パフォーマンスの大幅低下
- UI/UXの重大な問題
- データの不整合
```

#### 緊急度 C: 1週間以内
```
対象：
- 軽微な機能障害
- UI/UXの改善要求
- パフォーマンスの軽微な低下
- 機能追加要求
```

### 7.2 緊急対応手順

#### Step 1: 影響範囲の特定
```
1. 問題の詳細確認
2. 影響するユーザー・機能の特定
3. 原因の初期分析
4. 対応優先度の決定
```

#### Step 2: 一時対応
```
1. 被害拡大の防止
2. ユーザーへの影響最小化
3. 暫定対応の実施
4. 状況の継続監視
```

#### Step 3: 根本対応
```
1. 根本原因の特定
2. 恒久対応の設計
3. テスト環境での検証
4. 本番環境への適用
```

#### Step 4: 再発防止
```
1. 原因分析の深堀り
2. 再発防止策の策定
3. 監視体制の強化
4. 手順・ドキュメントの更新
```

---

## 8. 文書管理・更新ルール

### 8.1 文書更新の原則

#### 同期更新の原則
```
✅ 必須事項:
- コード変更時は文書も同時更新
- 仕様変更時は設計書も同時更新
- バージョンアップ時は履歴も同時更新
- テスト実施時は結果も同時記録
```

#### 一元管理の原則
```
✅ 管理方針:
- docs/フォルダでの統一管理
- 重複情報の排除
- 最新情報の一箇所集約
- 古い情報のarchive化
```

### 8.2 文書品質基準

#### 完全性
- [ ] 必要な情報がすべて含まれているか
- [ ] 最新の状態を反映しているか
- [ ] 参照先の情報は正確か
- [ ] 例外・制約事項も記載されているか

#### 明確性
- [ ] 技術者以外でも理解できるか
- [ ] 手順は具体的で実行可能か
- [ ] 図表・コード例は適切か
- [ ] 専門用語の説明は十分か

#### 保守性
- [ ] 更新が容易な構造になっているか
- [ ] 変更履歴が追跡できるか
- [ ] 責任者・連絡先が明確か
- [ ] 関連文書との整合性は保たれているか

---

**最終更新**: 2025年7月26日  
**文書バージョン**: v1.2 (v0.7.6リアルタイム編集機能対応) 