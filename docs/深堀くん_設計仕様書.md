# 深堀くん v2.0 設計仕様書

**作成日**: 2025年7月26日  
**バージョン**: v0.7.6対応  
**目的**: 深堀くんの設計思想、アーキテクチャ、UI/UX仕様の完全記録

---

## 1. アプリケーション概要・目的

### 1.1 基本コンセプト
深堀くんは、**「ねほりーの」「はほりーの」**の2人のAIキャラクターが、ユーザーとの音声会話を通じて知見を深掘りし、抽出・整理するPWAアプリケーションです。

### 1.2 核心的価値
- **音声のみでの会話実現**: 「会話に集中できる」重要原則
- **リアルタイム編集**: 文字起こし内容の即座修正・精度向上（v0.7.6追加）
- **知見の深掘り**: 表面的な情報ではなく、深い洞察の抽出
- **継続的な学習**: セッションを重ねることで知識が蓄積

### 1.3 ターゲット
- 企業内での知見共有・ナレッジマネジメント
- 個人の経験・知識の体系化
- 専門知識の構造化・可視化

---

## 2. 設計思想・理念

### 2.1 基本原則
1. **ユーザー中心設計**: 企業セッションでの実用性を最優先
2. **シンプル操作**: 必要最小限の操作で最大の効果
3. **モバイルフレンドリー**: 様々なデバイスでの使いやすさ
4. **視覚的フィードバック**: 状態を色とテキストで明確に表示

### 2.2 音声認識設計思想
- **「マイク許可アラート防止」**: 一回のみの許可で継続動作
- **「無音時間監視」廃止**: 0-180秒の考慮時間は監視対象外
- **「音声認識システム稼働状態監視」**: 10秒間隔でのSpeechRecognitionオブジェクト実態監視
- **「継続的音声認識」**: 1回のstart()で絶対に停止しない設計

### 2.3 UI設計哲学
- **状態の可視化**: 現在の状況を常に明確に表示
- **操作の一貫性**: 同じ操作には同じ結果を保証
- **エラーの透明性**: 問題発生時は具体的な内容を表示

### 2.4 リアルタイム編集設計思想（v0.7.6追加）
- **既存機能完全保護**: 音声認識システムとの統合・共存
- **性能優先**: リアルタイム音声認識性能への影響最小化（1.46倍以内）
- **段階的実装**: Phase A（基本編集）→ Phase B（一時停止統合）→ Phase C（キーボード会話）
- **緊急無効化対応**: 単一設定での完全無効化機能
- **状態同期保証**: AppState・transcriptHistoryとの完全同期

---

## 3. システム全体アーキテクチャ

### 3.1 4層アーキテクチャ
```
┌─────────────────────────────────────────┐
│ Interface Layer (UI/UX)                 │
│ - UI Manager, Event Handler, Bootstrap  │
├─────────────────────────────────────────┤
│ Feature Layer (機能)                     │
│ - Session Manager, Voice Manager        │
├─────────────────────────────────────────┤
│ Service Layer (サービス)                 │
│ - AI Manager, File Processing           │
├─────────────────────────────────────────┤
│ Core Layer (コア)                       │
│ - Utils, Storage, Knowledge System      │
└─────────────────────────────────────────┘
```

### 3.2 主要コンポーネント

#### 3.2.1 音声認識システム
- **ContinuousRecognitionManager**: 継続的音声認識の統合管理
- **VoiceErrorHandler**: 専用エラーハンドラー（146行）
- **VoiceUIManager**: UI管理システム（211行）
- **VoicePhase2Manager**: 音声認識フェーズ2管理

#### 3.2.2 リアルタイム編集システム（v0.7.6追加）
- **TranscriptEditManager**: リアルタイム文字起こし編集制御（759行）
- **EditableTranscriptUI**: 編集可能UI制御（588行）
- **StateUpdateController**: 状態更新制御・循環参照防止

#### 3.2.3 UI管理システム
- **UIBasic**: 基本UI操作（2,459行 CSS統合）
- **UIManager**: レスポンシブデザイン管理
- **UIScreens**: 画面遷移管理

#### 3.2.4 データ管理
- **KnowledgeSystem**: 知見管理システム
- **SessionManager**: セッション状態管理
- **DataManager**: データ永続化管理

---

## 4. 音声認識システム設計

### 4.1 設計方針の根本変更
- **❌ 旧方式**: 無音時間監視（45秒）
- **✅ 新方式**: 音声認識システム稼働状態監視（10秒間隔）

### 4.2 継続的音声認識戦略
```javascript
// 基本戦略
MICROPHONE_STRATEGY.CONTINUOUS
- 1回のstart()で絶対に停止しない
- no-speech後の不正終了防止
- エラー回復時の自動再開
```

### 4.3 エラーハンドリング体系
```javascript
// エラー種別対応
'aborted' → '音声認識が予期せず停止しました'
'network' → 'ネットワーク接続を確認してください'
'audio-capture' → 'マイクへのアクセスに問題があります'
'not-allowed' → 'マイクの使用許可が必要です'
'no-speech' → 正常動作として扱う（ignoreNextEndフラグ）
```

### 4.4 状態管理
```javascript
// 6つの音声認識状態
'idle' → '音声認識準備完了'
'starting' → '音声認識を開始中...'
'active' → '音声認識中 - クリックで一時停止'
'stopping' → '音声認識一時停止中 - クリックで再開'
'error' → '音声認識エラー - クリックで再開'
'network-error' → 'ネットワークエラー - 自動再開試行中'
```

---

## 5. UI/UX設計指針

### 5.1 レイアウト構成
```
┌─────────────────────────────────────────┐
│ 左パネル (300px)                         │
│ - ロゴ・設定                             │
├─────────────────────────────────────────┤
│ 中央パネル (flex: 1)                     │
│ - テーマ表示                             │
│ - 会話エリア                             │
│ - リアルタイム文字起こし                   │
│ - 音声コントロール                       │
├─────────────────────────────────────────┤
│ 右パネル (300px)                         │
│ - キャラクター状態                       │
│ - 知見表示                               │
│ - セッション情報                         │
└─────────────────────────────────────────┘
```

### 5.2 UI修正時の重要な注意事項

#### 5.2.1 リアルタイム文字起こし表示位置の教訓
**⚠️ 重要**: リアルタイム文字起こし表示位置は過去に長期間の問題となった

**問題の経緯**:
- transcript-compact（200px-400px）とtranscript-display（120px-300px）の競合
- 2つのシステムの共存による相互干渉・相互失敗
- 50回以上の修正サイクルを経て解決

**解決策**:
1. **完全統一**: transcript-compactを完全削除、transcript-displayのみに統一
2. **適切な配置**: 会話エリアとは分離し、中央ペイン内の適切な位置に配置
3. **明確な区切り**: 3px solidの区切り線で視覚的分離

**今後の遵守事項**:
- 文字起こし表示は絶対に2重システムにしない
- 配置変更時は他要素との競合を徹底確認
- fixed positionの使用は最小限に抑制

#### 5.2.2 吹き出し配置の統一性
**教訓**: AIキャラクターとユーザーの吹き出しは同じパディングで統一

**実装**:
```css
.message.nehori, .message.hahori {
    margin-left: 10px; /* ユーザーメッセージと同じ量 */
}
```

#### 5.2.3 ボタン配置の操作性向上
**教訓**: 一時停止と終了ボタンは誤操作防止のため十分な間隔を確保

**実装**:
```css
.voice-controls-buttons {
    gap: 20px; /* 10px → 20px (2倍に拡大) */
}
```

### 5.3 リアルタイム編集UI仕様（v0.7.6追加）

#### 編集状態の視覚フィードバック
```css
/* 編集状態スタイル */
.transcript-display[contenteditable="true"] {
    border: 2px solid #3498db;
    background-color: rgba(52, 152, 219, 0.1);
    outline: none;
    cursor: text;
}

/* 非編集状態（通常） */
.transcript-display {
    border: 4px solid #3498db;
    background-color: rgba(255, 255, 255, 0.4);
    cursor: pointer;
}
```

#### キーボード操作仕様
```
ESC: 編集キャンセル（元の内容に復元）
Shift+Enter: 編集完了（新しい内容で確定）
クリック: 編集開始（contenteditable有効化）
```

#### 性能考慮事項
- contenteditable使用による負荷: 1.46倍（LOW RISK）
- DOM更新頻度の最適化
- 状態同期処理の非同期化

### 5.4 レスポンシブデザイン原則
```css
/* デスクトップ優先 */
@media (max-width: 768px) {
    /* モバイル調整 */
    .voice-controls-buttons { gap: 15px; }
    .realtime-transcript-area { margin: 3px 0; }
}
```

---

## 6. 新デザイン要件・仕様

### 6.1 中央下部統合コントロール
- **マイク状態表示**: アイコンサイズ適度、色で判別重視
- **状態テキスト**: マイク横に常時表示
- **背景色**: マイク色と連動させない（視覚的ノイズ回避）
- **操作ボタン**: 一時停止/再開（トグル）、セッション終了

### 6.2 右パネル背景変化
```javascript
// キャラクター状態による背景変化
nehori-speaking: 紫系グラデーション
hahori-speaking: 青系グラデーション
default: 通常背景
```

### 6.3 視覚的フィードバック体系
```javascript
// マイク状態表示
Gray + 'starting': '認識を開始中...'
Green + 'active': '認識中'
Yellow + 'stopping': '認識を一時停止中 - →で再開'
Red + 'error': '認識エラー - 自動再開試行中'
Red + 'network-error': 'エラー - 自動再開試行中'
Red + 'permission-denied': 'マイクの許可が必要です'
```

---

## 7. PWA対応・モバイル仕様

### 7.1 PWA基本設定
```javascript
// manifest.json
{
    "name": "深堀くん",
    "short_name": "深堀くん",
    "theme_color": "#2196F3",
    "background_color": "#ffffff",
    "display": "standalone",
    "start_url": "/深堀くん.html"
}
```

### 7.2 Service Worker
- **キャッシュ戦略**: ネットワーク優先、フォールバック対応
- **更新通知**: 新バージョン利用可能時の通知
- **オフライン対応**: 基本機能のオフライン動作

### 7.3 モバイル最適化
- **タッチ操作**: 十分なタッチターゲットサイズ
- **音声認識**: モバイル環境での音声認識安定性
- **バッテリー考慮**: 長時間使用時のバッテリー消費最適化

---

## 8. 技術仕様詳細

### 8.1 ファイル構成
```
app/
├── script.js (7,651行) - メインロジック
├── style.css (2,459行) - 統合スタイル
├── transcript-edit-manager.js (759行) - リアルタイム文字起こし編集制御（v0.7.6追加）
├── editable-transcript-ui.js (588行) - 編集可能UI制御（v0.7.6追加）
├── ui-basic.js - 基本UI操作
├── voice-*.js - 音声認識関連モジュール
├── session-*.js - セッション管理
├── knowledge-*.js - 知見管理
└── unified-state-manager/ - 統合状態管理
```

### 8.2 依存関係
- **外部API**: OpenAI GPT-4, TTS API
- **ブラウザAPI**: Web Speech API, Local Storage
- **PWA**: Service Worker, Web App Manifest

### 8.3 パフォーマンス要件
- **音声認識レスポンス**: 1秒以内
- **UI更新**: 16ms以内（60fps）
- **メモリ使用量**: 50MB以下
- **バンドルサイズ**: 1MB以下

---

## 9. 品質保証・テスト

### 9.1 テスト環境
- **ローカルサーバー**: Python http.server (port 8000)
- **ブラウザ**: Chrome, Safari, Firefox
- **デバイス**: デスクトップ, タブレット, スマートフォン

### 9.2 テスト項目
- **音声認識**: 継続性、エラー回復、状態表示
- **UI操作**: レスポンシブ、タッチ操作、キーボード操作
- **セッション管理**: 開始、終了、復旧
- **データ永続化**: 保存、読み込み、バックアップ

---

## 10. 今後の拡張性・メンテナンス

### 10.1 拡張予定機能
- **多言語対応**: 英語、中国語サポート
- **チーム機能**: 複数ユーザーでの知見共有
- **AI強化**: より高度な知見抽出AI
- **統計分析**: 知見の定量分析機能

### 10.2 メンテナンス方針
- **定期更新**: 月1回のセキュリティ更新
- **パフォーマンス監視**: 継続的な性能測定
- **ユーザーフィードバック**: 改善要望の収集・反映

---

**最終更新**: 2025年7月26日  
**文書バージョン**: v1.2 (v0.7.6リアルタイム編集機能対応) 