# 深堀くん技術仕様・依存関係

**作成日**: 2025年7月22日  
**バージョン**: v0.7.5対応  
**目的**: 深堀くんの技術仕様、依存関係、音声認識システムの設計思想・遵守事項の完全記録

---

## 1. 依存関係完全マップ

### 1.1 ファイル構成と読み込み順序

#### HTMLファイル読み込み順序（深堀くん.html）
```html
1. app/utils.js                  - ユーティリティ関数
2. app/voice-core.js             - 音声システム基盤
3. app/ui-manager.js             - UI管理システム
4. app/ui-screens.js             - 画面遷移管理
5. app/ui-basic.js               - 基本UI操作
6. app/ui-advanced.js            - 高度UI機能
7. app/storage-manager.js        - ストレージ管理
8. app/file-processing.js        - ファイル処理システム
9. app/knowledge-system.js       - 知見管理システム
10. app/session-controller.js    - セッション制御
11. app/data-manager.js          - データ管理
12. app/file-manager.js          - ファイル管理
13. app/ai-manager.js            - AI統合管理
14. app/knowledge-file-manager-interface.js - 知見ファイル管理
15. app/api-key-setup.js         - APIキー設定
16. app/session-manager.js       - セッション管理
17. app/phase-manager.js         - フェーズ管理
18. app/session-start-manager.js - セッション開始管理
19. app/voice-phase2-manager.js  - 音声フェーズ2管理
20. app/voice-error-handler.js   - 音声エラーハンドラー
21. app/voice-processing-manager.js - 音声処理管理（削除コマンド処理）
22. app/unified-state-manager/voice-module.js - 統合状態管理
23. app/script.js                - メインスクリプト
```

#### 統合状態管理モジュール
```
app/unified-state-manager/
├── core.js           - 統合状態管理コア
├── ui-module.js      - UI状態管理
├── voice-module.js   - 音声状態管理
└── styles.css        - 統合状態管理スタイル
```

### 1.2 グローバル変数・オブジェクト

#### 主要グローバル変数
```javascript
// 状態管理
window.KnowledgeState     - 知見状態管理（knowledge-system.js）
window.AppState           - アプリケーション状態（script.js）
window.stateManager       - 状態管理システム（script.js）

// 音声システム
window.ContinuousRecognitionManager - 継続的音声認識管理
window.VoiceErrorHandler  - 音声エラーハンドラー
window.VoiceProcessingManager - 音声処理管理（削除コマンド処理）
window.unifiedStateManager - 統一状態管理システム（v0.7.5で統合）

// UI管理
window.UIManager          - UI管理システム
window.UIScreens          - 画面遷移管理
window.UIBasic            - 基本UI操作

// データ管理
window.DataManager        - データ管理
window.StorageManager     - ストレージ管理
window.FileManager        - ファイル管理
```

### 1.3 モジュール依存関係

#### 音声認識システム（v0.7.5緊急修復プロジェクト対応）
```
UnifiedStateManager（統一状態管理システム）
├── depends on: VoiceModule, UIModule, Core
├── provides: 統合状態管理、透明継続システム、一時停止ボタン制御
└── modules: voice-module.js, ui-module.js, core.js

VoiceModule（統一状態管理の音声モジュール）
├── depends on: SpeechRecognition API
├── provides: 透明継続システム、forceRestartRecognition、no-speech対応
└── functions: pauseRecognition(), resumeRecognition(), handleEnd()

VoiceErrorHandler
├── depends on: なし（独立モジュール）
├── provides: 専用エラーハンドリング、no-speech対策
└── functions: handleNoSpeechError(), shouldIgnoreEndEvent()

VoiceProcessingManager
├── depends on: VoiceModule, 音声コマンド処理
├── provides: 削除コマンド処理、単一処理パス
└── functions: handleNumberDelete(), executeFullClear()
```

#### データ管理システム
```
KnowledgeSystem
├── depends on: AppState, DataManager
├── provides: 知見CRUD、セッション管理
└── functions: 知見追加、編集、削除、検索

SessionManager
├── depends on: AppState, DataManager
├── provides: セッション開始、終了、状態管理
└── functions: セッション制御、フェーズ管理

DataManager
├── depends on: StorageManager
├── provides: データ永続化、キャッシュ管理
└── functions: データ保存、読み込み、同期
```

---

## 2. モジュール機能一覧

### 2.1 音声認識関連モジュール

#### ContinuousRecognitionManager（継続的音声認識管理）
```javascript
// 責任範囲
- 音声認識の開始・停止・再開制御
- 継続的動作の保証（1回のstart()で無限継続）
- エラー発生時の自動回復
- 音声認識状態の統合管理

// 重要メソッド
initializeExtendedFeatures() - 拡張機能初期化
startContinuousRecognition() - 継続的音声認識開始
pauseRecognition()          - 一時停止
resumeRecognition()         - 再開
```

#### VoiceErrorHandler（音声エラーハンドラー）
```javascript
// 責任範囲
- 音声認識エラーの専用処理
- no-speech後の不正終了防止
- エラー種別に応じた適切な対応
- 統計情報の管理

// 重要メソッド
handleNoSpeechError()    - no-speechエラーの正常処理
shouldIgnoreEndEvent()   - ignoreNextEndフラグ制御
handleError()           - 統合エラーハンドリング
```

#### VoiceUIManager（音声UI管理）
```javascript
// 責任範囲
- 音声認識状態のビジュアル表示
- マイクボタンの状態管理
- エラーメッセージの表示
- 状態別色変更・アイコン制御

// 重要メソッド
updateVoiceState()      - 音声状態の更新
showStateMessage()      - 状態メッセージ表示
updateMicrophoneIcon()  - マイクアイコン更新
```

### 2.2 UI管理関連モジュール

#### UIManager（UI管理システム）
```javascript
// 責任範囲
- レスポンシブデザイン管理
- テーマ管理
- コンポーネントシステム
- UI状態の統合管理

// 重要メソッド
initializeUI()          - UI初期化
updateTheme()           - テーマ変更
handleResize()          - レスポンシブ対応
```

#### UIBasic（基本UI操作）
```javascript
// 責任範囲
- 基本的なDOM操作
- 画面要素の表示・非表示
- イベントハンドリング
- フォーム操作

// 重要メソッド
showElement()           - 要素表示
hideElement()           - 要素非表示
updateContent()         - コンテンツ更新
```

### 2.3 データ管理関連モジュール

#### KnowledgeSystem（知見管理システム）
```javascript
// 責任範囲
- 知見の追加・編集・削除
- 知見の検索・フィルタリング
- セッション知見の管理
- 知見の可視化

// 重要メソッド
addKnowledge()          - 知見追加
editKnowledge()         - 知見編集
deleteKnowledge()       - 知見削除
searchKnowledge()       - 知見検索
```

#### SessionManager（セッション管理）
```javascript
// 責任範囲
- セッションの開始・終了
- フェーズ管理
- セッション状態の保持
- セッション履歴の管理

// 重要メソッド
startSession()          - セッション開始
endSession()            - セッション終了
updatePhase()           - フェーズ更新
```

---

## 3. 音声認識システム設計思想・遵守事項

### 3.1 設計思想の根本原則

#### 「音声のみでの会話実現」の原則
```
✅ 核心理念:
- ユーザーは音声のみで完結したい
- 「会話に集中できる」ことが最重要
- 技術的な操作は最小限に抑制
- 自然な会話フローを絶対に妨げない

❌ 避けるべき設計:
- 頻繁なマイク許可要求
- 予期しない音声認識停止
- 複雑な操作手順
- 技術的な問題のユーザー転嫁
```

#### 「継続的動作」の原則
```
✅ 設計目標:
- 1回のstart()で無限に継続
- no-speech後も継続動作
- エラー発生時の自動回復
- ユーザー介入なしでの問題解決

❌ 禁止事項:
- 無音時間での自動停止
- エラー時の手動再開要求
- 複数回のstart()呼び出し
- マイク許可の重複要求
```

### 3.2 透明継続システム（方式A）の設計思想（v0.7.5新機能）

#### 30秒無音制限の完全克服
```javascript
// v0.7.5で実装された透明継続システム
設計原則:
- ブラウザのSpeechRecognition API 30秒制限を透明化
- ユーザーに認知させずに自動継続
- 「無音は正常」思想の実現
- 手動復旧不要の完全自動化

// 実装方針（voice-module.js）
handleEnd() {
    if (this.shouldContinueTransparently()) {
        console.log('🔄 透明継続実行');
        setTimeout(() => {
            this.performTransparentContinuation();
        }, 500);
        return;
    }
    // 通常の終了処理
}
```

### 3.3 no-speech対策の設計思想

#### no-speechは正常動作
```javascript
// 設計思想
深堀アプリの特性:
- ユーザーは0-180秒の考慮時間を必要とする
- no-speechは「考えている時間」として正常
- 従来の音声認識の「無音=終了」概念は不適用
- 継続的な待機状態の維持が必要

// v0.7.5実装方針（透明継続システム統合）
shouldContinueTransparently() {
    // no-speechエラーも透明継続の対象
    if (this.state.recognitionState === 'error' && 
        this.state.lastError && 
        this.state.lastError.includes('no-speech')) {
        return true;
    }
    return false;
}
```

#### forceRestartRecognition()による完全リセット（v0.7.5新機能）
```javascript
// v0.7.5透明継続システムでの解決策
forceRestartRecognition() {
    // 既存インスタンスの完全クリーンアップ
    if (this.recognition) {
        this.recognition.stop();
        this.recognition = null;
    }
    
    // 新しいSpeechRecognitionインスタンス作成
    this.recognition = new (window.SpeechRecognition || 
                           window.webkitSpeechRecognition)();
    
    // イベントハンドラーの再設定
    this.setupEventHandlers();
    
    // 即座に開始
    this.recognition.start();
}
```

### 3.4 音声認識状態管理の設計思想

#### 6つの音声認識状態
```javascript
// 状態設計の思想
'idle'      - 音声認識準備完了（初期状態）
'starting'  - 音声認識を開始中...（一時的状態）
'active'    - 音声認識中（通常動作状態）
'stopping'  - 音声認識一時停止中（一時的状態）
'error'     - 音声認識エラー（回復可能状態）
'network-error' - ネットワークエラー（回復試行状態）

// 状態遷移の原則
1. 状態は常に明確に定義される
2. 各状態でのユーザー操作を明示
3. 自動回復可能な状態は自動処理
4. 手動介入が必要な状態は明確に通知
```

#### 状態表示の設計思想
```javascript
// ビジュアルフィードバック原則
Gray + 'starting'      - 開始処理中を表現
Green + 'active'       - 正常動作を表現
Yellow + 'stopping'    - 一時停止を表現
Red + 'error'          - 問題発生を表現
Red + 'network-error'  - ネットワーク問題を表現
Red + 'permission-denied' - 許可問題を表現

// メッセージ設計原則
1. 現在の状態を明確に表現
2. 次に取るべき行動を明示
3. 技術的詳細は隠蔽
4. ユーザーフレンドリーな言葉遣い
```

### 3.5 エラーハンドリングの設計思想

#### エラー種別対応の原則
```javascript
// エラー分類と対応方針
'aborted'       - 音声認識システムの予期しない停止
'network'       - ネットワーク接続問題
'audio-capture' - マイクアクセス問題
'not-allowed'   - マイク許可問題
'no-speech'     - 無音状態（正常処理）

// 対応方針
自動回復可能  - 'aborted', 'network', 'no-speech'
手動介入必要  - 'not-allowed', 'audio-capture'
状況次第     - その他のエラー
```

#### 統合エラーハンドリング
```javascript
// 統合処理の原則
1. エラー種別の正確な判定
2. 適切な回復処理の実行
3. ユーザーへの明確な通知
4. 統計情報の正確な記録
5. 必要に応じた継続性監視の停止

// 実装例
handleError(error) {
    switch(error.error) {
        case 'no-speech':
            return this.handleNoSpeechError();
        case 'aborted':
            return this.handleAbortedError();
        case 'network':
            return this.handleNetworkError();
        // 他のエラーハンドリング
    }
}
```

---

## 4. API仕様・インターフェース

### 4.1 音声認識API仕様

#### ContinuousRecognitionManager API
```javascript
// 初期化
const manager = new ContinuousRecognitionManager();
manager.initializeExtendedFeatures();

// 基本操作
await manager.startContinuousRecognition();
manager.pauseRecognition();
manager.resumeRecognition();
manager.stopRecognition();

// 状態取得
const state = manager.getCurrentState();
const stats = manager.getStatistics();
const isActive = manager.isRecognitionActive();

// イベントハンドラー
manager.onStateChange = (newState) => { /* 処理 */ };
manager.onResult = (result) => { /* 処理 */ };
manager.onError = (error) => { /* 処理 */ };
```

#### VoiceErrorHandler API
```javascript
// エラーハンドリング
const handler = new VoiceErrorHandler();
handler.handleError(error);
handler.handleNoSpeechError();

// 状態管理
const shouldIgnore = handler.shouldIgnoreEndEvent();
handler.resetStatistics();

// 統計情報
const stats = handler.getErrorStatistics();
```

### 4.2 UI管理API仕様

#### UIManager API
```javascript
// 初期化
const ui = new UIManager();
ui.initialize();

// テーマ管理
ui.setTheme('dark');
ui.getCurrentTheme();

// レスポンシブ対応
ui.handleResize();
ui.updateLayout();

// 状態管理
ui.updateState(newState);
ui.showNotification(message, type);
```

#### VoiceUIManager API
```javascript
// 状態表示
const voiceUI = new VoiceUIManager();
voiceUI.updateVoiceState(state);
voiceUI.showStateMessage(message);

// ビジュアル更新
voiceUI.updateMicrophoneIcon(state);
voiceUI.updateStateColor(color);

// エラー表示
voiceUI.showErrorMessage(error);
voiceUI.clearErrorMessage();
```

### 4.3 データ管理API仕様

#### KnowledgeSystem API
```javascript
// 知見管理
const knowledge = new KnowledgeSystem();
knowledge.addKnowledge(data);
knowledge.editKnowledge(id, data);
knowledge.deleteKnowledge(id);

// 検索・フィルタリング
const results = knowledge.searchKnowledge(query);
const filtered = knowledge.filterKnowledge(criteria);

// セッション管理
knowledge.startSession();
knowledge.endSession();
knowledge.saveSession();
```

#### SessionManager API
```javascript
// セッション制御
const session = new SessionManager();
session.startSession(config);
session.endSession();
session.pauseSession();
session.resumeSession();

// フェーズ管理
session.updatePhase(phase);
session.getCurrentPhase();
session.getPhaseHistory();

// 状態管理
session.getSessionState();
session.updateSessionState(state);
```

---

## 5. パフォーマンス要件・最適化

### 5.1 パフォーマンス要件

#### 応答時間要件
```
音声認識開始      - 1秒以内
音声認識結果処理   - 500ms以内
UI状態更新        - 16ms以内（60fps）
エラー回復処理     - 3秒以内
セッション開始     - 2秒以内
データ保存処理     - 1秒以内
```

#### リソース使用量要件
```
メモリ使用量      - 50MB以下
CPU使用率        - 30%以下（平常時）
バンドルサイズ     - 1MB以下
ネットワーク帯域   - 1Mbps以下
```

### 5.2 最適化戦略

#### 音声認識最適化
```javascript
// 継続的音声認識による最適化
- start()呼び出し回数: 1回のみ
- マイク許可要求: 1回のみ
- メモリリーク防止: 適切なクリーンアップ
- CPU使用率削減: 効率的なイベント処理

// 実装例
recognition.continuous = true;
recognition.interimResults = true;
recognition.maxAlternatives = 1;
```

#### UI最適化
```javascript
// レンダリング最適化
- 仮想DOM使用: 必要に応じて導入
- バッチ更新: DOM操作の一括処理
- 適切なキャッシュ: 頻繁な計算の結果保存
- 遅延読み込み: 必要時のみリソース読み込み

// 実装例
requestAnimationFrame(() => {
    // DOM更新処理
});
```

#### データ最適化
```javascript
// データ処理最適化
- 圧縮保存: JSON圧縮による容量削減
- 差分更新: 変更部分のみの更新
- キャッシュ戦略: 頻繁なデータの暗記
- 非同期処理: ブロッキング処理の回避

// 実装例
const compressed = LZString.compress(JSON.stringify(data));
```

---

## 6. セキュリティ考慮事項

### 6.1 音声データセキュリティ

#### データ保護原則
```
✅ 実装必須:
- 音声データの暗号化転送
- APIキーの安全な管理
- 個人情報の適切な処理
- セッションデータの暗号化

❌ 禁止事項:
- 音声データの長期保存
- 第三者への音声データ提供
- 暗号化なしでの転送
- APIキーのハードコーディング
```

#### 実装例
```javascript
// APIキー管理
const apiKey = localStorage.getItem('encrypted_api_key');
const decryptedKey = CryptoJS.AES.decrypt(apiKey, passphrase);

// 音声データ転送
const encryptedData = CryptoJS.AES.encrypt(audioData, key);
await fetch('/api/voice', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ data: encryptedData })
});
```

### 6.2 データ保護

#### ローカルストレージセキュリティ
```javascript
// 暗号化保存
const encryptedData = CryptoJS.AES.encrypt(
    JSON.stringify(data), 
    userPassword
);
localStorage.setItem('knowledge_data', encryptedData);

// 復号化読み込み
const encrypted = localStorage.getItem('knowledge_data');
const decrypted = CryptoJS.AES.decrypt(encrypted, userPassword);
const data = JSON.parse(decrypted.toString(CryptoJS.enc.Utf8));
```

#### APIアクセス制御
```javascript
// トークンベース認証
const token = await getAuthToken();
const headers = {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
};

// レート制限
const rateLimiter = new RateLimiter(100, 'hour');
if (!rateLimiter.tryRemoveTokens(1)) {
    throw new Error('Rate limit exceeded');
}
```

---

## 7. ブラウザ互換性情報

### 7.1 サポートブラウザ

#### 完全サポート
```
Chrome 80+    - 全機能対応
Edge 80+      - 全機能対応
Safari 14+    - 全機能対応（一部制限あり）
Firefox 75+   - 音声認識制限あり
```

#### 機能制限
```
Safari:
- 音声認識の継続時間制限
- バックグラウンドでの制限
- PWA機能の一部制限

Firefox:
- Web Speech API未対応
- 代替実装が必要
- 音声機能の制限
```

### 7.2 ブラウザ別対応

#### 機能検出
```javascript
// 音声認識サポート検出
const SpeechRecognition = window.SpeechRecognition || 
                         window.webkitSpeechRecognition;
if (!SpeechRecognition) {
    // フォールバック処理
    showAlternativeInterface();
}

// PWAサポート検出
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js');
}
```

#### ブラウザ別最適化
```javascript
// Safari対応
if (navigator.userAgent.includes('Safari')) {
    // Safari特有の制限に対応
    recognition.continuous = false; // 制限回避
    implementSafariWorkaround();
}

// Chrome対応
if (navigator.userAgent.includes('Chrome')) {
    // Chrome最適化
    recognition.continuous = true;
    enableAdvancedFeatures();
}
```

---

## 8. 開発・テスト環境

### 8.1 開発環境要件

#### 必須環境
```
Node.js 16+       - 開発ツール実行
Python 3.8+       - ローカルサーバー
Git               - バージョン管理
```

#### 推奨環境
```
VSCode            - 統合開発環境
Chrome DevTools   - デバッグ・分析
Postman          - API テスト
```

### 8.2 テスト環境

#### ローカルテスト
```bash
# ローカルサーバー起動
python3 -m http.server 8000

# テストURL
http://localhost:8000/深堀くん.html
```

#### 統合テスト
```javascript
// 音声認識テスト
const testSuite = new VoiceRecognitionTest();
testSuite.runContinuousRecognitionTest();
testSuite.runErrorRecoveryTest();

// UI テスト
const uiTest = new UITest();
uiTest.runResponsiveTest();
uiTest.runAccessibilityTest();
```

---

**最終更新**: 2025年7月22日  
**文書バージョン**: v1.1 (v0.7.5緊急修復プロジェクト対応) 