# 深堀くんv2.0 音声認識システム改善計画書

**作成日**: 2025年7月21日  
**バージョン**: v1.0  
**目的**: 複雑化した音声コマンドシステムを安定性重視で再構築する包括的計画

---

## 📋 **必読資料（作業前に必須確認）**

新規AIエージェントは以下の資料を必ず確認してから作業を開始してください：

### 🎯 **核心設計資料**
- [`docs/開発ガイドライン.md`](docs/開発ガイドライン.md) - 遵守すべきルール・制約・品質基準
- [`docs/デプロイメント・運用.md`](docs/デプロイメント・運用.md) - 配布・運用・緊急時対応手順
- [`docs/技術仕様・依存関係.md`](docs/技術仕様・依存関係.md) - システム構成・依存関係・API仕様
- [`docs/深堀くん_設計仕様書.md`](docs/深堀くん_設計仕様書.md) - 設計思想・UI/UX仕様・アーキテクチャ

### 🚨 **重要な制約事項**
1. **Rule 0**: 動作している機能の削除・変更は絶対禁止
2. **バックアップ必須**: 変更前の完全バックアップ作成
3. **単一責任制限**: 1回の変更で1つの責任範囲のみ
4. **音声認識影響ゼロ**: 既存の音声認識パフォーマンスを一切阻害しない
5. **ユーザーへ確認依頼する前の徹底テスト**: AI側で実行できるテストは必ずすべて行い、テストが合格してからユーザーにテスト依頼をする
---

## 🎯 **プロジェクト概要**

### **現在の問題**
- 音声関連ファイル40個以上の複雑化
- 「4回に1回しか動かない」音声コマンド
- 複数システムの競合による不安定動作
- フォールバック処理による性能劣化（400ms）

### **目標**
- ファイル数を1/10に削減（voice-processing-manager.js 1ファイル）
- 音声コマンド成功率を90%以上に改善
- 応答時間を100ms以内に短縮
- AI会話継続機能の確実な実装

### **戦略**
- 7/19時点へのクリーンロールバック
- 最小限機能でのvoice-processing-manager.js新規作成
- 段階的機能追加（週単位での慎重な拡張）

---

## 📅 **Phase別実装計画（新規チャット分割対応）**

### **Phase 0: 準備・ロールバック** ✅ **完了済み**
**新規チャット**: 🔴 **必須**（独立した作業）  
**所要時間**: 2-3時間  
**担当者**: 音声システム専門AI  

#### **Phase 0.1: 現状バックアップ作成** ✅
```bash
# 実行コマンド
mkdir -p backups/voice_complex_system_$(date +%Y%m%d_%H%M%S)
cp -r app/voice-*.js backups/voice_complex_system_$(date +%Y%m%d_%H%M%S)/
cp -r docs/VOICE_*.md backups/voice_complex_system_$(date +%Y%m%d_%H%M%S)/
```

#### **Phase 0.2: 7/19レガシーへのロールバック** ✅
```bash
# ロールバック対象
- app/voice-*.js (40個のファイル) → 削除
- 深堀くん.html の音声関連読み込み → 7/19バックアップで復元
```

**🎯 完了条件**: 
- [✅] 全体システム動作確認（音声認識基本動作）
- [✅] レガシーシステムでの「テーマ変更」「質問変更」動作確認  
- [✅] バックアップからの完全復元可能性確認

---

### **Phase 1: voice-processing-manager.js 基盤構築** ✅ **完了済み**
**新規チャット**: 🔴 **必須**（設計・実装特化）  
**所要時間**: 4-5時間  
**担当者**: モジュール設計専門AI  

#### **Phase 1.1: 基本クラス設計** ✅
```javascript
// app/voice-processing-manager.js - 313行で実装完了
class VoiceProcessingManager {
    constructor() {
        this.isInitialized = false;
        this.debugMode = true;
        this.stats = { /* 処理統計システム */ };
        this.debugLog = []; // デバッグログ配列
    }
    
    async processFinalTranscript(text) {
        // Phase 1: 基本仲介機能（従来processFinalTranscript呼び出し）
        // TODO Phase 2: テーマ変更要望検出・処理
        // TODO Phase 2: 質問変更要望検出・処理
    }
    
    // 実装済み：initialize, callOriginalProcessor, fallbackToOriginal, 
    // log, getStats, getDebugInfo + デバッグ関数群
}
```

#### **Phase 1.2: script.js統合** ✅
```javascript
// script.js での実装完了（2つの関数で構成）
// 1. processFinalTranscriptOriginal() - 元の関数をバックアップ
// 2. processFinalTranscript() - VoiceProcessingManager経由の新関数
async function processFinalTranscript(text) {
    if (window.VoiceProcessingManager) {
        // VoiceProcessingManagerインスタンス作成・初期化
        return await window.voiceProcessingManagerInstance.processFinalTranscript(text);
    }
    // フォールバック処理完備
}
```

**🎯 完了条件**:
- [✅] クラス基本構造の実装完了（313行、11KB）
- [✅] script.jsとの正常な連携確認（フォールバック機能付き）
- [✅] デバッグモードでの動作ログ確認（詳細ログ・統計機能）
- [✅] 従来機能の完全保持確認（自動テスト20成功/0エラー）

---

### **Phase 2: AI会話継続機能実装** ✅ **完了済み**
**新規チャット**: 🔴 **必須**（AI統合特化）  
**所要時間**: 6-8時間  
**担当者**: AI統合専門エージェント  

#### **Phase 2.1: テーマ変更要望伝達システム**
```javascript
// 実装要件
detectThemeChangeRequest(text) {
    // 「テーマ変更、もっと技術的に」等の要望抽出
    // 要望をAI promptに組み込み
    // 新テーマ生成の実行
}
```

**対象パターン**:
- 「テーマ変更」「テーマを変えて」
- 「テーマ変更、[具体的要望]」形式
- 要望内容のAI prompt組み込み

#### **Phase 2.2: 質問変更要望伝達システム**
```javascript
// 実装要件  
detectQuestionChangeRequest(text) {
    // 「質問変更、もっと具体的に」等の要望抽出
    // 要望をAI promptに組み込み
    // 新質問生成の実行
}
```

**対象パターン**:
- 「質問変更」「別の質問」「質問を変えて」
- 「質問変更、[具体的要望]」形式
- 要望内容のAI prompt組み込み

**🎯 完了条件**:
- [✅] テーマ変更要望の正確な抽出・伝達
- [✅] 質問変更要望の正確な抽出・伝達
- [✅] AI promptへの要望組み込み確認
- [✅] 生成結果の品質確認

---

### **Phase 3: 基本削除コマンド実装（安全重視）** ✅ **完了済み**
**新規チャット**: 🔴 **必須**（安全性特化）  
**所要時間**: 4-6時間  
**担当者**: セキュリティ・安全性専門AI  

#### **Phase 3.1: 確認付き全削除機能**
```javascript
// 実装要件
handleClearCommand(text) {
    if (text.includes('クリアして')) {
        // ⚠️ 安全性最優先
        // ポップアップ + 音声確認の二重承認
        return this.requestClearConfirmation();
    }
}
```

**安全性要件**:
- 「クリアして」単独での確認必須
- ポップアップ画面での視覚的確認
- 「はい」「いいえ」ボタンでの明確な選択
- 音声での「はい」「いいえ」対応

#### **Phase 3.2: 簡易な文字数削除**
```javascript
// 実装要件（高度なパターンマッチングは後回し）
handleSimpleDeletion(text) {
    // 「5文字消して」「最後の10文字削除」等
    // 数値の確実な抽出
    // 承認無しでの実行（非破壊的と判断）
}
```

**🎯 完了条件**:
- [✅] 確認付き全削除の安全な実装
- [✅] 音声確認システムの正常動作（音声「はい/いいえ」確認）
- [✅] 音声確認システムの動作確認
- [✅] 誤動作防止機能の動作確認

---

### **Phase 4: 統合テスト・品質保証** 🔄 **次実装対象**
**新規チャット**: 🔴 **必須**（テスト・QA特化）  
**所要時間**: 3-4時間  
**担当者**: QA・テスト専門AI  

#### **Phase 4.1: 機能統合テスト**
- [ ] 全機能の個別動作確認
- [ ] 機能間の連携動作確認  
- [ ] エラーハンドリングの動作確認
- [ ] パフォーマンステスト（応答時間測定）

#### **Phase 4.2: 回帰テスト**
- [ ] 既存機能への影響確認
- [ ] 音声認識基本動作の確認
- [ ] データ保存機能の確認
- [ ] UI操作の確認

**🎯 完了条件**:
- [ ] 全テストケース合格
- [ ] パフォーマンス要件達成（応答時間100ms以内）
- [ ] 音声コマンド成功率90%以上
- [ ] 既存機能の完全保持確認

---

## 🛠️ **実装ガイドライン（各Phase共通）**

### **新規チャット開始時の必須確認**
```markdown
新規AIエージェント向け確認チェックリスト：

□ docs/音声認識改善計画.md を完全に読了
□ 担当Phase（Phase 0-4）の詳細要件を理解
□ 必読資料4ファイルの関連部分を確認
□ バックアップ作成手順を理解
□ 完了条件を明確に把握
□ 緊急時のロールバック手順を確認
```

### **各Phase実装時の遵守事項**

#### **コーディング基準**
```javascript
// 必須要件
1. デバッグログの充実
   console.log('[VoiceProcessingManager] 処理開始:', text);
   
2. エラーハンドリングの徹底
   try {
       // 処理
   } catch (error) {
       console.error('[VoiceProcessingManager] エラー:', error);
       // フォールバック処理
   }
   
3. 既存システムとの互換性保持
   // 常に既存のprocessFinalTranscriptにフォールバック
```

#### **テスト要件**
```javascript
// 各機能の動作確認
window.debugVoice = {
    testThemeChange: () => { /* テスト実装 */ },
    testQuestionChange: () => { /* テスト実装 */ },
    testClearCommand: () => { /* テスト実装 */ }
};
```

---

## ⚠️ **重要な注意事項・制約**

### **絶対遵守事項**
1. **既存機能の保護**: 動作中の機能は絶対に削除・変更しない
2. **バックアップ必須**: 全ての変更前にバックアップを作成
3. **段階的実装**: 一度に複数機能を実装しない
4. **完全テスト**: 各段階で完全な動作確認を実施

### **音声認識への影響防止**
```javascript
// 必須確認事項
- processFinalTranscript の処理時間: 100ms以内
- 音声認識パイプラインへの影響: ゼロ
- メモリリークの防止: 適切なクリーンアップ
- エラー時のフォールバック: 確実な動作保証
```

### **UI変更時の注意**
- リアルタイム文字起こし表示の二重システム禁止
- 既存レイアウトの破壊禁止
- 新規UI要素の慎重な配置

---

## 🚨 **緊急時対応手順**

### **問題発生時の即座対応**
1. **即座停止**: 問題発生時は作業を即座に停止
2. **バックアップ復元**: 最新の動作確認済みバックアップに復元
3. **問題報告**: 詳細なエラーログと再現手順を記録
4. **原因分析**: 根本原因の特定と対策案の検討

### **ロールバック判定基準**
```
緊急ロールバック実行条件（1つでも該当）:
□ アプリケーションの起動不可
□ 音声認識の完全停止
□ データ消失・破損
□ 既存機能の重大な動作不良
□ パフォーマンス50%以上の劣化
```

---

## 📊 **品質保証・成功指標**

### **Phase別成功指標**

#### **Phase 0**: ロールバック成功
- [ ] 全体システム正常動作: 100%
- [ ] 音声認識基本機能: 正常
- [ ] 既存機能保持: 完全

#### **Phase 1**: 基盤構築完了  
- [ ] voice-processing-manager.js 動作: 正常
- [ ] script.js統合: 成功
- [ ] パフォーマンス劣化: なし

#### **Phase 2**: AI会話継続実装
- [ ] テーマ変更要望伝達: 90%以上成功
- [ ] 質問変更要望伝達: 90%以上成功  
- [ ] AI prompt組み込み: 100%成功

#### **Phase 3**: 削除コマンド実装
- [ ] 確認付き全削除: 100%安全動作
- [ ] 文字数削除: 80%以上成功
- [ ] 誤動作防止: 100%

#### **Phase 4**: 品質保証完了
- [ ] 全機能統合テスト: 合格
- [ ] 回帰テスト: 合格
- [ ] パフォーマンステスト: 合格

### **最終成功指標**
```
システム全体:
□ 音声コマンド成功率: 90%以上
□ 応答時間: 100ms以内
□ 既存機能保持: 100%
□ 安定性: クラッシュ率 0.1%以下
□ ユーザビリティ: 操作性向上
```

---

## 📞 **サポート・連絡体制**

### **Phase間での情報共有**
```markdown
各新規チャット開始時の引き継ぎ情報:
1. 前Phase完了確認（完了条件チェックリスト）
2. 実装された機能の詳細説明
3. 発見された問題・制約事項
4. 次Phaseへの申し送り事項
5. 更新されたテスト結果・ログ
```

### **問題発生時の対応**
- 緊急度A（即座対応）: アプリ停止、データ消失等
- 緊急度B（24時間以内）: 機能障害、性能劣化等  
- 緊急度C（1週間以内）: 軽微な問題、改善要望等

---

## 🎯 **実行開始の指示**

### **Phase 0開始の準備**
1. 新規チャット作成
2. この計画書（`docs/音声認識改善計画.md`）を添付
3. 必読資料4ファイルを添付
4. 以下のプロンプトで開始：

```markdown
深堀くんv2.0の音声認識システム改善 Phase 0を実行してください。
添付の「音声認識改善計画.md」のPhase 0要件に従い、
7/19時点への安全なロールバックを実行してください。

重要な制約:
- 動作中の機能は絶対に削除しない
- 必ずバックアップを作成してから実行
- 完了条件を全てクリアしてから完了報告

Phase 0完了後、Phase 1用の新規チャット作成準備を行ってください。
```

---

**最終更新**: 2025年1月20日  
**文書バージョン**: v1.0  
**次回更新予定**: Phase 0完了後 