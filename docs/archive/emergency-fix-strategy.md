# 🚨 深堀くんv2.0 緊急修正戦略書

**作成日時**: 2025年7月21日  
**緊急度**: 🔴 **Critical** (基本機能の重大誤動作)  
**方針**: **複雑化絶対回避** + **段階的安全修正**

---

## 🎯 **問題の本質 - 二重システム競合**

### **判明した根本原因**
```
音声入力「5文字消して」
↓
❌ script.js (従来システム) が先に検出
   → {type: 'deletion', action: 'clear_all'}
↓  
✅ voice-processing-manager.js は呼ばれない
   → 正しい number_delete 検出されず
```

**競合システム**:
1. **script.js**: 従来の音声訂正システム（粗い検出・全削除バイアス）
2. **voice-processing-manager.js**: Phase 3 精密削除システム

---

## 🚀 **緊急修正戦略（3段階）**

### **🎯 Phase A: システム競合解決（最優先・1時間以内）**

#### **目標**: 二重システムを単一システムに統一

**修正方針**:
- ✅ **最小限修正**: script.jsの従来音声訂正システムを**条件分岐で回避**
- ✅ **複雑化回避**: 新しいファイル・プロセス追加なし
- ✅ **安全性確保**: 既存機能への影響を最小限に

**具体的修正**:
```javascript
// script.js内で
if (window.VoiceProcessingManager && window.voiceProcessingManagerInstance) {
    // Phase 3システムが利用可能 → 従来システムをスキップ
    return; // 従来の音声訂正処理をバイパス
}
// 従来システム継続
```

---

### **🔧 Phase B: パターン最適化（2番目・30分以内）**

#### **目標**: voice-processing-manager.js の精密化

**修正内容**:
1. **数値削除閾値**: 50文字 → **30文字**に変更
2. **パターンマッチング**: false positive の完全排除
3. **音声認識保護**: 処理中のセッション切断防止

**修正箇所**:
```javascript
// voice-processing-manager.js
requiresConfirmation: count > 30  // 50 → 30に変更
```

---

### **🛡️ Phase C: セッション安定化（3番目・1時間以内）**

#### **目標**: 音声認識セッション切断の防止

**修正方針**:
- ✅ **非同期化改善**: 削除処理の軽量化
- ✅ **セッション保護**: 音声認識継続の保証
- ✅ **複雑化回避**: 新機能追加ではなく、既存処理の最適化

**具体的対応**:
```javascript
// 削除処理の非同期化
await Promise.resolve(); // 処理分割
// 音声認識セッション保護
```

---

## 📋 **段階的実行計画**

### **Step 1: 緊急システム統一（Phase A）**
```
1. script.js の音声訂正システムをPhase 3連携に変更
2. voice-processing-manager.js が単独動作するよう調整
3. 「5文字消して」の正常動作確認
4. 音声認識継続確認
```

**完了条件**: 
- ✅ 「5文字消して」→ 5文字のみ削除
- ✅ 音声認識セッション継続

### **Step 2: パターン精密化（Phase B）**
```
1. 数値削除閾値を30文字に変更
2. パターンマッチングのfalse positive排除
3. 各種削除コマンドの動作確認
```

**完了条件**: 
- ✅ 「5文字消して」→ 即座削除（確認なし）
- ✅ 「35文字消して」→ 確認付き削除
- ✅ 「クリアして」→ 確認付き全削除

### **Step 3: セッション安定化（Phase C）**
```
1. 削除処理の非同期化改善
2. 音声認識セッション保護強化
3. 長時間動作テスト実施
```

**完了条件**: 
- ✅ 削除処理中の音声認識継続
- ✅ セッション切断率 0%
- ✅ 復旧機能動作確認

---

## ⚠️ **絶対遵守事項**

### **複雑化回避原則**
1. **新ファイル作成禁止**: 既存ファイル修正のみ
2. **新プロセス追加禁止**: 既存フロー改善のみ
3. **大規模リファクタリング禁止**: 最小限修正のみ

### **安全性確保原則**
1. **Rule 0厳守**: 動作中機能の削除・変更は絶対禁止
2. **段階的修正**: 1つずつ確実に修正・テスト
3. **フォールバック保証**: エラー時の確実な回復

### **テスト必須原則**
1. **各段階でのテスト**: 修正毎に動作確認
2. **回帰テスト**: 既存機能への影響確認
3. **ユーザー確認**: 実際の使用感での検証

---

## 📊 **修正後の期待される動作フロー**

### **正常動作フロー**
```
音声入力「5文字消して」
↓
voice-processing-manager.js detectDeleteCommand()
→ number_delete (count: 5, requiresConfirmation: false)
↓
handleNumberDelete() 実行
→ 5文字のみ削除
↓
音声認識セッション継続
→ 次の音声入力待機
```

### **確認付き動作フロー**
```
音声入力「35文字消して」
↓
voice-processing-manager.js detectDeleteCommand()
→ number_delete (count: 35, requiresConfirmation: true)
↓
はほりーからの確認メッセージ
→ 音声「はい/いいえ」待機
↓
「はい」→ 35文字削除 / 「いいえ」→ キャンセル
↓
音声認識セッション継続
```

---

## 🎯 **成功指標**

### **Phase A完了指標**
- [ ] 「5文字消して」で5文字のみ削除される
- [ ] 音声認識が切断されない
- [ ] 全削除が実行されない

### **Phase B完了指標**
- [ ] 30文字以下：確認なし削除
- [ ] 31文字以上：確認付き削除
- [ ] false positiveが発生しない

### **Phase C完了指標**
- [ ] 削除処理中も音声認識継続
- [ ] セッション切断率 0%
- [ ] 自動復旧が不要になる

---

## 🚨 **緊急時対応**

### **修正失敗時の即座ロールバック**
```bash
# バックアップからの復旧
cp backups/emergency_backup/script.js app/script.js
cp backups/emergency_backup/voice-processing-manager.js app/voice-processing-manager.js
```

### **エスカレーション基準**
- 既存機能に影響が出た場合：即座ロールバック
- 音声認識が完全停止：即座ロールバック  
- 修正が2時間を超える場合：一時停止・再検討

---

**戦略立案者**: Phase 4 QA・テスト専門AI  
**承認待ち**: ユーザー確認・修正開始指示  
**目標完了**: 2時間以内（3段階合計） 