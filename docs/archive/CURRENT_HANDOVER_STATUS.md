# 深堀くんv2.0 完全引継ぎ用状況説明書

## 📅 作成日時
2025年1月4日 作成

---

## 🎯 深堀くんアプリとは

### アプリケーション概要
**深堀くん**は、音声対話型の知見抽出・収集システムです。ユーザーとAIキャラクター（はほりーの・ねほりーの）が自然な会話を通じて、業務知識や経験を体系的に抽出・記録するアプリケーションです。

### 🎭 キャラクター設定
- **はほりーの**: 進行役・知見評価担当（音声：nova、速度1.1倍）
- **ねほりーの**: 質問・深掘り担当（音声：sage、速度1.2倍）

### 🎯 主要機能
1. **音声対話システム**: リアルタイム音声認識・合成
2. **知見自動抽出**: 会話内容から価値のある知見を自動識別
3. **品質評価システム**: 抽出された知見の重要度を5段階で評価
4. **音声フィードバック**: 知見の評価結果を音声で通知
5. **知見管理**: カテゴリ別の知見分類・保存・エクスポート

### 🏗️ 技術構成
- **フロントエンド**: 単一HTMLファイル（深堀くん.html）
- **JavaScript**: 統合管理（app/script.js、10,710行）
- **音声認識**: WebKit SpeechRecognition API
- **音声合成**: GPT-4o mini TTS API
- **AI処理**: OpenAI GPT-4o mini（会話・知見評価）

---

## 📈 開発経緯と現在のバージョン

### Phase A: 基盤システム構築（完了）
**期間**: 2024年後半
**主要成果**:
- UI改善（「今回をDL」ボタン削除、セッション可視化復旧）
- プロンプト改善（5つの質問パターン追加、重複回避ロジック）
- 知見処理統一化（手動・自動知見の同等処理）

### Phase B: 音声制御強化（完了）
**期間**: 2024年12月〜2025年1月
**主要成果**:
- **B1**: 音声制御管理（AudioControlManager実装、全音声追跡・強制停止）
- **B2**: 音声認識訂正（SpeechCorrectionSystem実装、削除・置換コマンド）
- **緊急修正**: 「どうぞ」応答問題解決
- **追加機能**: スマート音声操作パネル（折りたたみ式UI）

### Phase C: 統合最適化（進行中）
**期間**: 2025年1月〜
**現在の状況**: 初期化エラー修正、音声認識安定化作業中

---

## 🔧 現在の修正作業詳細

### ✅ 解決済み問題

#### 1. AppState未初期化エラー（完全解決）
**問題**: 音声認識システムが`window.AppState`にアクセスできない
```javascript
script.js:227 ❌ AppStateが未初期化 - 音声認識開始不可
```

**原因**: AppStateがローカルスコープに定義されており、グローバルアクセスができない
**修正内容**:
- `app/script.js` 1079行目に `window.AppState = AppState;` を追加
- AppStateをグローバルスコープに公開し、音声認識システムからアクセス可能に

#### 2. 音声認識状態競合問題（修正完了）
**問題**: 異常終了時に状態が`active`のまま固着し、再開が失敗
```javascript
script.js:209 🚫 状態がidleでないため開始不可
```

**原因**: 異常終了時の状態リセット処理が不完全
**修正内容**:
- `app/script.js` 608-618行目の`handleEnd`メソッドを修正
- 異常終了時も状態を即座に`idle`にリセット
- 自動再開前の状態確認を強化

#### 3. CSV読み込みエラー（警告レベル変更）
**問題**: CORS policy違反によるCSV読み込みエラーが警告として表示
```javascript
⚠️ CSV読み込みエラー (categories.csv): TypeError: Failed to fetch
```

**原因**: ローカルファイルアクセスのCORS制限
**修正内容**:
- `app/script.js` 7754行目の警告レベルを変更
- `console.warn`を`console.log`に変更し、フォールバックデータ使用を明示

### 🔍 修正の詳細

#### AppStateグローバル化修正
```javascript
// 修正前: AppStateはローカルスコープのみ
const AppState = {
    apiKey: null,
    currentTheme: '',
    sessionActive: false,
    // ... その他の設定
};

// 修正後: グローバルスコープに公開
const AppState = {
    apiKey: null,
    currentTheme: '',
    sessionActive: false,
    // ... その他の設定
};
// 🔧 AppStateをグローバルに公開
window.AppState = AppState;
```

#### 音声認識状態管理修正
```javascript
// 修正前: 異常終了時の状態リセット不完全
if (this.state === 'active' && AppState.sessionActive) {
    console.log('🔄 異常終了 - 自動再開を検討');
    setTimeout(() => {
        if (this.state === 'idle' && AppState.sessionActive) {
            this.start();
        }
    }, 1000);
}

// 修正後: 即座に状態リセット
if (this.state === 'active' && AppState.sessionActive) {
    console.log('🔄 異常終了 - 状態をリセットして自動再開を検討');
    // 🔧 修正: 異常終了時も状態を即座にidleに戻す
    this.state = 'idle';
    this.notifyListeners();
    
    setTimeout(() => {
        if (this.state === 'idle' && AppState.sessionActive) {
            console.log('🔄 自動再開実行');
            this.start();
        }
    }, 1000);
}
```

---

## 🎮 現在の動作状況

### ✅ 正常動作している機能
1. **ログイン・認証システム**: パスワード暗号化、APIキー管理
2. **テーマ設定**: 「アプリ開発」テーマが正常に認識
3. **音声認識開始**: AppState初期化後、正常に開始
4. **セッション管理**: 知見収集セッションが正常に開始
5. **UI表示**: 右ペインの状況表示（セッション状況、現在のテーマ、抽出された知見）
6. **知見評価**: 5段階評価システム（実用性、具体性、独自性、適用性、重要性）
7. **音声合成**: GPT-4o mini TTSによる自然な音声生成

### 🔄 動作確認が必要な機能
1. **音声認識の連続動作**: 異常終了→自動再開のサイクル
2. **長時間セッション**: 安定した音声認識の継続（10分以上）
3. **知見抽出**: 実際の会話による知見抽出機能
4. **音声訂正**: 削除・置換コマンドの動作確認

---

## 🚨 既知の残存問題

### 1. 音声認識の頻繁な異常終了
**現象**: 音声認識が開始直後に異常終了し、自動再開を繰り返す
```javascript
script.js:599 🏁 音声認識終了
script.js:610 🔄 異常終了 - 自動再開を検討
```

**原因**: ブラウザレベルの音声認識API不安定性
**対策**: 修正済み（状態リセット強化）だが、継続監視が必要
**影響度**: 中（機能は動作するが、ユーザー体験に影響）

### 2. 発声短縮エンジン警告
**現象**: 発声短縮エンジンが利用できない旨の警告
```javascript
script.js:9722 📝 発声短縮エンジンが利用できません - 内蔵短縮機能を使用
```

**原因**: 外部短縮エンジンの未設定
**影響**: 機能的には問題なし（内蔵機能で代替）
**対策**: 現状維持（本番環境では正常動作）

---

## 🔧 技術的詳細

### アーキテクチャ概要
```
深堀くん.html (メインファイル)
├── app/
│   ├── script.js (10,710行 - 統合管理)
│   └── style.css (UI スタイル)
├── config/
│   ├── prompts.js (AI応答プロンプト)
│   ├── voice_config.js (音声設定)
│   ├── categories.csv (知見カテゴリ)
│   └── user_names.csv (ユーザー管理)
├── docs/
│   ├── PHASE_A_IMPROVEMENTS.md
│   ├── PHASE_B_IMPROVEMENTS.md
│   └── CHANGELOG.md
└── assets/ (画像ファイル)
```

### 主要システム
1. **統合音声認識マネージャー**: `RecognitionManager`クラス
2. **AppState管理**: グローバル状態管理システム
3. **知見管理**: `KnowledgeFileManager`、`CategoryManager`
4. **音声制御**: `AudioControlManager`、`SpeechCorrectionSystem`
5. **品質評価**: `QualityAssessmentSystem`
6. **会話制御**: `ConversationGatekeeper`

### 重要な設定
- **TTS API**: GPT-4o mini TTS（`model: 'gpt-4o-mini-tts'`）
- **音声認識**: WebKit SpeechRecognition API
- **知見評価**: 自動記録閾値70点、音声フィードバック有効
- **音声設定**: はほりーの（nova、1.1倍速）、ねほりーの（sage、1.2倍速）

---

## 📋 次回作業時の確認事項

### 1. 即座に確認すべき項目
1. **音声認識の安定性**: 連続動作テスト（10分以上）
2. **AppState初期化**: エラーログにAppState関連エラーがないか
3. **テーマ認識**: 「アプリ開発」テーマが正しく表示されているか
4. **知見抽出**: 実際の会話で知見が抽出されるか

### 2. 実行すべきテスト
```javascript
// ブラウザコンソールでの確認コマンド
console.log('AppState確認:', !!window.AppState);
console.log('現在のテーマ:', window.AppState?.currentTheme);
console.log('セッション状態:', window.AppState?.sessionActive);
console.log('音声認識状態:', window.stateManager?.recognitionManager?.state);
```

### 3. 監視すべきログ
- `❌ AppStateが未初期化` → 解決済みだが再発監視
- `🚫 状態がidleでないため開始不可` → 修正済みだが動作確認
- `🔄 異常終了 - 状態をリセット` → 正常な修正動作
- `✅ 知見抽出` → 知見抽出機能の動作確認

---

## 🎯 今後の開発計画

### Phase C改良（現在進行中）
**期間**: 2025年1月〜3月
**目標**: システム安定化と機能統合

#### 優先度：高
1. **音声認識安定化**: エラー処理のさらなる改善
2. **知見抽出精度向上**: AI評価システムの強化
3. **パフォーマンス最適化**: 大量知見処理の高速化
4. **UI/UX最適化**: より直感的な操作画面

#### 優先度：中
1. **音声訂正機能強化**: より自然な訂正コマンド
2. **セッション管理改良**: 中断・再開機能
3. **エクスポート機能拡張**: 複数形式対応
4. **統計機能**: 知見抽出の分析・可視化

### Phase D: 高度機能実装（2025年4月〜）
**期間**: 2025年4月〜6月
**目標**: 高度な知見管理機能

#### 計画中の機能
1. **マルチセッション対応**: 複数テーマの並行処理
2. **知見検索機能**: 過去の知見からの検索・参照
3. **AI知見関連付け**: 知見間の関係性分析
4. **知見品質向上**: 自動リライト・構造化

### Phase E: チーム機能・拡張性（2025年7月〜）
**期間**: 2025年7月〜9月
**目標**: チーム利用とスケーラビリティ

#### 長期的な改善項目
1. **チーム機能**: 複数ユーザーでの知見共有
2. **権限管理**: ユーザー役割・アクセス制御
3. **データベース統合**: 大規模知見管理
4. **API化**: 外部システムとの連携

---

## 📚 関連ドキュメント

### 必読ドキュメント
- `docs/PHASE_A_IMPROVEMENTS.md`: Phase A改良の詳細
- `docs/PHASE_B_IMPROVEMENTS.md`: Phase B改良の詳細
- `docs/CHANGELOG.md`: 全体的な変更履歴

### 技術仕様
- `config/prompts.js`: AI応答プロンプト設定
- `config/voice_config.js`: 音声設定詳細
- TTS API仕様: GPT-4o mini TTS固定（変更禁止）

### 開発ガイド
- 会話制御ロジック: `docs/fukabori_conversation_logic.md`
- 知見抽出フロー: アプリ内の6段階会話サイクル
- 音声コマンド: 削除・置換・設定変更コマンド

---

## 🚀 引継ぎ時の初期動作確認手順

### 1. 基本動作確認
```bash
# 1. ファイルを開く
open 深堀くん.html

# 2. ブラウザコンソールを開く（F12）

# 3. 以下のログが表示されることを確認
# ✅ AppStateをグローバルに公開
# ✅ 統合音声認識マネージャー初期化完了
# ✅ StateManager初期化完了
```

### 2. 音声認識動作確認
```javascript
// コンソールで実行
console.log('音声認識状態:', window.stateManager?.recognitionManager?.state);
console.log('AppState存在確認:', !!window.AppState);
console.log('セッション情報:', {
    active: window.AppState?.sessionActive,
    theme: window.AppState?.currentTheme,
    phase: window.AppState?.phase
});
```

### 3. 知見抽出テスト
```javascript
// 知見抽出機能の確認
console.log('知見設定:', window.AppState?.knowledgeSettings);
console.log('抽出された知見:', window.AppState?.extractedKnowledge?.length);
```

### 4. 問題発生時の緊急対応
```javascript
// 音声認識が固着した場合
window.stateManager?.recognitionManager?.resetToIdle();

// AppState未初期化エラーが再発した場合
window.AppState = window.AppState || {};

// 全音声停止
window.stateManager?.audioManager?.forceStopAllAudio('emergency');
```

---

## 📞 重要な注意事項

### 🚨 絶対に変更してはいけない項目
1. **TTS API設定**: `model: 'gpt-4o-mini-tts'`（docs/TTS_API_仕様.mdで固定）
2. **AppStateグローバル公開**: `window.AppState = AppState;`（音声認識の前提）
3. **音声認識状態リセット**: 異常終了時の`this.state = 'idle'`
4. **知見評価基準**: 5段階評価システム（実用性、具体性、独自性、適用性、重要性）

### ⚠️ 変更時に注意が必要な項目
1. **音声認識の初期化順序**: AppState → UI → マイクの順序を維持
2. **知見評価閾値**: デフォルト70点、変更時は設定保存機能も更新
3. **CSV読み込み**: フォールバックデータの整合性確認
4. **会話フロー**: 6段階会話サイクルの順序

### 🔄 定期的にメンテナンスが必要な項目
1. **プロンプト調整**: AI応答の品質向上
2. **音声設定**: 話速・音量の最適化
3. **知見カテゴリ**: 新しい業務分野の追加
4. **エラーログ**: 異常パターンの監視

---

## 🎉 作業完了の判定基準

### 完全成功の条件
1. **10分間の連続音声認識**: エラーなしで動作
2. **AppState関連エラーゼロ**: 初期化エラーが一切発生しない
3. **知見抽出機能**: 実際の会話で知見が正常に抽出される
4. **音声フィードバック**: 知見評価結果が音声で正常に通知される

### 部分成功の条件
1. **音声認識開始成功**: 初回起動時に正常開始
2. **テーマ認識成功**: 「アプリ開発」テーマが正しく表示
3. **基本UI動作**: ログイン→セッション開始→基本操作が可能
4. **知見記録**: 手動での知見確認・保存が可能

### 最小動作の条件
1. **ログイン成功**: APIキー設定とパスワード認証
2. **セッション開始**: テーマ設定と基本画面表示
3. **音声認識**: 一時的でも音声入力が認識される

---

## 🌟 深堀くんの価値と意義

### ビジネス価値
1. **知識の可視化**: 暗黙知の明文化・体系化
2. **効率的な知見収集**: 自然な会話による負担軽減
3. **品質保証**: AI評価による知見の客観的な価値判定
4. **継続的改善**: 蓄積された知見の活用・発展

### 技術的価値
1. **音声UI**: 直感的な音声インターフェース
2. **AI統合**: 複数AI機能の統合活用
3. **リアルタイム処理**: 即座の知見抽出・評価
4. **拡張性**: モジュール設計による機能追加容易性

### 将来的な展望
1. **企業知識基盤**: 組織の知識資産構築
2. **AI学習データ**: 高品質な学習データの蓄積
3. **意思決定支援**: 過去の知見に基づく判断支援
4. **イノベーション促進**: 知見の組み合わせによる新しいアイデア創出

---

**最終更新**: 2025年1月4日
**修正バージョン**: v2.0-phase-b-complete-fixed-handover
**現在のPhase**: Phase C（統合最適化）進行中
**次回作業者への一言**: AppState初期化問題は解決済み。音声認識の安定性確認が最優先課題です。深堀くんの可能性を最大限に引き出すため、ユーザー体験の向上に重点を置いてください。 