# 深堀くんv2.0 モジュール化開発ルール

## 🎯 **基本原則**

### **ファイル分割の絶対ルール**
機能追加で1ファイルのコードが肥大化したり、相互依存が複雑化する前に、**必ず適切なファイル分割・モジュール化を実施する**。

### **適用対象**
- **全ての機能追加**
- **既存機能の改良**
- **新機能の実装**
- **バグ修正に伴う機能拡張**

## 📏 **分割基準**

### **ファイルサイズ基準**
- **1ファイル800行超過** → 即座に分割検討
- **1ファイル1000行以上** → 分割必須
- **1関数200行以上** → 機能分割必須

### **機能複雑度基準**
- **単一責任原則違反** → 分割必須
- **5つ以上の異なる機能** → 分割検討
- **依存関係が3層以上** → 分割必須

### **保守性基準**
- **1つの変更が3ファイル以上に影響** → 設計見直し
- **新機能追加時に既存機能を修正** → 分割検討
- **テストが困難** → モジュール化必須

## 🏗️ **モジュール化戦略**

### **機能別分割**
```
app/
├── voice-recognition/          # 音声認識機能
│   ├── continuous-manager.js  # 継続的音声認識
│   ├── state-controller.js    # 状態管理
│   └── error-handler.js       # エラー処理
├── knowledge-system/          # 知見管理システム
│   ├── extraction.js         # 知見抽出
│   ├── quality-assessment.js # 品質評価
│   └── storage.js            # 知見保存
└── ui-components/             # UI コンポーネント
    ├── microphone-button.js  # マイクボタン
    ├── chat-display.js       # チャット表示
    └── settings-panel.js     # 設定パネル
```

### **レイヤー別分割**
```
app/
├── core/              # 核心機能
├── services/          # サービス層
├── controllers/       # 制御層
├── ui/               # UI層
└── utils/            # ユーティリティ
```

## 🔧 **実装ルール**

### **新機能追加時の手順**
1. **機能設計** → 単一責任の確認
2. **影響範囲分析** → 既存コードへの影響評価
3. **分割要否判定** → 基準に基づく判定
4. **モジュール設計** → 適切な分割戦略選択
5. **実装** → モジュール化を前提とした実装
6. **テスト** → 各モジュールの独立テスト

### **分割実装の原則**
- **疎結合** → モジュール間の依存を最小化
- **高凝集** → 関連機能を同一モジュールに集約
- **明確なインターフェース** → モジュール間の通信を明確化
- **再利用性** → 他機能からの利用を考慮

## 📋 **チェックリスト**

### **機能追加前**
- [ ] 既存ファイルのサイズ確認
- [ ] 機能の責任範囲明確化
- [ ] 依存関係の複雑度評価
- [ ] モジュール化の必要性判定

### **実装中**
- [ ] 単一責任原則の遵守
- [ ] 適切なファイル分割の実行
- [ ] インターフェースの明確化
- [ ] 命名規則の統一

### **実装後**
- [ ] ファイルサイズの再確認
- [ ] 依存関係の妥当性確認
- [ ] テストの実装
- [ ] ドキュメントの更新

## 🚨 **違反時の対応**

### **即座対応が必要な状況**
- **1ファイル1000行超過**
- **循環依存の発生**
- **テスト不可能な状態**

### **対応手順**
1. **緊急分割** → 最小限の機能分割
2. **リファクタリング** → 適切な設計への修正
3. **テスト実装** → 品質保証
4. **ドキュメント更新** → 変更内容の記録

## 🎯 **成功指標**

### **コード品質**
- **平均ファイルサイズ**: 500行以下
- **最大ファイルサイズ**: 800行以下
- **循環依存**: 0件
- **テストカバレッジ**: 80%以上

### **開発効率**
- **新機能追加時間**: 短縮
- **バグ修正時間**: 短縮
- **コードレビュー時間**: 短縮

## 📚 **参考資料**

### **既存のモジュール化事例**
- **Phase C-1**: UI管理システム分離
- **Phase C-2-1**: 知見管理システム分離
- **音声制御システム**: voice-core.js分離

### **設計パターン**
- **MVC パターン**: 表示・制御・データの分離
- **Factory パターン**: オブジェクト生成の統一
- **Observer パターン**: 状態変更の通知

---

**このルールは深堀くんv2.0の全開発工程において厳格に遵守すること。**
**品質の高い、保守性の優れたコードベースの維持が最優先事項である。** 