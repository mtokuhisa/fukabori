# 段階1: 依存関係の安定化 - 詳細計画

## 目標
utils.jsの関数が正しく動作しない問題を解決し、全モジュール間の依存関係を安定化する

## 問題の詳細分析

### 1. 現在発生しているエラー
```javascript
// 先ほど発生したエラー
ReferenceError: showMessage is not defined (script.js:5127, 2086)
ReferenceError: hashPassword is not defined (script.js:4032)
```

### 2. 推定される原因
1. **読み込み順序の問題**: utils.jsが正しく読み込まれていない
2. **スコープの問題**: 関数がグローバルスコープに正しく露出されていない
3. **タイミングの問題**: 関数が定義される前に呼び出されている
4. **参照方法の不統一**: 直接呼び出しとwindow経由の混在

## 段階1の実行計画

### ステップ1.1: 現状の詳細調査（調査フェーズ）

#### 1.1.1 HTMLファイルでの読み込み状況確認
- [ ] 深堀くん.htmlでのscriptタグの順序確認
- [ ] utils.jsが正しく読み込まれているか確認
- [ ] ブラウザの開発者ツールでネットワークタブを確認

#### 1.1.2 関数定義の確認
- [ ] utils.js内での関数定義の構文確認
- [ ] window オブジェクトへの正しい露出確認
- [ ] グローバルスコープでの関数の存在確認

#### 1.1.3 関数呼び出しパターンの調査
- [ ] script.js内での直接呼び出し箇所の特定
- [ ] window経由の呼び出し箇所の特定
- [ ] 他モジュールでの呼び出しパターンの確認

### ステップ1.2: 参照方法の統一（修正フェーズ）

#### 1.2.1 utils.js の修正
**目標**: 関数の確実なグローバル露出
- [ ] 関数定義の即座実行確認
- [ ] window オブジェクトへの露出の確実化
- [ ] デバッグ用のログ追加

#### 1.2.2 各モジュールでの参照方法統一
**統一ルール**: すべて `window.関数名()` 形式に統一

**file-processing.js**
- [ ] 独自のshowMessage実装の削除
- [ ] window.showMessage への統一

**knowledge-management.js**
- [ ] showMessage() → window.showMessage() に変更
- [ ] downloadTextFile() → window.downloadTextFile() に変更

**api-key-setup.js**
- [ ] 既に window.showMessage() を使用（確認のみ）

**script.js**
- [ ] showMessage() → window.showMessage() に変更（85箇所）
- [ ] hashPassword() → window.hashPassword() に変更（6箇所）
- [ ] その他utils.js関数の window 経由への変更

### ステップ1.3: 循環依存の解消

#### 1.3.1 file-processing.js の独自実装削除
- [ ] 独自のshowMessage実装（line 57）を削除
- [ ] utils.js の showMessage への完全依存に変更

#### 1.3.2 依存関係の一方向化確認
- [ ] utils.js → 他モジュール（一方向）の確認
- [ ] 逆方向の依存がないことの確認

### ステップ1.4: 検証とテスト

#### 1.4.1 段階的検証
1. **utils.js単体テスト**
   - [ ] ブラウザコンソールで各関数の存在確認
   - [ ] window.showMessage('test', 'テストメッセージ') の動作確認

2. **各モジュール単体テスト**
   - [ ] file-processing.js の showMessage 動作確認
   - [ ] knowledge-management.js の関数動作確認
   - [ ] api-key-setup.js の関数動作確認

3. **script.js の段階的テスト**
   - [ ] ログイン機能のテスト（hashPassword使用）
   - [ ] メッセージ表示機能のテスト（showMessage使用）
   - [ ] その他の依存関数のテスト

#### 1.4.2 統合テスト
- [ ] アプリケーション全体の動作確認
- [ ] エラーログの確認
- [ ] 全機能の基本動作テスト

## 実行時の安全対策

### 1. バックアップ戦略
- [ ] 各ファイル修正前のバックアップ作成
- [ ] Git コミットによる変更履歴の保存

### 2. 段階的実行
- [ ] 1つのファイルずつ修正
- [ ] 各修正後の動作確認
- [ ] 問題発生時の即座の巻き戻し

### 3. 最小限の変更原則
- [ ] 必要最小限の変更のみ実施
- [ ] 大規模な構造変更は段階2以降に延期

## 成功基準

### 1. エラーの解消
- [ ] `ReferenceError: showMessage is not defined` の解消
- [ ] `ReferenceError: hashPassword is not defined` の解消
- [ ] その他の依存関係エラーの解消

### 2. 機能の正常動作
- [ ] ログイン機能の正常動作
- [ ] メッセージ表示機能の正常動作
- [ ] ファイル処理機能の正常動作
- [ ] 知見管理機能の正常動作

### 3. 依存関係の明確化
- [ ] 全モジュールでの統一された関数参照方法
- [ ] 循環依存の完全解消
- [ ] 依存関係マップの更新

## 予想される課題と対策

### 課題1: script.js の編集困難性
**対策**: sedコマンドを使用した一括置換

### 課題2: 大量の参照箇所の変更
**対策**: 段階的な変更と各段階での動作確認

### 課題3: 予期しない副作用
**対策**: 小さな変更単位での検証とバックアップ

## 次の段階への準備

段階1完了後、以下を準備:
- [ ] 安定化された依存関係の文書化
- [ ] 段階2（script.js分離）の詳細計画策定
- [ ] リファクタリング対象機能の優先順位決定 