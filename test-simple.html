<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±å €ãã‚“v2.0 - ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            background: #e9ecef;
        }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        .debug-section {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æ·±å €ãã‚“v2.0 - ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>ç¶™ç¶šçš„éŸ³å£°èªè­˜ã®å“è³ªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚</p>
        
        <div class="instructions">
            <h4>ğŸ“‹ é‡è¦ãªä½¿ç”¨æ–¹æ³•</h4>
            <p><strong>ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ·±å €ãã‚“v2.0ã¨åŒã˜ã‚¿ãƒ–ã§é–‹ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</strong></p>
            <ol>
                <li>æ·±å €ãã‚“v2.0ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹</li>
                <li><strong>åŒã˜ã‚¿ãƒ–ã§</strong>ã“ã®HTMLãƒ•ã‚¡ã‚¤ãƒ«ã«ç§»å‹•</li>
                <li>ã¾ãŸã¯ã€æ·±å €ãã‚“v2.0ã®é–‹ç™ºè€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ï¼š</li>
            </ol>
            <textarea readonly style="width: 100%; height: 60px; font-family: monospace; font-size: 12px;">// ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
const stats = stateManager.recognitionManager.getMicrophonePermissionStats();
console.log('ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ:', stats);</textarea>
        </div>
        
        <div class="status" id="statusDisplay">
            ğŸ” ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ç¢ºèªä¸­...
        </div>
        
        <h3>ğŸ” è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
        <div class="debug-section">
            <button class="btn" onclick="performDetailedDiagnosis()">ğŸ” è©³ç´°è¨ºæ–­å®Ÿè¡Œ</button>
            <div id="debugOutput" style="margin-top: 15px; font-family: monospace; font-size: 12px;"></div>
        </div>
        
        <h3>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒœã‚¿ãƒ³</h3>
        <div>
            <button class="btn" id="checkStatusBtn" onclick="checkSystemStatus()">
                ğŸ” ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
            </button>
            <button class="btn" id="directTestBtn" onclick="directTest()">
                ğŸ¯ ç›´æ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            </button>
            <button class="btn" id="startTestBtn" onclick="startTest()" disabled>
                ğŸ§ª ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆé–‹å§‹
            </button>
            <button class="btn" id="quickTestBtn" onclick="quickTest()" disabled>
                âš¡ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆï¼ˆ10ç§’ï¼‰
            </button>
        </div>
        
        <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆçµæœã‚³ãƒ”ãƒ¼</h3>
        <textarea id="resultText" rows="10" style="width: 100%; font-family: monospace;">
ãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
        </textarea>
        <br>
        <button class="btn" onclick="copyResults()">ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
        <button class="btn" onclick="generateManualInstructions()">ğŸ“– æ‰‹å‹•ãƒ†ã‚¹ãƒˆæŒ‡ç¤ºç”Ÿæˆ</button>
        
        <h3>ğŸ“ ãƒ­ã‚°</h3>
        <div class="log" id="logContainer">
            [èµ·å‹•] ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ<br>
        </div>
    </div>

    <script>
        // ãƒ­ã‚°è¿½åŠ é–¢æ•°
        function addLog(message) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString('ja-JP');
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML += `[${timestamp}] ${message}<br>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // è©³ç´°è¨ºæ–­å®Ÿè¡Œ
        function performDetailedDiagnosis() {
            const debugOutput = document.getElementById('debugOutput');
            let diagnosis = '';
            
            try {
                diagnosis += '=== ç’°å¢ƒè¨ºæ–­ ===\n';
                diagnosis += `URL: ${window.location.href}\n`;
                diagnosis += `User Agent: ${navigator.userAgent}\n`;
                diagnosis += `Parent Window: ${window.parent === window ? 'Same (å˜ç‹¬å®Ÿè¡Œ)' : 'Different (iframe/popup)'}\n`;
                
                diagnosis += '\n=== ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚¢ã‚¯ã‚»ã‚¹è¨ºæ–­ ===\n';
                try {
                    const parentWindow = window.parent;
                    diagnosis += `Parent Window Access: OK\n`;
                    
                    // AppStateã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
                    try {
                        const appState = parentWindow.AppState;
                        diagnosis += `AppState Access: ${appState ? 'OK' : 'NULL'}\n`;
                        if (appState) {
                            diagnosis += `Session Active: ${appState.sessionActive || 'false'}\n`;
                        }
                    } catch (e) {
                        diagnosis += `AppState Access Error: ${e.message}\n`;
                    }
                    
                    // StateManagerã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
                    try {
                        const stateManager = parentWindow.stateManager;
                        diagnosis += `StateManager Access: ${stateManager ? 'OK' : 'NULL'}\n`;
                        if (stateManager && stateManager.recognitionManager) {
                            diagnosis += `RecognitionManager: OK\n`;
                            const stats = stateManager.recognitionManager.getMicrophonePermissionStats();
                            diagnosis += `Stats Access: OK\n`;
                            diagnosis += `Start Count: ${stats.startCount}\n`;
                            diagnosis += `Efficiency: ${stats.efficiency}%\n`;
                            diagnosis += `Strategy: ${stats.strategy}\n`;
                        }
                    } catch (e) {
                        diagnosis += `StateManager Access Error: ${e.message}\n`;
                    }
                    
                } catch (e) {
                    diagnosis += `Parent Window Access Error: ${e.message}\n`;
                }
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œ
                diagnosis += '\n=== ãƒ­ãƒ¼ã‚«ãƒ«ã‚¢ã‚¯ã‚»ã‚¹è¨ºæ–­ ===\n';
                try {
                    const appState = window.AppState;
                    diagnosis += `Local AppState: ${appState ? 'OK' : 'NULL'}\n`;
                    if (appState) {
                        diagnosis += `Local Session Active: ${appState.sessionActive || 'false'}\n`;
                    }
                } catch (e) {
                    diagnosis += `Local AppState Error: ${e.message}\n`;
                }
                
                try {
                    const stateManager = window.stateManager;
                    diagnosis += `Local StateManager: ${stateManager ? 'OK' : 'NULL'}\n`;
                    if (stateManager && stateManager.recognitionManager) {
                        diagnosis += `Local RecognitionManager: OK\n`;
                        const stats = stateManager.recognitionManager.getMicrophonePermissionStats();
                        diagnosis += `Local Stats: ${JSON.stringify(stats, null, 2)}\n`;
                    }
                } catch (e) {
                    diagnosis += `Local StateManager Error: ${e.message}\n`;
                }
                
            } catch (error) {
                diagnosis += `è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${error.message}\n`;
            }
            
            debugOutput.innerHTML = `<pre>${diagnosis}</pre>`;
            addLog('è©³ç´°è¨ºæ–­ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ');
        }

        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function checkSystemStatus() {
            addLog('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªã‚’å®Ÿè¡Œä¸­...');
            
            let foundValidAccess = false;
            let sessionActive = false;
            let recognitionManager = null;
            
            // è¤‡æ•°ã®æ–¹æ³•ã§çŠ¶æ…‹ç¢ºèªã‚’è©¦è¡Œ
            const accessMethods = [
                { name: 'Parent Window', getter: () => window.parent },
                { name: 'Local Window', getter: () => window },
                { name: 'Top Window', getter: () => window.top }
            ];
            
            for (const method of accessMethods) {
                try {
                    const targetWindow = method.getter();
                    
                    // AppStateç¢ºèª
                    if (targetWindow.AppState) {
                        sessionActive = targetWindow.AppState.sessionActive;
                        addLog(`${method.name} - AppStateç™ºè¦‹: sessionActive=${sessionActive}`);
                        foundValidAccess = true;
                    }
                    
                    // StateManagerç¢ºèª
                    if (targetWindow.stateManager && targetWindow.stateManager.recognitionManager) {
                        recognitionManager = targetWindow.stateManager.recognitionManager;
                        addLog(`${method.name} - RecognitionManagerç™ºè¦‹`);
                        foundValidAccess = true;
                        break; // æœ‰åŠ¹ãªã‚¢ã‚¯ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã£ãŸã®ã§çµ‚äº†
                    }
                    
                } catch (error) {
                    addLog(`${method.name} ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            }
            
            if (foundValidAccess) {
                addLog(`ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹: ${sessionActive ? 'âœ… é–‹å§‹æ¸ˆã¿' : 'âŒ æœªé–‹å§‹'}`);
                addLog(`éŸ³å£°èªè­˜ã‚·ã‚¹ãƒ†ãƒ : ${recognitionManager ? 'âœ… å‹•ä½œä¸­' : 'âŒ æœªåˆæœŸåŒ–'}`);
                
                if (sessionActive && recognitionManager) {
                    updateStatus('success', 'âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¯èƒ½ãªçŠ¶æ…‹ã§ã™');
                    enableTestButtons();
                    
                    // çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
                    try {
                        const stats = recognitionManager.getMicrophonePermissionStats();
                        addLog(`ç¾åœ¨ã®çµ±è¨ˆ: start()=${stats.startCount}, åŠ¹ç‡æ€§=${stats.efficiency}%`);
                        addLog(`æˆ¦ç•¥: ${stats.strategy}, ç¶™ç¶šæ€§: ${stats.continuousRecognition ? 'å‹•ä½œä¸­' : 'åœæ­¢ä¸­'}`);
                    } catch (e) {
                        addLog('çµ±è¨ˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message);
                    }
                } else {
                    updateStatus('error', 'âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    disableTestButtons();
                    if (!sessionActive) {
                        addLog('ğŸ’¡ æ‰‹é †: ãƒ­ã‚°ã‚¤ãƒ³â†’ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠâ†’ãƒ†ãƒ¼ãƒè¨­å®šâ†’ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹');
                    }
                }
            } else {
                addLog('âŒ æœ‰åŠ¹ãªã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                updateStatus('error', 'âŒ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ - æ‰‹å‹•ãƒ†ã‚¹ãƒˆã‚’åˆ©ç”¨ã—ã¦ãã ã•ã„');
                disableTestButtons();
            }
        }

        // ç›´æ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        function directTest() {
            addLog('ğŸ¯ ç›´æ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚’è©¦è¡Œä¸­...');
            
            try {
                // è¤‡æ•°ã®æ–¹æ³•ã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚’è©¦è¡Œ
                const accessMethods = [
                    { name: 'Parent Window', getter: () => window.parent },
                    { name: 'Local Window', getter: () => window },
                    { name: 'Top Window', getter: () => window.top }
                ];
                
                let testStarted = false;
                
                for (const method of accessMethods) {
                    try {
                        const targetWindow = method.getter();
                        
                        if (targetWindow.continuousRecognitionTester && 
                            targetWindow.continuousRecognitionTester.startAutoTest) {
                            
                            const success = targetWindow.continuousRecognitionTester.startAutoTest(10000);
                            
                            if (success) {
                                addLog(`âœ… ${method.name}çµŒç”±ã§ãƒ†ã‚¹ãƒˆé–‹å§‹æˆåŠŸ`);
                                updateStatus('success', 'ğŸ¯ ç›´æ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­... 10ç§’å¾Œã«çµæœã‚’è¡¨ç¤ºã—ã¾ã™');
                                testStarted = true;
                                
                                // 10ç§’å¾Œã«çµæœè¡¨ç¤º
                                setTimeout(() => {
                                    displayResultsDirect(targetWindow);
                                }, 12000);
                                
                                break;
                            }
                        }
                    } catch (error) {
                        addLog(`${method.name}çµŒç”±ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`);
                    }
                }
                
                if (!testStarted) {
                    addLog('âŒ ç›´æ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
                    updateStatus('error', 'âŒ ç›´æ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¤±æ•— - æ‰‹å‹•ãƒ†ã‚¹ãƒˆæŒ‡ç¤ºã‚’å‚ç…§ã—ã¦ãã ã•ã„');
                    generateManualInstructions();
                }
                
            } catch (error) {
                addLog('âŒ ç›´æ¥ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
                updateStatus('error', 'ç›´æ¥ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // çµæœè¡¨ç¤ºï¼ˆç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ç‰ˆï¼‰
        function displayResultsDirect(targetWindow) {
            addLog('ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚’å–å¾—ä¸­...');
            
            try {
                const recognitionManager = targetWindow.stateManager?.recognitionManager;
                
                if (!recognitionManager) {
                    addLog('âŒ éŸ³å£°èªè­˜ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    return;
                }
                
                const stats = recognitionManager.getMicrophonePermissionStats();
                
                // çµæœåˆ†æ
                let grade = 'D (å•é¡Œã‚ã‚Š)';
                let passed = false;
                
                if (stats.efficiency >= 95) {
                    grade = 'A+ (å„ªç§€)';
                    passed = true;
                } else if (stats.efficiency >= 85) {
                    grade = 'A (è‰¯å¥½)';
                    passed = true;
                } else if (stats.efficiency >= 70) {
                    grade = 'B (æ™®é€š)';
                    passed = true;
                } else if (stats.efficiency >= 50) {
                    grade = 'C (è¦æ”¹å–„)';
                    passed = false;
                }
                
                // çµæœãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
                const resultText = generateResultText(stats, grade, passed);
                document.getElementById('resultText').value = resultText;
                
                addLog(`ğŸ“Š ãƒ†ã‚¹ãƒˆå®Œäº†: ${grade} (${passed ? 'åˆæ ¼' : 'ä¸åˆæ ¼'})`);
                updateStatus(passed ? 'success' : 'warning', `ğŸ“Š ãƒ†ã‚¹ãƒˆå®Œäº†: ${grade}`);
                
            } catch (error) {
                addLog('âŒ çµæœè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + error.message);
                updateStatus('error', 'çµæœè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // æ‰‹å‹•ãƒ†ã‚¹ãƒˆæŒ‡ç¤ºç”Ÿæˆ
        function generateManualInstructions() {
            addLog('ğŸ“– æ‰‹å‹•ãƒ†ã‚¹ãƒˆæŒ‡ç¤ºã‚’ç”Ÿæˆä¸­...');
            
            const instructions = `æ·±å €ãã‚“v2.0 ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆ - æ‰‹å‹•å®Ÿè¡ŒæŒ‡ç¤º
=====================================

ğŸ¯ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å®Ÿè¡Œæ–¹æ³•:
1. æ·±å €ãã‚“v2.0ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
2. F12ã‚­ãƒ¼ã§é–‹ç™ºè€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ã
3. ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦å®Ÿè¡Œ:

// === ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒ¼ãƒ‰ ===
console.log('ğŸ§ª ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆé–‹å§‹');
const testResult = stateManager.recognitionManager.getMicrophonePermissionStats();
console.log('ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ:', testResult);

// è©³ç´°è¡¨ç¤º
console.log('=== è©³ç´°çµ±è¨ˆæƒ…å ± ===');
console.log('start()å‘¼ã³å‡ºã—å›æ•°:', testResult.startCount);
console.log('ãƒã‚¤ã‚¯è¨±å¯è¦æ±‚å›æ•°:', testResult.microphonePermissionRequests);
console.log('åŠ¹ç‡æ€§:', testResult.efficiency + '%');
console.log('ç¶™ç¶šçš„éŸ³å£°èªè­˜:', testResult.continuousRecognition ? 'å‹•ä½œä¸­' : 'åœæ­¢ä¸­');
console.log('ä½¿ç”¨æˆ¦ç•¥:', testResult.strategy);

// å“è³ªè©•ä¾¡
const efficiency = testResult.efficiency;
let grade = 'D (å•é¡Œã‚ã‚Š)';
if (efficiency >= 95) grade = 'A+ (å„ªç§€)';
else if (efficiency >= 85) grade = 'A (è‰¯å¥½)';
else if (efficiency >= 70) grade = 'B (æ™®é€š)';
else if (efficiency >= 50) grade = 'C (è¦æ”¹å–„)';

console.log('ğŸ¯ å“è³ªã‚°ãƒ¬ãƒ¼ãƒ‰:', grade);
console.log('âœ… ãƒ†ã‚¹ãƒˆå®Œäº† - ä¸Šè¨˜ã®çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å ±å‘Šã—ã¦ãã ã•ã„');

// === å®Ÿè¡Œæ™‚åˆ» ===
console.log('å®Ÿè¡Œæ™‚åˆ»:', new Date().toLocaleString('ja-JP'));

=====================================
ğŸ“‹ å ±å‘Šç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ:
ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå¾Œã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚ŒãŸçµæœã‚’ã™ã¹ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚

ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:
- ã€ŒstateManager is not definedã€ã‚¨ãƒ©ãƒ¼ â†’ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“
- ã€ŒCannot read propertyã€ã‚¨ãƒ©ãƒ¼ â†’ éŸ³å£°èªè­˜ã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“

ğŸ“ ã‚µãƒãƒ¼ãƒˆ:
å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆã¯ã€ã“ã®æŒ‡ç¤ºã¨ç™ºç”Ÿã—ãŸã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å ±å‘Šã—ã¦ãã ã•ã„ã€‚
`;

            document.getElementById('resultText').value = instructions;
            updateStatus('warning', 'ğŸ“– æ‰‹å‹•ãƒ†ã‚¹ãƒˆæŒ‡ç¤ºã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
            addLog('âœ… æ‰‹å‹•ãƒ†ã‚¹ãƒˆæŒ‡ç¤ºã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
        }

        // çŠ¶æ…‹è¡¨ç¤ºæ›´æ–°
        function updateStatus(type, message) {
            const statusDisplay = document.getElementById('statusDisplay');
            statusDisplay.className = `status ${type}`;
            statusDisplay.textContent = message;
        }

        // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
        function enableTestButtons() {
            document.getElementById('startTestBtn').disabled = false;
            document.getElementById('quickTestBtn').disabled = false;
            addLog('âœ… ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ');
        }

        // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
        function disableTestButtons() {
            document.getElementById('startTestBtn').disabled = true;
            document.getElementById('quickTestBtn').disabled = true;
            addLog('âŒ ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ');
        }

        // ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆé–‹å§‹
        function startTest() {
            directTest(); // ç›´æ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨åŒã˜å‡¦ç†
        }

        // ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
        function quickTest() {
            directTest(); // ç›´æ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨åŒã˜å‡¦ç†
        }

        // çµæœãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
        function generateResultText(stats, grade, passed) {
            const now = new Date();
            const timestamp = now.toLocaleString('ja-JP');
            
            return `æ·±å €ãã‚“v2.0 ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆçµæœ
=====================================

å®Ÿè¡Œæ™‚åˆ»: ${timestamp}
ãƒ†ã‚¹ãƒˆç¨®åˆ¥: ç¶™ç¶šçš„éŸ³å£°èªè­˜å“è³ªãƒ†ã‚¹ãƒˆ

ğŸ“Š çµ±è¨ˆæƒ…å ±:
- start()å‘¼ã³å‡ºã—: ${stats.startCount || 0}å›
- ãƒã‚¤ã‚¯è¨±å¯è¦æ±‚: ${stats.microphonePermissionRequests || 0}å›
- åŠ¹ç‡æ€§: ${stats.efficiency === Infinity ? 'âˆ' : stats.efficiency || 0}%
- ç¶™ç¶šçš„éŸ³å£°èªè­˜: ${stats.continuousRecognition ? 'å‹•ä½œä¸­' : 'åœæ­¢ä¸­'}
- æˆ¦ç•¥: ${stats.strategy || 'unknown'}

ğŸ¯ è©•ä¾¡çµæœ:
- å“è³ªã‚°ãƒ¬ãƒ¼ãƒ‰: ${grade}
- ãƒ†ã‚¹ãƒˆçµæœ: ${passed ? 'åˆæ ¼' : 'ä¸åˆæ ¼'}

${passed ? 'âœ… ç¶™ç¶šçš„éŸ³å£°èªè­˜ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚' : 'âš ï¸ æ”¹å–„ãŒå¿…è¦ãªå•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚'}

ğŸ“ æ¨å¥¨äº‹é …:
${stats.startCount === 1 ? 'âœ… ç†æƒ³çš„ãªstart()å‘¼ã³å‡ºã—å›æ•°ã§ã™ã€‚' : ''}
${stats.efficiency === 100 ? 'ğŸ¯ å®Œç’§ãªåŠ¹ç‡æ€§ã‚’é”æˆã—ã¾ã—ãŸï¼' : ''}
${stats.startCount > 3 ? 'âš ï¸ start()å‘¼ã³å‡ºã—ãŒå¤šã™ãã¾ã™ - æˆ¦ç•¥è¦‹ç›´ã—ãŒå¿…è¦ã§ã™ã€‚' : ''}

=====================================
æ·±å €ãã‚“v2.0 ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ `;
        }

        // çµæœã‚³ãƒ”ãƒ¼
        function copyResults() {
            const resultText = document.getElementById('resultText');
            resultText.select();
            
            try {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(resultText.value).then(() => {
                        addLog('ğŸ“‹ çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                        updateStatus('success', 'ğŸ“‹ çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    });
                } else {
                    document.execCommand('copy');
                    addLog('ğŸ“‹ çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    updateStatus('success', 'ğŸ“‹ çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                addLog('âŒ ã‚³ãƒ”ãƒ¼å¤±æ•—: ' + error.message);
                updateStatus('error', 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
            addLog('ã¾ãšã€ŒğŸ” è©³ç´°è¨ºæ–­å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
            updateStatus('warning', 'ã€ŒğŸ” è©³ç´°è¨ºæ–­å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã§ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­ã‚’é–‹å§‹ã—ã¦ãã ã•ã„');
            
            // è‡ªå‹•è¨ºæ–­å®Ÿè¡Œ
            setTimeout(performDetailedDiagnosis, 1000);
        });
    </script>
</body>
</html> 