<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±å €ãã‚“v2.0 - ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            background: #e9ecef;
        }
        .success { background: #d4edda; color: #155724; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æ·±å €ãã‚“v2.0 - ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>ã“ã®ãƒšãƒ¼ã‚¸ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã€HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¯æ­£ã—ãå‹•ä½œã—ã¦ã„ã¾ã™ã€‚</p>
        
        <div class="status" id="statusDisplay">
            ğŸ” ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ç¢ºèªä¸­...
        </div>
        
        <h3>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãƒœã‚¿ãƒ³</h3>
        <div>
            <button class="btn" id="checkStatusBtn" onclick="checkSystemStatus()">
                ğŸ” ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
            </button>
            <button class="btn" id="startTestBtn" onclick="startTest()" disabled>
                ğŸ§ª ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆé–‹å§‹
            </button>
            <button class="btn" id="quickTestBtn" onclick="quickTest()" disabled>
                âš¡ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆï¼ˆ30ç§’ï¼‰
            </button>
        </div>
        
        <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆçµæœã‚³ãƒ”ãƒ¼</h3>
        <textarea id="resultText" rows="6" style="width: 100%; font-family: monospace;">
ãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
        </textarea>
        <br>
        <button class="btn" onclick="copyResults()">ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
        
        <h3>ğŸ“ ãƒ­ã‚°</h3>
        <div class="log" id="logContainer">
            [èµ·å‹•] ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ<br>
        </div>
    </div>

    <script>
        // ãƒ­ã‚°è¿½åŠ é–¢æ•°
        function addLog(message) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString('ja-JP');
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML += `[${timestamp}] ${message}<br>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
        function checkSystemStatus() {
            addLog('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªã‚’å®Ÿè¡Œä¸­...');
            
            try {
                // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ç¢ºèªã‚’è©¦è¡Œ
                const parentWindow = window.parent;
                
                if (parentWindow === window) {
                    addLog('âš ï¸ å˜ç‹¬ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã™');
                    addLog('ğŸ’¡ æ·±å €ãã‚“v2.0ã®ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„');
                    updateStatus('warning', 'æ·±å €ãã‚“v2.0ã®ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã—ã¦ãã ã•ã„');
                    return;
                }
                
                addLog('è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...');
                
                // AppStateã®ç¢ºèª
                const sessionActive = parentWindow.AppState?.sessionActive;
                const recognitionManager = parentWindow.stateManager?.recognitionManager;
                
                addLog(`ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹: ${sessionActive ? 'âœ… é–‹å§‹æ¸ˆã¿' : 'âŒ æœªé–‹å§‹'}`);
                addLog(`éŸ³å£°èªè­˜ã‚·ã‚¹ãƒ†ãƒ : ${recognitionManager ? 'âœ… å‹•ä½œä¸­' : 'âŒ æœªåˆæœŸåŒ–'}`);
                
                if (sessionActive && recognitionManager) {
                    updateStatus('success', 'âœ… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¯èƒ½ãªçŠ¶æ…‹ã§ã™');
                    enableTestButtons();
                    
                    // çµ±è¨ˆæƒ…å ±ã‚’å–å¾—
                    try {
                        const stats = recognitionManager.getMicrophonePermissionStats();
                        addLog(`ç¾åœ¨ã®çµ±è¨ˆ: start()=${stats.startCount}, åŠ¹ç‡æ€§=${stats.efficiency}%`);
                    } catch (e) {
                        addLog('çµ±è¨ˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message);
                    }
                } else {
                    updateStatus('error', 'âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    disableTestButtons();
                    
                    if (!sessionActive) {
                        addLog('ğŸ’¡ æ‰‹é †: ãƒ­ã‚°ã‚¤ãƒ³â†’ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠâ†’ãƒ†ãƒ¼ãƒè¨­å®šâ†’ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹');
                    }
                }
                
            } catch (error) {
                addLog('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
                updateStatus('error', 'ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼: ' + error.message);
                disableTestButtons();
            }
        }

        // çŠ¶æ…‹è¡¨ç¤ºæ›´æ–°
        function updateStatus(type, message) {
            const statusDisplay = document.getElementById('statusDisplay');
            statusDisplay.className = `status ${type}`;
            statusDisplay.textContent = message;
        }

        // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
        function enableTestButtons() {
            document.getElementById('startTestBtn').disabled = false;
            document.getElementById('quickTestBtn').disabled = false;
            addLog('âœ… ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ');
        }

        // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
        function disableTestButtons() {
            document.getElementById('startTestBtn').disabled = true;
            document.getElementById('quickTestBtn').disabled = true;
            addLog('âŒ ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ');
        }

        // ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆé–‹å§‹
        function startTest() {
            addLog('ğŸ§ª ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                const parentWindow = window.parent;
                const success = parentWindow.continuousRecognitionTester.startAutoTest(30000); // 30ç§’ãƒ†ã‚¹ãƒˆ
                
                if (success) {
                    addLog('âœ… ãƒ†ã‚¹ãƒˆé–‹å§‹æˆåŠŸ - 30ç§’é–“å®Ÿè¡Œã•ã‚Œã¾ã™');
                    updateStatus('success', 'ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­... 30ç§’å¾Œã«çµæœã‚’è¡¨ç¤ºã—ã¾ã™');
                    
                    // 30ç§’å¾Œã«çµæœè¡¨ç¤º
                    setTimeout(() => {
                        displayResults();
                    }, 32000);
                } else {
                    addLog('âŒ ãƒ†ã‚¹ãƒˆé–‹å§‹å¤±æ•—');
                    updateStatus('error', 'ãƒ†ã‚¹ãƒˆé–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                addLog('âŒ ãƒ†ã‚¹ãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼: ' + error.message);
                updateStatus('error', 'ãƒ†ã‚¹ãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
        function quickTest() {
            addLog('âš¡ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                const parentWindow = window.parent;
                const success = parentWindow.continuousRecognitionTester.startAutoTest(10000); // 10ç§’ãƒ†ã‚¹ãƒˆ
                
                if (success) {
                    addLog('âœ… ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆé–‹å§‹æˆåŠŸ - 10ç§’é–“å®Ÿè¡Œã•ã‚Œã¾ã™');
                    updateStatus('success', 'âš¡ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­... 10ç§’å¾Œã«çµæœã‚’è¡¨ç¤ºã—ã¾ã™');
                    
                    // 10ç§’å¾Œã«çµæœè¡¨ç¤º
                    setTimeout(() => {
                        displayResults();
                    }, 12000);
                } else {
                    addLog('âŒ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆé–‹å§‹å¤±æ•—');
                    updateStatus('error', 'ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆé–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                addLog('âŒ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
                updateStatus('error', 'ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // çµæœè¡¨ç¤º
        function displayResults() {
            addLog('ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚’å–å¾—ä¸­...');
            
            try {
                const parentWindow = window.parent;
                const recognitionManager = parentWindow.stateManager?.recognitionManager;
                
                if (!recognitionManager) {
                    addLog('âŒ éŸ³å£°èªè­˜ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    return;
                }
                
                const stats = recognitionManager.getMicrophonePermissionStats();
                
                // çµæœåˆ†æ
                let grade = 'D (å•é¡Œã‚ã‚Š)';
                let passed = false;
                
                if (stats.efficiency >= 95) {
                    grade = 'A+ (å„ªç§€)';
                    passed = true;
                } else if (stats.efficiency >= 85) {
                    grade = 'A (è‰¯å¥½)';
                    passed = true;
                } else if (stats.efficiency >= 70) {
                    grade = 'B (æ™®é€š)';
                    passed = true;
                } else if (stats.efficiency >= 50) {
                    grade = 'C (è¦æ”¹å–„)';
                    passed = false;
                }
                
                // çµæœãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
                const resultText = generateResultText(stats, grade, passed);
                document.getElementById('resultText').value = resultText;
                
                addLog(`ğŸ“Š ãƒ†ã‚¹ãƒˆå®Œäº†: ${grade} (${passed ? 'åˆæ ¼' : 'ä¸åˆæ ¼'})`);
                updateStatus(passed ? 'success' : 'warning', `ğŸ“Š ãƒ†ã‚¹ãƒˆå®Œäº†: ${grade}`);
                
            } catch (error) {
                addLog('âŒ çµæœè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + error.message);
                updateStatus('error', 'çµæœè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // çµæœãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
        function generateResultText(stats, grade, passed) {
            const now = new Date();
            const timestamp = now.toLocaleString('ja-JP');
            
            return `æ·±å €ãã‚“v2.0 ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆçµæœ
=====================================

å®Ÿè¡Œæ™‚åˆ»: ${timestamp}
ãƒ†ã‚¹ãƒˆç¨®åˆ¥: ç¶™ç¶šçš„éŸ³å£°èªè­˜å“è³ªãƒ†ã‚¹ãƒˆ

ğŸ“Š çµ±è¨ˆæƒ…å ±:
- start()å‘¼ã³å‡ºã—: ${stats.startCount || 0}å›
- ãƒã‚¤ã‚¯è¨±å¯è¦æ±‚: ${stats.microphonePermissionRequests || 0}å›
- åŠ¹ç‡æ€§: ${stats.efficiency === Infinity ? 'âˆ' : stats.efficiency || 0}%
- ç¶™ç¶šçš„éŸ³å£°èªè­˜: ${stats.continuousRecognition ? 'å‹•ä½œä¸­' : 'åœæ­¢ä¸­'}
- æˆ¦ç•¥: ${stats.strategy || 'unknown'}

ğŸ¯ è©•ä¾¡çµæœ:
- å“è³ªã‚°ãƒ¬ãƒ¼ãƒ‰: ${grade}
- ãƒ†ã‚¹ãƒˆçµæœ: ${passed ? 'åˆæ ¼' : 'ä¸åˆæ ¼'}

${passed ? 'âœ… ç¶™ç¶šçš„éŸ³å£°èªè­˜ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚' : 'âš ï¸ æ”¹å–„ãŒå¿…è¦ãªå•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚'}

=====================================
æ·±å €ãã‚“v2.0 ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ `;
        }

        // çµæœã‚³ãƒ”ãƒ¼
        function copyResults() {
            const resultText = document.getElementById('resultText');
            resultText.select();
            
            try {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(resultText.value).then(() => {
                        addLog('ğŸ“‹ çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                        updateStatus('success', 'ğŸ“‹ çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    });
                } else {
                    document.execCommand('copy');
                    addLog('ğŸ“‹ çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    updateStatus('success', 'ğŸ“‹ çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                addLog('âŒ ã‚³ãƒ”ãƒ¼å¤±æ•—: ' + error.message);
                updateStatus('error', 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ã‚·ãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
            addLog('ã€ŒğŸ” ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
            updateStatus('warning', 'ã€ŒğŸ” ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
        });
    </script>
</body>
</html> 