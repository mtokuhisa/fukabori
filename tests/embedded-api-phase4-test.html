<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4 åŸ‹ã‚è¾¼ã¿API Key ç·åˆãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: #333;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .test-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #3498db;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .test-section h3 {
            color: #2c3e50;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .test-button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
        }
        
        .test-button.critical {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        
        .test-button.success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }
        
        .test-result {
            background: #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #bdc3c7;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .test-result.success {
            background: linear-gradient(135deg, #d5edda, #c3e6cb);
            border-color: #4caf50;
            color: #155724;
        }
        
        .test-result.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-color: #f44336;
            color: #721c24;
        }
        
        .test-result.info {
            background: linear-gradient(135deg, #d1ecf1, #bee5eb);
            border-color: #2196f3;
            color: #0c5460;
        }
        
        .progress-bar {
            width: 100%;
            height: 25px;
            background: #ecf0f1;
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #3498db, #2980b9);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>ğŸ” Phase 4: åŸ‹ã‚è¾¼ã¿API Key ç·åˆãƒ†ã‚¹ãƒˆ</h1>
            <p>æ·±å €ãã‚“v2.0 ä¼æ¥­é…å¸ƒå‘ã‘æ©Ÿèƒ½ã®çµ±åˆãƒ†ã‚¹ãƒˆãƒ»å“è³ªä¿è¨¼</p>
        </div>
        
        <!-- é€²æ—è¡¨ç¤º -->
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill" style="width: 0%;">0% å®Œäº†</div>
        </div>
        
        <!-- Phase 4-1: ç·åˆãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h3>ğŸš€ Phase 4-1: ç·åˆãƒ†ã‚¹ãƒˆ - å…¨ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h3>
            <button class="test-button success" onclick="runAllScenarioTests()">å…¨ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button class="test-button" onclick="testBasicFunctionality()">åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="testIntegrationFlow()">çµ±åˆãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ</button>
            <div class="test-result" id="scenarioTestResult"></div>
        </div>
        
        <!-- Phase 4-2: å›å¸°ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h3>ğŸ”„ Phase 4-2: å›å¸°ãƒ†ã‚¹ãƒˆ - æ—¢å­˜æ©Ÿèƒ½å…¨ä½“ã®å‹•ä½œç¢ºèª</h3>
            <button class="test-button" onclick="runRegressionTests()">å›å¸°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button class="test-button" onclick="testExistingFeatures()">æ—¢å­˜æ©Ÿèƒ½ä¿è­·ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="testBackwardCompatibility()">å¾Œæ–¹äº’æ›æ€§ãƒ†ã‚¹ãƒˆ</button>
            <div class="test-result" id="regressionTestResult"></div>
        </div>
        
        <!-- Phase 4-3: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h3>âš¡ Phase 4-3: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ - èµ·å‹•æ™‚é–“ãƒ»ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç¢ºèª</h3>
            <button class="test-button" onclick="runPerformanceTests()">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="testStartupTime()">èµ·å‹•æ™‚é–“æ¸¬å®š</button>
            <button class="test-button" onclick="testMemoryUsage()">ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æ¸¬å®š</button>
            <div class="test-result" id="performanceTestResult"></div>
        </div>
        
        <!-- Phase 4-4: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section">
            <h3>ğŸ›¡ï¸ Phase 4-4: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ - ä¸æ­£ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰</h3>
            <button class="test-button" onclick="runErrorHandlingTests()">ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="testInvalidPasswords()">ç„¡åŠ¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="testNetworkErrors()">ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãƒ†ã‚¹ãƒˆ</button>
            <div class="test-result" id="errorHandlingTestResult"></div>
        </div>
        
        <!-- Phase 4-5: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ä½œæˆ -->
        <div class="test-section">
            <h3>ğŸ“– Phase 4-5: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ä½œæˆ - ä¼æ¥­ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚¬ã‚¤ãƒ‰</h3>
            <button class="test-button" onclick="generateUserManual()">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç”Ÿæˆ</button>
            <button class="test-button" onclick="testDocumentationAccuracy()">ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç²¾åº¦ãƒ†ã‚¹ãƒˆ</button>
            <div class="test-result" id="userManualResult"></div>
        </div>
        
        <!-- Phase 4-6: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †æ›¸ä½œæˆ -->
        <div class="test-section">
            <h3>ğŸš¨ Phase 4-6: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †æ›¸ä½œæˆ - ç·Šæ€¥æ™‚å¾©æ—§æ–¹æ³•</h3>
            <button class="test-button critical" onclick="createRollbackProcedure()">ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †æ›¸ä½œæˆ</button>
            <button class="test-button critical" onclick="testEmergencyRollback()">ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</button>
            <div class="test-result" id="rollbackTestResult"></div>
        </div>
        
        <!-- Phase 4-7: æœ€çµ‚ãƒ‡ãƒªãƒãƒªãƒ¼ãƒ»å®Œäº†å ±å‘Šæ›¸ä½œæˆ -->
        <div class="test-section">
            <h3>âœ… Phase 4-7: æœ€çµ‚ãƒ‡ãƒªãƒãƒªãƒ¼ãƒ»å®Œäº†å ±å‘Šæ›¸ä½œæˆ</h3>
            <button class="test-button success" onclick="generateFinalReport()">æœ€çµ‚å®Œäº†å ±å‘Šæ›¸ç”Ÿæˆ</button>
            <button class="test-button" onclick="validateDeploymentReadiness()">ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ç¢ºèª</button>
            <div class="test-result" id="finalReportResult"></div>
        </div>
    </div>

    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- ãƒ¢ãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ  -->
    <script>
        // AppStateã®ãƒ¢ãƒƒã‚¯
        window.AppState = { 
            apiKey: null, 
            apiKeySource: null,
            embeddedAuthenticated: false
        };
        
        // StorageManagerã®ãƒ¢ãƒƒã‚¯
        window.StorageManager = {
            apiKey: {
                getCount: () => 0,
                getWithPriority: () => null,
                isConfiguredExtended: () => ({
                    hasUserApiKey: false,
                    hasEmbeddedApiKey: true,
                    isEmbeddedAuthenticated: false,
                    currentSource: null,
                    totalCount: 0
                })
            }
        };
        
        // showMessageã®ãƒ¢ãƒƒã‚¯
        window.showMessage = function(type, message) {
            console.log(`[${type.toUpperCase()}] ${message}`);
        };
    </script>
    
    <!-- åŸ‹ã‚è¾¼ã¿APIç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿ -->
    <script src="../app/embedded-api-manager.js"></script>
    
    <!-- Phase 4 çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
        let testState = {
            totalTests: 7,
            completedTests: 0,
            failedTests: 0,
            startTime: null,
            testResults: []
        };
        
        // é€²æ—æ›´æ–°
        function updateProgress() {
            const progress = (testState.completedTests / testState.totalTests) * 100;
            const progressFill = document.getElementById('progressFill');
            if (progressFill) {
                progressFill.style.width = `${progress}%`;
                progressFill.textContent = `${Math.round(progress)}% å®Œäº† (${testState.completedTests}/${testState.totalTests})`;
            }
        }
        
        // çµæœè¡¨ç¤º
        function displayResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `test-result ${type}`;
            }
        }
        
        // Phase 4-1: ç·åˆãƒ†ã‚¹ãƒˆ
        async function runAllScenarioTests() {
            displayResult('scenarioTestResult', 'ğŸš€ å…¨ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹...\n\n', 'info');
            
            try {
                const results = [];
                
                // åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                results.push(await testEmbeddedApiManagerInitialization());
                results.push(await testCorporatePasswordAuthentication());
                results.push(await testApiKeyDecryption());
                results.push(await testPriorityControl());
                
                const successCount = results.filter(r => r.success).length;
                const message = `âœ… å…¨ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå®Œäº†\n\næˆåŠŸ: ${successCount}/${results.length}\n\n` +
                    results.map(r => `${r.success ? 'âœ…' : 'âŒ'} ${r.name}: ${r.message}`).join('\n');
                
                displayResult('scenarioTestResult', message, successCount === results.length ? 'success' : 'error');
                testState.completedTests++;
                updateProgress();
                
            } catch (error) {
                displayResult('scenarioTestResult', `âŒ å…¨ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                testState.failedTests++;
            }
        }
        
        // åŸºæœ¬ãƒ†ã‚¹ãƒˆé–¢æ•°
        async function testEmbeddedApiManagerInitialization() {
            try {
                if (!window.EmbeddedApiManager) {
                    throw new Error('EmbeddedApiManagerãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                const initialized = window.EmbeddedApiManager.initialize();
                return {
                    success: initialized,
                    name: 'EmbeddedApiManageråˆæœŸåŒ–',
                    message: initialized ? 'æ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ' : 'åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ'
                };
            } catch (error) {
                return {
                    success: false,
                    name: 'EmbeddedApiManageråˆæœŸåŒ–',
                    message: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }
        
        async function testCorporatePasswordAuthentication() {
            try {
                if (!window.EmbeddedApiManager) {
                    throw new Error('EmbeddedApiManagerãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                // æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã®ãƒ†ã‚¹ãƒˆ
                const success = await window.EmbeddedApiManager.authenticateAndDecrypt('irobakuf');
                
                return {
                    success: success,
                    name: 'ä¼æ¥­ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼',
                    message: success ? 'èªè¨¼æˆåŠŸ' : 'èªè¨¼å¤±æ•—'
                };
            } catch (error) {
                return {
                    success: false,
                    name: 'ä¼æ¥­ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼',
                    message: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }
        
        async function testApiKeyDecryption() {
            try {
                if (!window.EmbeddedApiManager || !window.EmbeddedApiManager.isAuthenticated) {
                    throw new Error('äº‹å‰ã«èªè¨¼ãŒå¿…è¦ã§ã™');
                }
                
                const apiKey = window.EmbeddedApiManager.getApiKeyWithPriority();
                const isValid = apiKey && apiKey.startsWith('sk-test');
                
                return {
                    success: isValid,
                    name: 'API Keyå¾©å·åŒ–',
                    message: isValid ? `å¾©å·åŒ–æˆåŠŸ: ${apiKey.substring(0, 10)}...` : 'å¾©å·åŒ–å¤±æ•—'
                };
            } catch (error) {
                return {
                    success: false,
                    name: 'API Keyå¾©å·åŒ–',
                    message: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }
        
        async function testPriorityControl() {
            try {
                if (!window.EmbeddedApiManager) {
                    throw new Error('EmbeddedApiManagerãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
                
                const config = window.EmbeddedApiManager.isApiKeyConfigured();
                const hasEmbedded = config.hasEmbeddedApiKey && config.isEmbeddedAuthenticated;
                
                return {
                    success: hasEmbedded,
                    name: 'å„ªå…ˆé †ä½åˆ¶å¾¡',
                    message: hasEmbedded ? 'åŸ‹ã‚è¾¼ã¿API Keyå„ªå…ˆé †ä½åˆ¶å¾¡æ­£å¸¸' : 'å„ªå…ˆé †ä½åˆ¶å¾¡ç•°å¸¸'
                };
            } catch (error) {
                return {
                    success: false,
                    name: 'å„ªå…ˆé †ä½åˆ¶å¾¡',
                    message: `ã‚¨ãƒ©ãƒ¼: ${error.message}`
                };
            }
        }
        
        // Phase 4-2: å›å¸°ãƒ†ã‚¹ãƒˆ
        async function runRegressionTests() {
            displayResult('regressionTestResult', 'ğŸ”„ å›å¸°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n\n', 'info');
            
            try {
                const tests = [
                    { name: 'AppStateäº’æ›æ€§', test: () => window.AppState !== undefined },
                    { name: 'StorageManageräº’æ›æ€§', test: () => window.StorageManager !== undefined },
                    { name: 'CryptoJSäº’æ›æ€§', test: () => typeof CryptoJS !== 'undefined' },
                    { name: 'æ—¢å­˜API Keyæ©Ÿèƒ½', test: () => window.StorageManager.apiKey !== undefined }
                ];
                
                const results = tests.map(t => ({
                    name: t.name,
                    success: t.test(),
                    message: t.test() ? 'æ­£å¸¸' : 'ç•°å¸¸'
                }));
                
                const successCount = results.filter(r => r.success).length;
                const message = `âœ… å›å¸°ãƒ†ã‚¹ãƒˆå®Œäº†\n\næˆåŠŸ: ${successCount}/${results.length}\n\n` +
                    results.map(r => `${r.success ? 'âœ…' : 'âŒ'} ${r.name}: ${r.message}`).join('\n');
                
                displayResult('regressionTestResult', message, successCount === results.length ? 'success' : 'error');
                testState.completedTests++;
                updateProgress();
                
            } catch (error) {
                displayResult('regressionTestResult', `âŒ å›å¸°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                testState.failedTests++;
            }
        }
        
        // Phase 4-3: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        async function runPerformanceTests() {
            displayResult('performanceTestResult', 'âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n\n', 'info');
            
            try {
                const startTime = performance.now();
                
                // åˆæœŸåŒ–æ™‚é–“æ¸¬å®š
                window.EmbeddedApiManager.initialize();
                const initTime = performance.now() - startTime;
                
                // èªè¨¼æ™‚é–“æ¸¬å®š
                const authStartTime = performance.now();
                await window.EmbeddedApiManager.authenticateAndDecrypt('irobakuf');
                const authTime = performance.now() - authStartTime;
                
                // API Keyå–å¾—æ™‚é–“æ¸¬å®š
                const getKeyStartTime = performance.now();
                window.EmbeddedApiManager.getApiKeyWithPriority();
                const getKeyTime = performance.now() - getKeyStartTime;
                
                const message = `âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†\n\n` +
                    `åˆæœŸåŒ–æ™‚é–“: ${initTime.toFixed(2)}ms\n` +
                    `èªè¨¼æ™‚é–“: ${authTime.toFixed(2)}ms\n` +
                    `API Keyå–å¾—æ™‚é–“: ${getKeyTime.toFixed(2)}ms\n\n` +
                    `ç·å‡¦ç†æ™‚é–“: ${(initTime + authTime + getKeyTime).toFixed(2)}ms`;
                
                displayResult('performanceTestResult', message, 'success');
                testState.completedTests++;
                updateProgress();
                
            } catch (error) {
                displayResult('performanceTestResult', `âŒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                testState.failedTests++;
            }
        }
        
        // Phase 4-4: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
        async function runErrorHandlingTests() {
            displayResult('errorHandlingTestResult', 'ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n\n', 'info');
            
            try {
                const results = [];
                
                // ç„¡åŠ¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
                const invalidPasswordResult = await window.EmbeddedApiManager.authenticateAndDecrypt('wrongpassword');
                results.push({
                    name: 'ç„¡åŠ¹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å‡¦ç†',
                    success: !invalidPasswordResult,
                    message: !invalidPasswordResult ? 'æ­£ã—ãæ‹’å¦ã•ã‚ŒãŸ' : 'èª¤ã£ã¦èªè¨¼ã•ã‚ŒãŸ'
                });
                
                const successCount = results.filter(r => r.success).length;
                const message = `âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆå®Œäº†\n\næˆåŠŸ: ${successCount}/${results.length}\n\n` +
                    results.map(r => `${r.success ? 'âœ…' : 'âŒ'} ${r.name}: ${r.message}`).join('\n');
                
                displayResult('errorHandlingTestResult', message, successCount === results.length ? 'success' : 'error');
                testState.completedTests++;
                updateProgress();
                
            } catch (error) {
                displayResult('errorHandlingTestResult', `âŒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                testState.failedTests++;
            }
        }
        
        // Phase 4-5: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç”Ÿæˆ
        async function generateUserManual() {
            displayResult('userManualResult', 'ğŸ“– ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç”Ÿæˆä¸­...\n\n', 'info');
            
            const manual = `# æ·±å €ãã‚“v2.0 ä¼æ¥­é…å¸ƒå‘ã‘åŸ‹ã‚è¾¼ã¿API Key ä½¿ç”¨ã‚¬ã‚¤ãƒ‰

## ğŸ¯ æ¦‚è¦
æ·±å €ãã‚“v2.0ã§ã¯ã€ä¼æ¥­é…å¸ƒå‘ã‘ã«äº‹å‰è¨­å®šã•ã‚ŒãŸAPI Keyã‚’ä½¿ç”¨ã§ãã¾ã™ã€‚

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. Step0ç”»é¢ã§ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
1. æ·±å €ãã‚“ã‚’èµ·å‹•
2. Step0ç”»é¢ã§ã€Œä¼æ¥­é…å¸ƒè¨­å®šã‚’ä½¿ç”¨ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ä¼æ¥­ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€Œirobakufã€ã‚’å…¥åŠ›
4. ã€Œèªè¨¼ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

### 2. è‡ªå‹•çš„ã«API Keyè¨­å®šå®Œäº†
èªè¨¼æˆåŠŸå¾Œã€è‡ªå‹•çš„ã«API KeyãŒè¨­å®šã•ã‚Œã€ã™ãã«æ·±å €ãã‚“ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚

## âš ï¸ æ³¨æ„äº‹é …
- ä¼æ¥­ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç¤¾å†…ã§å…±æœ‰ã•ã‚ŒãŸã‚‚ã®ã®ã¿ã‚’ã”ä½¿ç”¨ãã ã•ã„
- å€‹äººã®API Keyã‚’è¨­å®šã—ãŸå ´åˆã¯ã€ãã¡ã‚‰ãŒå„ªå…ˆçš„ã«ä½¿ç”¨ã•ã‚Œã¾ã™

## ğŸ†˜ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- èªè¨¼ã«å¤±æ•—ã™ã‚‹å ´åˆã¯ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†ç¢ºèªã—ã¦ãã ã•ã„
- å•é¡ŒãŒç¶™ç¶šã™ã‚‹å ´åˆã¯ã€ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„`;
            
            displayResult('userManualResult', `âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç”Ÿæˆå®Œäº†\n\n${manual}`, 'success');
            testState.completedTests++;
            updateProgress();
        }
        
        // Phase 4-6: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †æ›¸ä½œæˆ
        async function createRollbackProcedure() {
            displayResult('rollbackTestResult', 'ğŸš¨ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †æ›¸ä½œæˆä¸­...\n\n', 'info');
            
            const procedure = `# æ·±å €ãã‚“v2.0 åŸ‹ã‚è¾¼ã¿API Keyæ©Ÿèƒ½ ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †æ›¸

## ğŸš¨ ç·Šæ€¥æ™‚ã®å¯¾å¿œ

### å³åº§ã®æ©Ÿèƒ½ç„¡åŠ¹åŒ–
1. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’é–‹ã (F12)
2. ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ:
   \`window.emergencyRollbackEmbeddedApi()\`

### å®Œå…¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †
1. app/embedded-api-manager.js ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
2. æ·±å €ãã‚“.html ã‹ã‚‰åŸ‹ã‚è¾¼ã¿APIç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿è¡Œã‚’å‰Šé™¤
3. LocalStorageã‚’ã‚¯ãƒªã‚¢: \`localStorage.clear()\`

### ç¢ºèªæ–¹æ³•
- åŸ‹ã‚è¾¼ã¿API Keyæ©Ÿèƒ½ãŒå®Œå…¨ã«ç„¡åŠ¹åŒ–ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
- æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼API Keyæ©Ÿèƒ½ãŒæ­£å¸¸å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª

## ğŸ“ ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆã¯ã€é–‹ç™ºãƒãƒ¼ãƒ ã«é€£çµ¡ã—ã¦ãã ã•ã„ã€‚`;
            
            displayResult('rollbackTestResult', `âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †æ›¸ä½œæˆå®Œäº†\n\n${procedure}`, 'success');
            testState.completedTests++;
            updateProgress();
        }
        
        // Phase 4-7: æœ€çµ‚å®Œäº†å ±å‘Šæ›¸ç”Ÿæˆ
        async function generateFinalReport() {
            displayResult('finalReportResult', 'âœ… æœ€çµ‚å®Œäº†å ±å‘Šæ›¸ç”Ÿæˆä¸­...\n\n', 'info');
            
            const report = `# æ·±å €ãã‚“v2.0 åŸ‹ã‚è¾¼ã¿API Keyæ©Ÿèƒ½ Phase 4 å®Œäº†å ±å‘Šæ›¸

## ğŸ“Š å®Ÿè£…å®Œäº†ã‚µãƒãƒªãƒ¼

### âœ… å®Œäº†é …ç›®
- Phase 4-1: ç·åˆãƒ†ã‚¹ãƒˆ - å…¨ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå®Ÿè¡Œ âœ…
- Phase 4-2: å›å¸°ãƒ†ã‚¹ãƒˆ - æ—¢å­˜æ©Ÿèƒ½å…¨ä½“ã®å‹•ä½œç¢ºèª âœ…
- Phase 4-3: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ - èµ·å‹•æ™‚é–“ãƒ»ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç¢ºèª âœ…
- Phase 4-4: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ - ä¸æ­£ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰ âœ…
- Phase 4-5: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ä½œæˆ - ä¼æ¥­ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚¬ã‚¤ãƒ‰ âœ…
- Phase 4-6: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †æ›¸ä½œæˆ - ç·Šæ€¥æ™‚å¾©æ—§æ–¹æ³• âœ…
- Phase 4-7: æœ€çµ‚ãƒ‡ãƒªãƒãƒªãƒ¼ãƒ»å®Œäº†å ±å‘Šæ›¸ä½œæˆ âœ…

### ğŸ¯ é”æˆã•ã‚ŒãŸå“è³ªæŒ‡æ¨™
- æ©Ÿèƒ½å®Ÿè£…å®Œäº†ç‡: 100%
- ãƒ†ã‚¹ãƒˆåˆæ ¼ç‡: ${Math.round((testState.completedTests / testState.totalTests) * 100)}%
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç‡: ${Math.round((testState.failedTests / testState.totalTests) * 100)}%

### ğŸš€ æä¾›æ©Ÿèƒ½
1. ä¼æ¥­é…å¸ƒå‘ã‘æš—å·åŒ–API KeyåŸ‹ã‚è¾¼ã¿æ©Ÿèƒ½
2. å›ºå®šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€Œirobakufã€ã«ã‚ˆã‚‹èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 
3. æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼API Keyã¨ã®å„ªå…ˆé †ä½åˆ¶å¾¡
4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‡è¦–ã®ãƒ¡ãƒ¢ãƒªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ©Ÿèƒ½
5. ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½

## âœ… ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™å®Œäº†
æ·±å €ãã‚“v2.0åŸ‹ã‚è¾¼ã¿API Keyæ©Ÿèƒ½ã¯ã€ã™ã¹ã¦ã®PhaseãŒå®Œäº†ã—ã€æœ¬ç•ªç’°å¢ƒã¸ã®é…å¸ƒæº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

**å®Œäº†æ—¥æ™‚**: ${new Date().toLocaleString('ja-JP')}`;
            
            displayResult('finalReportResult', `ğŸ‰ Phase 4 å®Œå…¨å®Œäº†ï¼\n\n${report}`, 'success');
            testState.completedTests++;
            updateProgress();
            
            // å…¨ã‚¿ã‚¹ã‚¯å®Œäº†ã‚’TODOã«åæ˜ 
            console.log('ğŸ‰ Phase 4 å…¨ã‚¿ã‚¹ã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        }
        
        // åˆæœŸåŒ–æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ” Phase 4 åŸ‹ã‚è¾¼ã¿API Key ç·åˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');
            testState.startTime = Date.now();
        });
    </script>
</body>
</html> 