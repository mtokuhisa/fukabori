<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 1 ç·¨é›†åŒæœŸãƒ†ã‚¹ãƒˆ - æ·±å €ãã‚“v2.0</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .test-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px 0;
        }
        .status-pass { background: #d4edda; color: #155724; }
        .status-fail { background: #f8d7da; color: #721c24; }
        .status-running { background: #fff3cd; color: #856404; }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover { background: #0056b3; }
        .button.danger { background: #dc3545; }
        .button.danger:hover { background: #a71e2a; }
        .state-display {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Phase 1 ç·¨é›†åŒæœŸãƒ†ã‚¹ãƒˆ</h1>
    <p>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—èµ·ã“ã—ç·¨é›†æ©Ÿèƒ½ã®çŠ¶æ…‹åŒæœŸã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>

    <!-- ãƒ†ã‚¹ãƒˆåˆ¶å¾¡ãƒ‘ãƒãƒ« -->
    <div class="test-container">
        <div class="test-title">ğŸ“‹ ãƒ†ã‚¹ãƒˆåˆ¶å¾¡ãƒ‘ãƒãƒ«</div>
        <button class="button" onclick="runAllTests()">å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button class="button" onclick="runEditSyncTest()">ç·¨é›†åŒæœŸãƒ†ã‚¹ãƒˆ</button>
        <button class="button" onclick="runProtectionTest()">ä¿è­·æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</button>
        <button class="button" onclick="runRollbackTest()">ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</button>
        <button class="button danger" onclick="emergencyReset()">ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="button" onclick="showSystemDiagnostics()">ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­</button>
    </div>

    <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤º -->
    <div class="test-container">
        <div class="test-title">ğŸ” ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</div>
        <div id="system-status" class="state-display">åˆæœŸåŒ–ä¸­...</div>
        <button class="button" onclick="updateSystemStatus()">çŠ¶æ…‹æ›´æ–°</button>
    </div>

    <!-- ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º -->
    <div class="test-container">
        <div class="test-title">ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ</div>
        <div id="test-results"></div>
    </div>

    <!-- ãƒ­ã‚°å‡ºåŠ› -->
    <div class="test-container">
        <div class="test-title">ğŸ“ å®Ÿè¡Œãƒ­ã‚°</div>
        <div id="log-output" class="log-output"></div>
        <button class="button" onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    </div>

    <script>
        // =================================================================================
        // Phase 1 çµ±åˆãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ 
        // =================================================================================

        let testResults = {};
        let testLog = [];

        /**
         * ãƒ­ã‚°å‡ºåŠ›æ©Ÿèƒ½
         */
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const logOutput = document.getElementById('log-output');
            logOutput.innerHTML = testLog.join('\n');
            logOutput.scrollTop = logOutput.scrollHeight;
            
            console.log(message);
        }

        /**
         * ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤ºæ›´æ–°
         */
        function updateTestResults() {
            const resultsDiv = document.getElementById('test-results');
            let html = '';
            
            Object.entries(testResults).forEach(([testName, result]) => {
                const statusClass = result.passed ? 'status-pass' : 'status-fail';
                const statusText = result.passed ? 'PASS' : 'FAIL';
                
                html += `
                    <div class="test-status ${statusClass}">
                        ${testName}: ${statusText}
                        ${result.message ? ` - ${result.message}` : ''}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        /**
         * ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤ºæ›´æ–°
         */
        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            
            const status = {
                timestamp: new Date().toISOString(),
                appState: {
                    exists: !!window.AppState,
                    currentTranscript: window.AppState?.currentTranscript || '',
                    transcriptHistoryLength: window.AppState?.transcriptHistory?.length || 0
                },
                editManager: {
                    exists: !!window.transcriptEditManager,
                    isEditing: window.transcriptEditManager?.isEditing || false
                },
                stateController: {
                    exists: !!window.StateUpdateController
                },
                protectionManager: {
                    exists: !!window.TranscriptProtectionManager
                },
                emergencyManager: {
                    exists: !!window.EmergencySystemManager,
                    backupCount: window.EmergencySystemManager?.backupHistory?.length || 0
                }
            };
            
            statusDiv.textContent = JSON.stringify(status, null, 2);
        }

        /**
         * ç·¨é›†åŒæœŸãƒ†ã‚¹ãƒˆ
         */
        async function runEditSyncTest() {
            log('ğŸ§ª ç·¨é›†åŒæœŸãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            try {
                // åˆæœŸçŠ¶æ…‹è¨­å®š
                if (!window.AppState) {
                    window.AppState = {
                        currentTranscript: '',
                        transcriptHistory: []
                    };
                }
                
                // ãƒ†ã‚¹ãƒˆç”¨ã®åˆæœŸãƒ‡ãƒ¼ã‚¿è¨­å®š
                const originalText = 'ãƒ†ã‚¹ãƒˆç”¨ã®å…ƒã®æ–‡ç« ã§ã™';
                const editedText = 'ãƒ†ã‚¹ãƒˆç”¨ã®ç·¨é›†å¾Œæ–‡ç« ã§ã™';
                
                window.AppState.currentTranscript = originalText;
                window.AppState.transcriptHistory = [originalText];
                
                log(`åˆæœŸçŠ¶æ…‹è¨­å®š: "${originalText}"`);
                
                // ãƒ¢ãƒƒã‚¯ã®ç·¨é›†ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ä½œæˆ
                if (!window.transcriptEditManager) {
                    window.transcriptEditManager = {
                        isEditing: false,
                        transcriptDisplay: { textContent: originalText },
                        finishEditing: async function(newText) {
                            log('ãƒ¢ãƒƒã‚¯ç·¨é›†å®Œäº†å‡¦ç†å®Ÿè¡Œ');
                            
                            // Phase 1Aã®çŠ¶æ…‹åŒæœŸã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                            if (window.StateUpdateController) {
                                return window.StateUpdateController.atomicStateUpdate('edit', {
                                    'AppState': () => {
                                        window.AppState.currentTranscript = newText;
                                        window.AppState.transcriptHistory = [newText];
                                        log(`AppStateæ›´æ–°: "${newText}"`);
                                    }
                                });
                            }
                            return true;
                        }
                    };
                }
                
                // ç·¨é›†å®Œäº†å‡¦ç†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                await window.transcriptEditManager.finishEditing(editedText);
                
                // çµæœæ¤œè¨¼
                const currentTranscript = window.AppState.currentTranscript;
                const transcriptHistory = window.AppState.transcriptHistory;
                
                const passed = currentTranscript === editedText && 
                              transcriptHistory.length === 1 && 
                              transcriptHistory[0] === editedText;
                
                testResults['ç·¨é›†åŒæœŸãƒ†ã‚¹ãƒˆ'] = {
                    passed,
                    message: passed ? 
                        'çŠ¶æ…‹åŒæœŸæˆåŠŸ' : 
                        `å¤±æ•—: current="${currentTranscript}", history=[${transcriptHistory.join(',')}]`
                };
                
                log(passed ? 'âœ… ç·¨é›†åŒæœŸãƒ†ã‚¹ãƒˆæˆåŠŸ' : 'âŒ ç·¨é›†åŒæœŸãƒ†ã‚¹ãƒˆå¤±æ•—');
                
            } catch (error) {
                log(`âŒ ç·¨é›†åŒæœŸãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                testResults['ç·¨é›†åŒæœŸãƒ†ã‚¹ãƒˆ'] = { passed: false, message: error.message };
            }
            
            updateTestResults();
        }

        /**
         * ä¿è­·æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
         */
        async function runProtectionTest() {
            log('ğŸ§ª ä¿è­·æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            try {
                // ç·¨é›†ä¸­çŠ¶æ…‹ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                if (window.transcriptEditManager) {
                    window.transcriptEditManager.isEditing = true;
                    log('ç·¨é›†ä¸­çŠ¶æ…‹ã«è¨­å®š');
                }
                
                // ä¿è­·æ©Ÿèƒ½ãƒã‚§ãƒƒã‚¯
                const shouldPrevent = window.TranscriptProtectionManager ? 
                    window.TranscriptProtectionManager.constructor.shouldPreventVoiceUpdate('test') : 
                    false;
                
                // ç·¨é›†çŠ¶æ…‹è§£é™¤
                if (window.transcriptEditManager) {
                    window.transcriptEditManager.isEditing = false;
                }
                
                testResults['ä¿è­·æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ'] = {
                    passed: shouldPrevent,
                    message: shouldPrevent ? 'ç·¨é›†ä¸­ã®ä¿è­·æ­£å¸¸' : 'ä¿è­·æ©Ÿèƒ½æœªå‹•ä½œ'
                };
                
                log(shouldPrevent ? 'âœ… ä¿è­·æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆæˆåŠŸ' : 'âŒ ä¿è­·æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå¤±æ•—');
                
            } catch (error) {
                log(`âŒ ä¿è­·æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                testResults['ä¿è­·æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ'] = { passed: false, message: error.message };
            }
            
            updateTestResults();
        }

        /**
         * ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
         */
        async function runRollbackTest() {
            log('ğŸ§ª ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            try {
                if (!window.EmergencySystemManager) {
                    throw new Error('EmergencySystemManagerãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                }
                
                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
                const backupId = window.EmergencySystemManager.createFullSystemBackup('test');
                log(`ãƒ†ã‚¹ãƒˆç”¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ: ${backupId}`);
                
                // çŠ¶æ…‹ã‚’å¤‰æ›´
                const originalTranscript = window.AppState?.currentTranscript || '';
                if (window.AppState) {
                    window.AppState.currentTranscript = 'ãƒ†ã‚¹ãƒˆç”¨å¤‰æ›´ãƒ‡ãƒ¼ã‚¿';
                    log('çŠ¶æ…‹ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
                }
                
                // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
                const rollbackSuccess = window.EmergencySystemManager.emergencyRollback(backupId);
                
                // çµæœæ¤œè¨¼
                const restoredTranscript = window.AppState?.currentTranscript || '';
                const passed = rollbackSuccess && restoredTranscript === originalTranscript;
                
                testResults['ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ'] = {
                    passed,
                    message: passed ? 'ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸ' : `å¤±æ•—: ${restoredTranscript}`
                };
                
                log(passed ? 'âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆæˆåŠŸ' : 'âŒ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå¤±æ•—');
                
            } catch (error) {
                log(`âŒ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                testResults['ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ'] = { passed: false, message: error.message };
            }
            
            updateTestResults();
        }

        /**
         * å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
         */
        async function runAllTests() {
            log('ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹');
            testResults = {};
            
            await runEditSyncTest();
            await runProtectionTest();
            await runRollbackTest();
            
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(r => r.passed).length;
            
            log(`ğŸ“Š ãƒ†ã‚¹ãƒˆå®Œäº†: ${passedTests}/${totalTests} passed`);
            
            if (passedTests === totalTests) {
                log('ğŸ‰ å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸï¼Phase 1å®Ÿè£…å®Œäº†');
            } else {
                log('âš ï¸ ä¸€éƒ¨ãƒ†ã‚¹ãƒˆå¤±æ•— - ä¿®æ­£ãŒå¿…è¦ã§ã™');
            }
        }

        /**
         * ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­è¡¨ç¤º
         */
        function showSystemDiagnostics() {
            if (window.systemDiagnostics) {
                const diagnostics = window.systemDiagnostics();
                log('ğŸ” ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­å®Ÿè¡Œå®Œäº†');
                console.log('è¨ºæ–­çµæœ:', diagnostics);
            } else {
                log('âŒ ã‚·ã‚¹ãƒ†ãƒ è¨ºæ–­æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
            }
        }

        /**
         * ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆ
         */
        function emergencyReset() {
            if (window.completeReset) {
                window.completeReset();
                log('ğŸš¨ ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ');
                updateSystemStatus();
            } else {
                log('âŒ ç·Šæ€¥ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
            }
        }

        /**
         * ãƒ­ã‚°ã‚¯ãƒªã‚¢
         */
        function clearLog() {
            testLog = [];
            document.getElementById('log-output').innerHTML = '';
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ“‹ Phase 1 çµ±åˆãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            updateSystemStatus();
            
            // 2ç§’å¾Œã«è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            setTimeout(() => {
                log('â° è‡ªå‹•ãƒ†ã‚¹ãƒˆé–‹å§‹');
                runAllTests();
            }, 2000);
        });
    </script>
</body>
</html> 