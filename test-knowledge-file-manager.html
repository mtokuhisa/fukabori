<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê∑±Â†Ä„Åè„Çìv2.0 - Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠ò„ÉÜ„Çπ„Éà„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-active {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-inactive {
            background: #dc3545;
        }

        .status-warning {
            background: #ffc107;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .btn-copy {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .results-section {
            margin-top: 30px;
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #4facfe;
        }

        .grade-A {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .grade-B {
            border-left-color: #17a2b8;
            background: #d1ecf1;
        }

        .grade-C {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .grade-D {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4facfe;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #4a5568;
        }

        .log-timestamp {
            color: #9ca3af;
            font-size: 0.8rem;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            border: 1px solid transparent;
        }

        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .recommendations {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .recommendations h4 {
            color: #004085;
            margin-bottom: 15px;
        }

        .recommendations ul {
            list-style: none;
            padding: 0;
        }

        .recommendations li {
            padding: 5px 0;
            color: #004085;
        }

        .recommendations li:before {
            content: "üí° ";
            margin-right: 10px;
        }

        .copy-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .copy-text {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e9ecef;
        }

        .footer p {
            color: #6c757d;
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß™ Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠ò„ÉÜ„Çπ„Éà„Ç∑„Çπ„ÉÜ„É†</h1>
            <p>Ê∑±Â†Ä„Åè„Çìv2.0 - „É¶„Éº„Ç∂„Éº„Éï„É¨„É≥„Éâ„É™„Éº„ÉÜ„Çπ„Éà„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ</p>
        </div>

        <div class="main-content">
            <!-- „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ -->
            <div class="dashboard">
                <div class="card">
                    <h3>üîç „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã</h3>
                    <div class="status-indicator">
                        <div class="status-dot status-inactive" id="sessionStatus"></div>
                        <span id="sessionStatusText">„Çª„ÉÉ„Ç∑„Éß„É≥Êú™ÈñãÂßã</span>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot status-inactive" id="recognitionStatus"></div>
                        <span id="recognitionStatusText">Èü≥Â£∞Ë™çË≠òÊú™ÂàùÊúüÂåñ</span>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot status-inactive" id="continuousStatus"></div>
                        <span id="continuousStatusText">Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠òÂÅúÊ≠¢‰∏≠</span>
                    </div>
                </div>

                <div class="card">
                    <h3>‚ö° ÁèæÂú®„ÅÆÁµ±Ë®à</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="startCountStat">0</div>
                            <div class="stat-label">start()Âëº„Å≥Âá∫„Åó</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="efficiencyStat">0%</div>
                            <div class="stat-label">ÂäπÁéáÊÄß</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- „ÉÜ„Çπ„ÉàÂÆüË°å„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="card">
                <h3>üöÄ „ÉÜ„Çπ„ÉàÂÆüË°å</h3>
                <p style="margin-bottom: 20px;">Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠ò„ÅÆÂìÅË≥™„ÇíËá™ÂãïÊ∏¨ÂÆö„Åó„Åæ„Åô„ÄÇ„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÂæå„Å´ÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                
                <div>
                    <button class="btn" id="checkStatusBtn" onclick="checkSystemStatus()">
                        üîç „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÁ¢∫Ë™ç
                    </button>
                    <button class="btn btn-success" id="startTestBtn" onclick="startContinuousTest()" disabled>
                        üß™ Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠ò„ÉÜ„Çπ„ÉàÈñãÂßã
                    </button>
                    <button class="btn btn-warning" id="quickTestBtn" onclick="startQuickTest()" disabled>
                        ‚ö° „ÇØ„Ç§„ÉÉ„ÇØ„ÉÜ„Çπ„ÉàÔºà30ÁßíÔºâ
                    </button>
                    <button class="btn btn-danger" id="stopTestBtn" onclick="stopTest()" disabled>
                        üõë „ÉÜ„Çπ„ÉàÂÅúÊ≠¢
                    </button>
                </div>

                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">„ÉÜ„Çπ„ÉàÊ∫ñÂÇô‰∏≠...</div>
                </div>
            </div>

            <!-- „ÉÜ„Çπ„ÉàÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="results-section" id="resultsSection" style="display: none;">
                <div class="card">
                    <h3>üìä „ÉÜ„Çπ„ÉàÁµêÊûú</h3>
                    <div class="result-card" id="resultCard">
                        <div class="stats-grid" id="resultsStats">
                            <!-- ÁµêÊûúÁµ±Ë®à„ÅåÂãïÁöÑ„Å´ÊåøÂÖ•„Åï„Çå„Çã -->
                        </div>
                        <div id="gradeDisplay"></div>
                        <div id="alertsDisplay"></div>
                    </div>
                </div>

                <!-- Êé®Â•®‰∫ãÈ†Ö -->
                <div class="recommendations" id="recommendationsSection" style="display: none;">
                    <h4>üí° Êé®Â•®‰∫ãÈ†Ö</h4>
                    <ul id="recommendationsList">
                        <!-- Êé®Â•®‰∫ãÈ†Ö„ÅåÂãïÁöÑ„Å´ÊåøÂÖ•„Åï„Çå„Çã -->
                    </ul>
                </div>

                <!-- ÁµêÊûú„Ç≥„Éî„ÉºÊ©üËÉΩ -->
                <div class="copy-container">
                    <h4>üìã ÁµêÊûú„Ç≥„Éî„ÉºÔºàÂ†±ÂëäÁî®Ôºâ</h4>
                    <div class="copy-text" id="copyText">
                        „ÉÜ„Çπ„ÉàÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô...
                    </div>
                    <button class="btn btn-copy" onclick="copyResults()">
                        üìã ÁµêÊûú„Çí„Ç≥„Éî„Éº
                    </button>
                </div>
            </div>

            <!-- „É™„Ç¢„É´„Çø„Ç§„É†„É≠„Ç∞ -->
            <div class="card">
                <h3>üìù „É™„Ç¢„É´„Çø„Ç§„É†„É≠„Ç∞</h3>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-timestamp">[Ëµ∑ÂãïÊôÇÂàª]</span>
                        „ÉÜ„Çπ„Éà„Ç∑„Çπ„ÉÜ„É†„ÅåÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Ê∑±Â†Ä„Åè„Çìv2.0 Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠ò„ÉÜ„Çπ„Éà„Ç∑„Çπ„ÉÜ„É†</p>
            <p>UI„Éï„Ç°„Éº„Çπ„Éà„Éª„ÉÜ„Çπ„ÉàÊà¶Áï•„Å´„Çà„Çä„ÄÅÁ∞°ÂçòÊìç‰Ωú„ÅßË©≥Á¥∞„Å™„ÉÜ„Çπ„ÉàÁµêÊûú„ÇíÂèñÂæó„Åß„Åç„Åæ„Åô</p>
        </div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentTest = null;
        let testStartTime = null;
        let progressInterval = null;
        let logUpdateInterval = null;

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            addLog('„ÉÜ„Çπ„Éà„Ç∑„Çπ„ÉÜ„É†„ÅåÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü');
            updateSystemStatus();
            
            // ÂÆöÊúüÁöÑ„Å´„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÇíÊõ¥Êñ∞
            setInterval(updateSystemStatus, 5000);
        });

        // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÁ¢∫Ë™ç
        function checkSystemStatus() {
            addLog('„Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÇíÁ¢∫Ë™ç‰∏≠...');
            
            try {
                // Ë¶™„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
                const parentWindow = window.parent;
                const sessionActive = parentWindow.AppState?.sessionActive;
                const recognitionManager = parentWindow.stateManager?.recognitionManager;
                
                updateStatusDisplay(sessionActive, recognitionManager);
                
                if (sessionActive && recognitionManager) {
                    addLog('‚úÖ „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã: „ÉÜ„Çπ„ÉàÂÆüË°åÂèØËÉΩ');
                    enableTestButtons();
                } else {
                    addLog('‚ùå „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã: „ÉÜ„Çπ„ÉàÂÆüË°å‰∏çÂèØ');
                    if (!sessionActive) {
                        addLog('üí° „Çª„ÉÉ„Ç∑„Éß„É≥Êú™ÈñãÂßã: „É≠„Ç∞„Ç§„É≥‚Üí„Éï„Ç°„Ç§„É´ÈÅ∏Êäû‚Üí„ÉÜ„Éº„ÉûË®≠ÂÆö‚Üí„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã');
                    }
                    disableTestButtons();
                }
            } catch (error) {
                addLog('‚ùå „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãÁ¢∫Ë™ç„Ç®„É©„Éº: ' + error.message);
                disableTestButtons();
            }
        }

        // „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖãË°®Á§∫Êõ¥Êñ∞
        function updateSystemStatus() {
            try {
                const parentWindow = window.parent;
                const sessionActive = parentWindow.AppState?.sessionActive;
                const recognitionManager = parentWindow.stateManager?.recognitionManager;
                
                updateStatusDisplay(sessionActive, recognitionManager);
                updateCurrentStats();
                
                if (sessionActive && recognitionManager) {
                    enableTestButtons();
                } else {
                    disableTestButtons();
                }
            } catch (error) {
                // Ë¶™„Ç¶„Ç£„É≥„Éâ„Ç¶„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            }
        }

        // Áä∂ÊÖãË°®Á§∫Êõ¥Êñ∞
        function updateStatusDisplay(sessionActive, recognitionManager) {
            const sessionStatusEl = document.getElementById('sessionStatus');
            const sessionStatusTextEl = document.getElementById('sessionStatusText');
            const recognitionStatusEl = document.getElementById('recognitionStatus');
            const recognitionStatusTextEl = document.getElementById('recognitionStatusText');
            
            if (sessionActive) {
                sessionStatusEl.className = 'status-dot status-active';
                sessionStatusTextEl.textContent = '„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÊ∏à„Åø';
            } else {
                sessionStatusEl.className = 'status-dot status-inactive';
                sessionStatusTextEl.textContent = '„Çª„ÉÉ„Ç∑„Éß„É≥Êú™ÈñãÂßã';
            }
            
            if (recognitionManager) {
                recognitionStatusEl.className = 'status-dot status-active';
                recognitionStatusTextEl.textContent = 'Èü≥Â£∞Ë™çË≠ò„Ç∑„Çπ„ÉÜ„É†Âãï‰Ωú‰∏≠';
            } else {
                recognitionStatusEl.className = 'status-dot status-inactive';
                recognitionStatusTextEl.textContent = 'Èü≥Â£∞Ë™çË≠òÊú™ÂàùÊúüÂåñ';
            }
        }

        // ÁèæÂú®„ÅÆÁµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
        function updateCurrentStats() {
            try {
                const parentWindow = window.parent;
                const recognitionManager = parentWindow.stateManager?.recognitionManager;
                
                if (recognitionManager && recognitionManager.getMicrophonePermissionStats) {
                    const stats = recognitionManager.getMicrophonePermissionStats();
                    document.getElementById('startCountStat').textContent = stats.startCount || 0;
                    document.getElementById('efficiencyStat').textContent = 
                        (stats.efficiency === Infinity ? '‚àû' : stats.efficiency || 0) + '%';
                }
            } catch (error) {
                // „Ç®„É©„Éº„ÅØÁÑ°Ë¶ñ
            }
        }

        // „ÉÜ„Çπ„Éà„Éú„Çø„É≥„ÅÆÊúâÂäπÂåñ
        function enableTestButtons() {
            document.getElementById('startTestBtn').disabled = false;
            document.getElementById('quickTestBtn').disabled = false;
        }

        // „ÉÜ„Çπ„Éà„Éú„Çø„É≥„ÅÆÁÑ°ÂäπÂåñ
        function disableTestButtons() {
            document.getElementById('startTestBtn').disabled = true;
            document.getElementById('quickTestBtn').disabled = true;
        }

        // Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠ò„ÉÜ„Çπ„ÉàÈñãÂßã
        function startContinuousTest() {
            startTest(300000); // 5ÂàÜÈñì
        }

        // „ÇØ„Ç§„ÉÉ„ÇØ„ÉÜ„Çπ„ÉàÈñãÂßã
        function startQuickTest() {
            startTest(30000); // 30ÁßíÈñì
        }

        // „ÉÜ„Çπ„ÉàÈñãÂßã
        function startTest(duration) {
            if (currentTest) {
                addLog('‚ö†Ô∏è Êó¢„Å´„ÉÜ„Çπ„ÉàÂÆüË°å‰∏≠„Åß„Åô');
                return;
            }

            try {
                const parentWindow = window.parent;
                const sessionActive = parentWindow.AppState?.sessionActive;
                
                if (!sessionActive) {
                    addLog('‚ùå „Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÈñãÂßã„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                    showAlert('„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÈñãÂßã„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ„É≠„Ç∞„Ç§„É≥‚Üí„Éï„Ç°„Ç§„É´ÈÅ∏Êäû‚Üí„ÉÜ„Éº„ÉûË®≠ÂÆö‚Üí„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã„ÅÆÊâãÈ†Ü„ÇíÂÆå‰∫Ü„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'warning');
                    return;
                }

                // „ÉÜ„Çπ„ÉàÈñãÂßã
                const success = parentWindow.continuousRecognitionTester.startAutoTest(duration);
                
                if (success) {
                    currentTest = {
                        startTime: Date.now(),
                        duration: duration
                    };
                    
                    addLog(`üß™ „ÉÜ„Çπ„ÉàÈñãÂßã: ${duration/1000}ÁßíÈñì„ÅÆÁ∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠ò„ÉÜ„Çπ„Éà`);
                    startProgressMonitoring(duration);
                    
                    // „Éú„Çø„É≥Áä∂ÊÖãÊõ¥Êñ∞
                    document.getElementById('startTestBtn').disabled = true;
                    document.getElementById('quickTestBtn').disabled = true;
                    document.getElementById('stopTestBtn').disabled = false;
                    
                    // ÈÄ≤ÊçóË°®Á§∫
                    document.getElementById('progressContainer').style.display = 'block';
                    
                    // „ÉÜ„Çπ„ÉàÁµÇ‰∫Ü„ÅÆÁõ£Ë¶ñ
                    setTimeout(() => {
                        if (currentTest) {
                            finishTest();
                        }
                    }, duration + 1000);
                } else {
                    addLog('‚ùå „ÉÜ„Çπ„ÉàÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                addLog('‚ùå „ÉÜ„Çπ„ÉàÈñãÂßã„Ç®„É©„Éº: ' + error.message);
                showAlert('„ÉÜ„Çπ„ÉàÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'danger');
            }
        }

        // „ÉÜ„Çπ„ÉàÂÅúÊ≠¢
        function stopTest() {
            if (!currentTest) {
                addLog('‚ö†Ô∏è ÂÆüË°å‰∏≠„ÅÆ„ÉÜ„Çπ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                return;
            }

            try {
                const parentWindow = window.parent;
                const success = parentWindow.continuousRecognitionTester.stopAutoTest();
                
                if (success) {
                    addLog('üõë „ÉÜ„Çπ„Éà„ÇíÊâãÂãïÂÅúÊ≠¢„Åó„Åæ„Åó„Åü');
                    finishTest();
                } else {
                    addLog('‚ùå „ÉÜ„Çπ„ÉàÂÅúÊ≠¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            } catch (error) {
                addLog('‚ùå „ÉÜ„Çπ„ÉàÂÅúÊ≠¢„Ç®„É©„Éº: ' + error.message);
            }
        }

        // ÈÄ≤ÊçóÁõ£Ë¶ñÈñãÂßã
        function startProgressMonitoring(duration) {
            const startTime = Date.now();
            
            progressInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min((elapsed / duration) * 100, 100);
                
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = 
                    `„ÉÜ„Çπ„ÉàÈÄ≤Ë°å‰∏≠: ${Math.floor(elapsed/1000)}Áßí / ${Math.floor(duration/1000)}Áßí (${Math.floor(progress)}%)`;
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                }
            }, 1000);
        }

        // „ÉÜ„Çπ„ÉàÁµÇ‰∫ÜÂá¶ÁêÜ
        function finishTest() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
            currentTest = null;
            
            // „Éú„Çø„É≥Áä∂ÊÖãÂæ©ÂÖÉ
            document.getElementById('startTestBtn').disabled = false;
            document.getElementById('quickTestBtn').disabled = false;
            document.getElementById('stopTestBtn').disabled = true;
            
            // ÈÄ≤Êçó„Éê„ÉºÈùûË°®Á§∫
            document.getElementById('progressContainer').style.display = 'none';
            
            // „ÉÜ„Çπ„ÉàÁµêÊûúË°®Á§∫
            setTimeout(() => {
                displayTestResults();
            }, 1000);
            
            addLog('‚úÖ „ÉÜ„Çπ„ÉàÂÆå‰∫Ü');
        }

        // „ÉÜ„Çπ„ÉàÁµêÊûúË°®Á§∫
        function displayTestResults() {
            try {
                const parentWindow = window.parent;
                const recognitionManager = parentWindow.stateManager?.recognitionManager;
                
                if (!recognitionManager) {
                    addLog('‚ùå ÁµêÊûúÂèñÂæóÂ§±Êïó: Èü≥Â£∞Ë™çË≠ò„Ç∑„Çπ„ÉÜ„É†„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì');
                    return;
                }
                
                const stats = recognitionManager.getMicrophonePermissionStats();
                const analysis = analyzeResults(stats);
                
                // ÁµêÊûúË°®Á§∫
                showResults(analysis, stats);
                
                // „Ç≥„Éî„ÉºÁî®„ÉÜ„Ç≠„Çπ„ÉàÁîüÊàê
                generateCopyText(analysis, stats);
                
                addLog('üìä „ÉÜ„Çπ„ÉàÁµêÊûú„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü');
                
            } catch (error) {
                addLog('‚ùå ÁµêÊûúË°®Á§∫„Ç®„É©„Éº: ' + error.message);
                showAlert('ÁµêÊûúË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message, 'danger');
            }
        }

        // ÁµêÊûúÂàÜÊûê
        function analyzeResults(stats) {
            const analysis = {
                grade: 'N/A',
                passed: false,
                issues: [],
                recommendations: []
            };
            
            // ÂäπÁéáÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
            if (stats.efficiency >= 95) {
                analysis.grade = 'A+ (ÂÑ™ÁßÄ)';
                analysis.passed = true;
            } else if (stats.efficiency >= 85) {
                analysis.grade = 'A (ËâØÂ•Ω)';
                analysis.passed = true;
            } else if (stats.efficiency >= 70) {
                analysis.grade = 'B (ÊôÆÈÄö)';
                analysis.passed = true;
            } else if (stats.efficiency >= 50) {
                analysis.grade = 'C (Ë¶ÅÊîπÂñÑ)';
                analysis.passed = false;
                analysis.issues.push('ÂäπÁéáÊÄß„Åå‰Ωé„ÅÑ');
            } else {
                analysis.grade = 'D (ÂïèÈ°å„ÅÇ„Çä)';
                analysis.passed = false;
                analysis.issues.push('ÂäπÁéáÊÄß„ÅåÊ•µ„ÇÅ„Å¶‰Ωé„ÅÑ');
            }
            
            // start()ÂõûÊï∞„ÉÅ„Çß„ÉÉ„ÇØ
            if (stats.startCount > 5) {
                analysis.issues.push('start()Âëº„Å≥Âá∫„Åó„ÅåÂ§ö„Åô„Åé„Çã');
            }
            
            // Êé®Â•®‰∫ãÈ†ÖÁîüÊàê
            if (analysis.passed) {
                analysis.recommendations.push('Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠ò„ÅØÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô');
                if (stats.efficiency === 100) {
                    analysis.recommendations.push('ÂÆåÁíß„Å™ÂäπÁéáÊÄß„ÇíÈÅîÊàê„Åó„Åæ„Åó„ÅüÔºÅ');
                }
            } else {
                if (stats.startCount > 3) {
                    analysis.recommendations.push('start()Âëº„Å≥Âá∫„Åó„ÅåÂ§ö„Åô„Åé„Åæ„Åô - Êà¶Áï•Ë¶ãÁõ¥„Åó„ÅåÂøÖË¶Å');
                }
                if (stats.efficiency < 70) {
                    analysis.recommendations.push('ÂäπÁéáÊÄß„Åå‰Ωé„ÅÑ„Åß„Åô - „Éû„Ç§„ÇØË®±ÂèØË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                }
            }
            
            return analysis;
        }

        // ÁµêÊûúË°®Á§∫
        function showResults(analysis, stats) {
            const resultsSection = document.getElementById('resultsSection');
            const resultCard = document.getElementById('resultCard');
            const resultsStats = document.getElementById('resultsStats');
            const gradeDisplay = document.getElementById('gradeDisplay');
            const alertsDisplay = document.getElementById('alertsDisplay');
            
            // Áµ±Ë®àÊÉÖÂ†±Ë°®Á§∫
            resultsStats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${stats.startCount || 0}</div>
                    <div class="stat-label">start()Âëº„Å≥Âá∫„Åó</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.microphonePermissionRequests || 0}</div>
                    <div class="stat-label">„Éû„Ç§„ÇØË®±ÂèØË¶ÅÊ±Ç</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.efficiency === Infinity ? '‚àû' : stats.efficiency || 0}%</div>
                    <div class="stat-label">ÂäπÁéáÊÄß</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.continuousRecognition ? '‚úÖ' : '‚ùå'}</div>
                    <div class="stat-label">Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠ò</div>
                </div>
            `;
            
            // „Ç∞„É¨„Éº„ÉâË°®Á§∫
            const gradeClass = analysis.grade.includes('A') ? 'grade-A' : 
                             analysis.grade.includes('B') ? 'grade-B' : 
                             analysis.grade.includes('C') ? 'grade-C' : 'grade-D';
            
            resultCard.className = `result-card ${gradeClass}`;
            gradeDisplay.innerHTML = `
                <h4>üéØ ÂìÅË≥™„Ç∞„É¨„Éº„Éâ: ${analysis.grade}</h4>
                <p>„ÉÜ„Çπ„ÉàÁµêÊûú: ${analysis.passed ? '‚úÖ ÂêàÊ†º' : '‚ùå ‰∏çÂêàÊ†º'}</p>
            `;
            
            // „Ç¢„É©„Éº„ÉàË°®Á§∫
            if (analysis.issues.length > 0) {
                alertsDisplay.innerHTML = `
                    <div class="alert alert-warning">
                        <h5>‚ö†Ô∏è Ê§úÂá∫„Åï„Çå„ÅüÂïèÈ°å</h5>
                        <ul>
                            ${analysis.issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else {
                alertsDisplay.innerHTML = `
                    <div class="alert alert-success">
                        <h5>‚úÖ ÂïèÈ°å„Å™„Åó</h5>
                        <p>Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠ò„ÅØÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
                    </div>
                `;
            }
            
            // Êé®Â•®‰∫ãÈ†ÖË°®Á§∫
            if (analysis.recommendations.length > 0) {
                const recommendationsSection = document.getElementById('recommendationsSection');
                const recommendationsList = document.getElementById('recommendationsList');
                
                recommendationsList.innerHTML = analysis.recommendations
                    .map(rec => `<li>${rec}</li>`)
                    .join('');
                
                recommendationsSection.style.display = 'block';
            }
            
            resultsSection.style.display = 'block';
        }

        // „Ç≥„Éî„ÉºÁî®„ÉÜ„Ç≠„Çπ„ÉàÁîüÊàê
        function generateCopyText(analysis, stats) {
            const now = new Date();
            const timestamp = now.toLocaleString('ja-JP');
            
            const copyText = `
Ê∑±Â†Ä„Åè„Çìv2.0 Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠ò„ÉÜ„Çπ„ÉàÁµêÊûú
=====================================

ÂÆüË°åÊôÇÂàª: ${timestamp}
„ÉÜ„Çπ„ÉàÁ®ÆÂà•: Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠òÂìÅË≥™„ÉÜ„Çπ„Éà

üìä Áµ±Ë®àÊÉÖÂ†±:
- start()Âëº„Å≥Âá∫„Åó: ${stats.startCount || 0}Âõû
- „Éû„Ç§„ÇØË®±ÂèØË¶ÅÊ±Ç: ${stats.microphonePermissionRequests || 0}Âõû
- ÂäπÁéáÊÄß: ${stats.efficiency === Infinity ? '‚àû' : stats.efficiency || 0}%
- Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠ò: ${stats.continuousRecognition ? 'Âãï‰Ωú‰∏≠' : 'ÂÅúÊ≠¢‰∏≠'}
- Êà¶Áï•: ${stats.strategy || 'unknown'}

üéØ Ë©ï‰æ°ÁµêÊûú:
- ÂìÅË≥™„Ç∞„É¨„Éº„Éâ: ${analysis.grade}
- „ÉÜ„Çπ„ÉàÁµêÊûú: ${analysis.passed ? 'ÂêàÊ†º' : '‰∏çÂêàÊ†º'}

${analysis.issues.length > 0 ? `
‚ö†Ô∏è Ê§úÂá∫„Åï„Çå„ÅüÂïèÈ°å:
${analysis.issues.map(issue => `- ${issue}`).join('\n')}
` : '‚úÖ ÂïèÈ°å„Å™„Åó: Á∂ôÁ∂öÁöÑÈü≥Â£∞Ë™çË≠ò„ÅØÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ'}

${analysis.recommendations.length > 0 ? `
üí° Êé®Â•®‰∫ãÈ†Ö:
${analysis.recommendations.map(rec => `- ${rec}`).join('\n')}
` : ''}

=====================================
Ê∑±Â†Ä„Åè„Çìv2.0 UI„ÉÜ„Çπ„Éà„Ç∑„Çπ„ÉÜ„É†
„ÉÜ„Çπ„ÉàË≤†Ëç∑ËªΩÊ∏õ„ÉªËá™ÂãïÂìÅË≥™Áõ£Ë¶ñ„Ç∑„Çπ„ÉÜ„É†
            `.trim();
            
            document.getElementById('copyText').textContent = copyText;
        }

        // ÁµêÊûú„Ç≥„Éî„Éº
        function copyResults() {
            const copyText = document.getElementById('copyText').textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(copyText).then(() => {
                    addLog('üìã ÁµêÊûú„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
                    showAlert('„ÉÜ„Çπ„ÉàÁµêÊûú„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
                }).catch(err => {
                    addLog('‚ùå „Ç≥„Éî„ÉºÂ§±Êïó: ' + err.message);
                    showAlert('„Ç≥„Éî„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'danger');
                });
            } else {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
                const textArea = document.createElement('textarea');
                textArea.value = copyText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                addLog('üìã ÁµêÊûú„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü');
                showAlert('„ÉÜ„Çπ„ÉàÁµêÊûú„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
            }
        }

        // „É≠„Ç∞ËøΩÂä†
        function addLog(message) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString('ja-JP');
            const logContainer = document.getElementById('logContainer');
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                ${message}
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // „Ç¢„É©„Éº„ÉàË°®Á§∫
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
            
            // 5ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html> 