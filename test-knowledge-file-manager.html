<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±å €ãã‚“v2.0 - ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-active {
            background: #28a745;
            animation: pulse 2s infinite;
        }

        .status-inactive {
            background: #dc3545;
        }

        .status-warning {
            background: #ffc107;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .btn-copy {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .results-section {
            margin-top: 30px;
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #4facfe;
        }

        .grade-A {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .grade-B {
            border-left-color: #17a2b8;
            background: #d1ecf1;
        }

        .grade-C {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .grade-D {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #4facfe;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-top: 5px;
        }

        .log-container {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #4a5568;
        }

        .log-timestamp {
            color: #9ca3af;
            font-size: 0.8rem;
        }

        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            border: 1px solid transparent;
        }

        .alert-success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .alert-danger {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .recommendations {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .recommendations h4 {
            color: #004085;
            margin-bottom: 15px;
        }

        .recommendations ul {
            list-style: none;
            padding: 0;
        }

        .recommendations li {
            padding: 5px 0;
            color: #004085;
        }

        .recommendations li:before {
            content: "ğŸ’¡ ";
            margin-right: 10px;
        }

        .copy-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .copy-text {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e9ecef;
        }

        .footer p {
            color: #6c757d;
            margin: 5px 0;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>æ·±å €ãã‚“v2.0 - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãƒ†ã‚¹ãƒˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</p>
        </div>

        <div class="main-content">
            <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
            <div class="dashboard">
                <div class="card">
                    <h3>ğŸ” ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
                    <div class="status-indicator">
                        <div class="status-dot status-inactive" id="sessionStatus"></div>
                        <span id="sessionStatusText">ã‚»ãƒƒã‚·ãƒ§ãƒ³æœªé–‹å§‹</span>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot status-inactive" id="recognitionStatus"></div>
                        <span id="recognitionStatusText">éŸ³å£°èªè­˜æœªåˆæœŸåŒ–</span>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot status-inactive" id="continuousStatus"></div>
                        <span id="continuousStatusText">ç¶™ç¶šçš„éŸ³å£°èªè­˜åœæ­¢ä¸­</span>
                    </div>
                </div>

                <div class="card">
                    <h3>âš¡ ç¾åœ¨ã®çµ±è¨ˆ</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value" id="startCountStat">0</div>
                            <div class="stat-label">start()å‘¼ã³å‡ºã—</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="efficiencyStat">0%</div>
                            <div class="stat-label">åŠ¹ç‡æ€§</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="card">
                <h3>ğŸš€ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h3>
                <p style="margin-bottom: 20px;">ç¶™ç¶šçš„éŸ³å£°èªè­˜ã®å“è³ªã‚’è‡ªå‹•æ¸¬å®šã—ã¾ã™ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹å¾Œã«å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>
                
                <div>
                    <button class="btn" id="checkStatusBtn" onclick="checkSystemStatus()">
                        ğŸ” ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
                    </button>
                    <button class="btn btn-success" id="startTestBtn" onclick="startContinuousTest()" disabled>
                        ğŸ§ª ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆé–‹å§‹
                    </button>
                    <button class="btn btn-warning" id="quickTestBtn" onclick="startQuickTest()" disabled>
                        âš¡ ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆï¼ˆ30ç§’ï¼‰
                    </button>
                    <button class="btn btn-danger" id="stopTestBtn" onclick="stopTest()" disabled>
                        ğŸ›‘ ãƒ†ã‚¹ãƒˆåœæ­¢
                    </button>
                </div>

                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">ãƒ†ã‚¹ãƒˆæº–å‚™ä¸­...</div>
                </div>
            </div>

            <!-- ãƒ†ã‚¹ãƒˆçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="results-section" id="resultsSection" style="display: none;">
                <div class="card">
                    <h3>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ</h3>
                    <div class="result-card" id="resultCard">
                        <div class="stats-grid" id="resultsStats">
                            <!-- çµæœçµ±è¨ˆãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                        </div>
                        <div id="gradeDisplay"></div>
                        <div id="alertsDisplay"></div>
                    </div>
                </div>

                <!-- æ¨å¥¨äº‹é … -->
                <div class="recommendations" id="recommendationsSection" style="display: none;">
                    <h4>ğŸ’¡ æ¨å¥¨äº‹é …</h4>
                    <ul id="recommendationsList">
                        <!-- æ¨å¥¨äº‹é …ãŒå‹•çš„ã«æŒ¿å…¥ã•ã‚Œã‚‹ -->
                    </ul>
                </div>

                <!-- çµæœã‚³ãƒ”ãƒ¼æ©Ÿèƒ½ -->
                <div class="copy-container">
                    <h4>ğŸ“‹ çµæœã‚³ãƒ”ãƒ¼ï¼ˆå ±å‘Šç”¨ï¼‰</h4>
                    <div class="copy-text" id="copyText">
                        ãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
                    </div>
                    <button class="btn btn-copy" onclick="copyResults()">
                        ğŸ“‹ çµæœã‚’ã‚³ãƒ”ãƒ¼
                    </button>
                </div>
            </div>

            <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚° -->
            <div class="card">
                <h3>ğŸ“ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°</h3>
                <div class="log-container" id="logContainer">
                    <div class="log-entry">
                        <span class="log-timestamp">[èµ·å‹•æ™‚åˆ»]</span>
                        ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>æ·±å €ãã‚“v2.0 ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ </p>
            <p>UIãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ»ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã«ã‚ˆã‚Šã€ç°¡å˜æ“ä½œã§è©³ç´°ãªãƒ†ã‚¹ãƒˆçµæœã‚’å–å¾—ã§ãã¾ã™</p>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let currentTest = null;
        let testStartTime = null;
        let progressInterval = null;
        let logUpdateInterval = null;

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
            updateSystemStatus();
            
            // å®šæœŸçš„ã«ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’æ›´æ–°
            setInterval(updateSystemStatus, 5000);
        });

        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª
        function checkSystemStatus() {
            addLog('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ç¢ºèªä¸­...');
            
            try {
                // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®çŠ¶æ…‹ã‚’ç¢ºèª
                const parentWindow = window.parent;
                const sessionActive = parentWindow.AppState?.sessionActive;
                const recognitionManager = parentWindow.stateManager?.recognitionManager;
                
                updateStatusDisplay(sessionActive, recognitionManager);
                
                if (sessionActive && recognitionManager) {
                    addLog('âœ… ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¯èƒ½');
                    enableTestButtons();
                } else {
                    addLog('âŒ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸å¯');
                    if (!sessionActive) {
                        addLog('ğŸ’¡ ã‚»ãƒƒã‚·ãƒ§ãƒ³æœªé–‹å§‹: ãƒ­ã‚°ã‚¤ãƒ³â†’ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠâ†’ãƒ†ãƒ¼ãƒè¨­å®šâ†’ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹');
                    }
                    disableTestButtons();
                }
            } catch (error) {
                addLog('âŒ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼: ' + error.message);
                disableTestButtons();
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹è¡¨ç¤ºæ›´æ–°
        function updateSystemStatus() {
            try {
                const parentWindow = window.parent;
                const sessionActive = parentWindow.AppState?.sessionActive;
                const recognitionManager = parentWindow.stateManager?.recognitionManager;
                
                updateStatusDisplay(sessionActive, recognitionManager);
                updateCurrentStats();
                
                if (sessionActive && recognitionManager) {
                    enableTestButtons();
                } else {
                    disableTestButtons();
                }
            } catch (error) {
                // è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            }
        }

        // çŠ¶æ…‹è¡¨ç¤ºæ›´æ–°
        function updateStatusDisplay(sessionActive, recognitionManager) {
            const sessionStatusEl = document.getElementById('sessionStatus');
            const sessionStatusTextEl = document.getElementById('sessionStatusText');
            const recognitionStatusEl = document.getElementById('recognitionStatus');
            const recognitionStatusTextEl = document.getElementById('recognitionStatusText');
            
            if (sessionActive) {
                sessionStatusEl.className = 'status-dot status-active';
                sessionStatusTextEl.textContent = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ¸ˆã¿';
            } else {
                sessionStatusEl.className = 'status-dot status-inactive';
                sessionStatusTextEl.textContent = 'ã‚»ãƒƒã‚·ãƒ§ãƒ³æœªé–‹å§‹';
            }
            
            if (recognitionManager) {
                recognitionStatusEl.className = 'status-dot status-active';
                recognitionStatusTextEl.textContent = 'éŸ³å£°èªè­˜ã‚·ã‚¹ãƒ†ãƒ å‹•ä½œä¸­';
            } else {
                recognitionStatusEl.className = 'status-dot status-inactive';
                recognitionStatusTextEl.textContent = 'éŸ³å£°èªè­˜æœªåˆæœŸåŒ–';
            }
        }

        // ç¾åœ¨ã®çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateCurrentStats() {
            try {
                const parentWindow = window.parent;
                const recognitionManager = parentWindow.stateManager?.recognitionManager;
                
                if (recognitionManager && recognitionManager.getMicrophonePermissionStats) {
                    const stats = recognitionManager.getMicrophonePermissionStats();
                    document.getElementById('startCountStat').textContent = stats.startCount || 0;
                    document.getElementById('efficiencyStat').textContent = 
                        (stats.efficiency === Infinity ? 'âˆ' : stats.efficiency || 0) + '%';
                }
            } catch (error) {
                // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
            }
        }

        // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®æœ‰åŠ¹åŒ–
        function enableTestButtons() {
            document.getElementById('startTestBtn').disabled = false;
            document.getElementById('quickTestBtn').disabled = false;
        }

        // ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®ç„¡åŠ¹åŒ–
        function disableTestButtons() {
            document.getElementById('startTestBtn').disabled = true;
            document.getElementById('quickTestBtn').disabled = true;
        }

        // ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆé–‹å§‹
        function startContinuousTest() {
            startTest(300000); // 5åˆ†é–“
        }

        // ã‚¯ã‚¤ãƒƒã‚¯ãƒ†ã‚¹ãƒˆé–‹å§‹
        function startQuickTest() {
            startTest(30000); // 30ç§’é–“
        }

        // ãƒ†ã‚¹ãƒˆé–‹å§‹
        function startTest(duration) {
            if (currentTest) {
                addLog('âš ï¸ æ—¢ã«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã§ã™');
                return;
            }

            try {
                const parentWindow = window.parent;
                const sessionActive = parentWindow.AppState?.sessionActive;
                
                if (!sessionActive) {
                    addLog('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    showAlert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ­ã‚°ã‚¤ãƒ³â†’ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠâ†’ãƒ†ãƒ¼ãƒè¨­å®šâ†’ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã®æ‰‹é †ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚', 'warning');
                    return;
                }

                // ãƒ†ã‚¹ãƒˆé–‹å§‹
                const success = parentWindow.continuousRecognitionTester.startAutoTest(duration);
                
                if (success) {
                    currentTest = {
                        startTime: Date.now(),
                        duration: duration
                    };
                    
                    addLog(`ğŸ§ª ãƒ†ã‚¹ãƒˆé–‹å§‹: ${duration/1000}ç§’é–“ã®ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆ`);
                    startProgressMonitoring(duration);
                    
                    // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
                    document.getElementById('startTestBtn').disabled = true;
                    document.getElementById('quickTestBtn').disabled = true;
                    document.getElementById('stopTestBtn').disabled = false;
                    
                    // é€²æ—è¡¨ç¤º
                    document.getElementById('progressContainer').style.display = 'block';
                    
                    // ãƒ†ã‚¹ãƒˆçµ‚äº†ã®ç›£è¦–
                    setTimeout(() => {
                        if (currentTest) {
                            finishTest();
                        }
                    }, duration + 1000);
                } else {
                    addLog('âŒ ãƒ†ã‚¹ãƒˆé–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                addLog('âŒ ãƒ†ã‚¹ãƒˆé–‹å§‹ã‚¨ãƒ©ãƒ¼: ' + error.message);
                showAlert('ãƒ†ã‚¹ãƒˆé–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'danger');
            }
        }

        // ãƒ†ã‚¹ãƒˆåœæ­¢
        function stopTest() {
            if (!currentTest) {
                addLog('âš ï¸ å®Ÿè¡Œä¸­ã®ãƒ†ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            try {
                const parentWindow = window.parent;
                const success = parentWindow.continuousRecognitionTester.stopAutoTest();
                
                if (success) {
                    addLog('ğŸ›‘ ãƒ†ã‚¹ãƒˆã‚’æ‰‹å‹•åœæ­¢ã—ã¾ã—ãŸ');
                    finishTest();
                } else {
                    addLog('âŒ ãƒ†ã‚¹ãƒˆåœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                addLog('âŒ ãƒ†ã‚¹ãƒˆåœæ­¢ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // é€²æ—ç›£è¦–é–‹å§‹
        function startProgressMonitoring(duration) {
            const startTime = Date.now();
            
            progressInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min((elapsed / duration) * 100, 100);
                
                document.getElementById('progressFill').style.width = progress + '%';
                document.getElementById('progressText').textContent = 
                    `ãƒ†ã‚¹ãƒˆé€²è¡Œä¸­: ${Math.floor(elapsed/1000)}ç§’ / ${Math.floor(duration/1000)}ç§’ (${Math.floor(progress)}%)`;
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                }
            }, 1000);
        }

        // ãƒ†ã‚¹ãƒˆçµ‚äº†å‡¦ç†
        function finishTest() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            
            currentTest = null;
            
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹å¾©å…ƒ
            document.getElementById('startTestBtn').disabled = false;
            document.getElementById('quickTestBtn').disabled = false;
            document.getElementById('stopTestBtn').disabled = true;
            
            // é€²æ—ãƒãƒ¼éè¡¨ç¤º
            document.getElementById('progressContainer').style.display = 'none';
            
            // ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º
            setTimeout(() => {
                displayTestResults();
            }, 1000);
            
            addLog('âœ… ãƒ†ã‚¹ãƒˆå®Œäº†');
        }

        // ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º
        function displayTestResults() {
            try {
                const parentWindow = window.parent;
                const recognitionManager = parentWindow.stateManager?.recognitionManager;
                
                if (!recognitionManager) {
                    addLog('âŒ çµæœå–å¾—å¤±æ•—: éŸ³å£°èªè­˜ã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
                    return;
                }
                
                const stats = recognitionManager.getMicrophonePermissionStats();
                const analysis = analyzeResults(stats);
                
                // çµæœè¡¨ç¤º
                showResults(analysis, stats);
                
                // ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
                generateCopyText(analysis, stats);
                
                addLog('ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
                
            } catch (error) {
                addLog('âŒ çµæœè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + error.message);
                showAlert('çµæœè¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'danger');
            }
        }

        // çµæœåˆ†æ
        function analyzeResults(stats) {
            const analysis = {
                grade: 'N/A',
                passed: false,
                issues: [],
                recommendations: []
            };
            
            // åŠ¹ç‡æ€§ãƒã‚§ãƒƒã‚¯
            if (stats.efficiency >= 95) {
                analysis.grade = 'A+ (å„ªç§€)';
                analysis.passed = true;
            } else if (stats.efficiency >= 85) {
                analysis.grade = 'A (è‰¯å¥½)';
                analysis.passed = true;
            } else if (stats.efficiency >= 70) {
                analysis.grade = 'B (æ™®é€š)';
                analysis.passed = true;
            } else if (stats.efficiency >= 50) {
                analysis.grade = 'C (è¦æ”¹å–„)';
                analysis.passed = false;
                analysis.issues.push('åŠ¹ç‡æ€§ãŒä½ã„');
            } else {
                analysis.grade = 'D (å•é¡Œã‚ã‚Š)';
                analysis.passed = false;
                analysis.issues.push('åŠ¹ç‡æ€§ãŒæ¥µã‚ã¦ä½ã„');
            }
            
            // start()å›æ•°ãƒã‚§ãƒƒã‚¯
            if (stats.startCount > 5) {
                analysis.issues.push('start()å‘¼ã³å‡ºã—ãŒå¤šã™ãã‚‹');
            }
            
            // æ¨å¥¨äº‹é …ç”Ÿæˆ
            if (analysis.passed) {
                analysis.recommendations.push('ç¶™ç¶šçš„éŸ³å£°èªè­˜ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™');
                if (stats.efficiency === 100) {
                    analysis.recommendations.push('å®Œç’§ãªåŠ¹ç‡æ€§ã‚’é”æˆã—ã¾ã—ãŸï¼');
                }
            } else {
                if (stats.startCount > 3) {
                    analysis.recommendations.push('start()å‘¼ã³å‡ºã—ãŒå¤šã™ãã¾ã™ - æˆ¦ç•¥è¦‹ç›´ã—ãŒå¿…è¦');
                }
                if (stats.efficiency < 70) {
                    analysis.recommendations.push('åŠ¹ç‡æ€§ãŒä½ã„ã§ã™ - ãƒã‚¤ã‚¯è¨±å¯è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„');
                }
            }
            
            return analysis;
        }

        // çµæœè¡¨ç¤º
        function showResults(analysis, stats) {
            const resultsSection = document.getElementById('resultsSection');
            const resultCard = document.getElementById('resultCard');
            const resultsStats = document.getElementById('resultsStats');
            const gradeDisplay = document.getElementById('gradeDisplay');
            const alertsDisplay = document.getElementById('alertsDisplay');
            
            // çµ±è¨ˆæƒ…å ±è¡¨ç¤º
            resultsStats.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${stats.startCount || 0}</div>
                    <div class="stat-label">start()å‘¼ã³å‡ºã—</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.microphonePermissionRequests || 0}</div>
                    <div class="stat-label">ãƒã‚¤ã‚¯è¨±å¯è¦æ±‚</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.efficiency === Infinity ? 'âˆ' : stats.efficiency || 0}%</div>
                    <div class="stat-label">åŠ¹ç‡æ€§</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${stats.continuousRecognition ? 'âœ…' : 'âŒ'}</div>
                    <div class="stat-label">ç¶™ç¶šçš„éŸ³å£°èªè­˜</div>
                </div>
            `;
            
            // ã‚°ãƒ¬ãƒ¼ãƒ‰è¡¨ç¤º
            const gradeClass = analysis.grade.includes('A') ? 'grade-A' : 
                             analysis.grade.includes('B') ? 'grade-B' : 
                             analysis.grade.includes('C') ? 'grade-C' : 'grade-D';
            
            resultCard.className = `result-card ${gradeClass}`;
            gradeDisplay.innerHTML = `
                <h4>ğŸ¯ å“è³ªã‚°ãƒ¬ãƒ¼ãƒ‰: ${analysis.grade}</h4>
                <p>ãƒ†ã‚¹ãƒˆçµæœ: ${analysis.passed ? 'âœ… åˆæ ¼' : 'âŒ ä¸åˆæ ¼'}</p>
            `;
            
            // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
            if (analysis.issues.length > 0) {
                alertsDisplay.innerHTML = `
                    <div class="alert alert-warning">
                        <h5>âš ï¸ æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ</h5>
                        <ul>
                            ${analysis.issues.map(issue => `<li>${issue}</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else {
                alertsDisplay.innerHTML = `
                    <div class="alert alert-success">
                        <h5>âœ… å•é¡Œãªã—</h5>
                        <p>ç¶™ç¶šçš„éŸ³å£°èªè­˜ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚</p>
                    </div>
                `;
            }
            
            // æ¨å¥¨äº‹é …è¡¨ç¤º
            if (analysis.recommendations.length > 0) {
                const recommendationsSection = document.getElementById('recommendationsSection');
                const recommendationsList = document.getElementById('recommendationsList');
                
                recommendationsList.innerHTML = analysis.recommendations
                    .map(rec => `<li>${rec}</li>`)
                    .join('');
                
                recommendationsSection.style.display = 'block';
            }
            
            resultsSection.style.display = 'block';
        }

        // ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
        function generateCopyText(analysis, stats) {
            const now = new Date();
            const timestamp = now.toLocaleString('ja-JP');
            
            const copyText = `
æ·±å €ãã‚“v2.0 ç¶™ç¶šçš„éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆçµæœ
=====================================

å®Ÿè¡Œæ™‚åˆ»: ${timestamp}
ãƒ†ã‚¹ãƒˆç¨®åˆ¥: ç¶™ç¶šçš„éŸ³å£°èªè­˜å“è³ªãƒ†ã‚¹ãƒˆ

ğŸ“Š çµ±è¨ˆæƒ…å ±:
- start()å‘¼ã³å‡ºã—: ${stats.startCount || 0}å›
- ãƒã‚¤ã‚¯è¨±å¯è¦æ±‚: ${stats.microphonePermissionRequests || 0}å›
- åŠ¹ç‡æ€§: ${stats.efficiency === Infinity ? 'âˆ' : stats.efficiency || 0}%
- ç¶™ç¶šçš„éŸ³å£°èªè­˜: ${stats.continuousRecognition ? 'å‹•ä½œä¸­' : 'åœæ­¢ä¸­'}
- æˆ¦ç•¥: ${stats.strategy || 'unknown'}

ğŸ¯ è©•ä¾¡çµæœ:
- å“è³ªã‚°ãƒ¬ãƒ¼ãƒ‰: ${analysis.grade}
- ãƒ†ã‚¹ãƒˆçµæœ: ${analysis.passed ? 'åˆæ ¼' : 'ä¸åˆæ ¼'}

${analysis.issues.length > 0 ? `
âš ï¸ æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ:
${analysis.issues.map(issue => `- ${issue}`).join('\n')}
` : 'âœ… å•é¡Œãªã—: ç¶™ç¶šçš„éŸ³å£°èªè­˜ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚'}

${analysis.recommendations.length > 0 ? `
ğŸ’¡ æ¨å¥¨äº‹é …:
${analysis.recommendations.map(rec => `- ${rec}`).join('\n')}
` : ''}

=====================================
æ·±å €ãã‚“v2.0 UIãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ 
ãƒ†ã‚¹ãƒˆè² è·è»½æ¸›ãƒ»è‡ªå‹•å“è³ªç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 
            `.trim();
            
            document.getElementById('copyText').textContent = copyText;
        }

        // çµæœã‚³ãƒ”ãƒ¼
        function copyResults() {
            const copyText = document.getElementById('copyText').textContent;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(copyText).then(() => {
                    addLog('ğŸ“‹ çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    showAlert('ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
                }).catch(err => {
                    addLog('âŒ ã‚³ãƒ”ãƒ¼å¤±æ•—: ' + err.message);
                    showAlert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
                });
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const textArea = document.createElement('textarea');
                textArea.value = copyText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                addLog('ğŸ“‹ çµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                showAlert('ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 'success');
            }
        }

        // ãƒ­ã‚°è¿½åŠ 
        function addLog(message) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString('ja-JP');
            const logContainer = document.getElementById('logContainer');
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                ${message}
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
            
            // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html> 